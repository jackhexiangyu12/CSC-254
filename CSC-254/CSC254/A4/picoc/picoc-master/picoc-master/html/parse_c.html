<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/></head>
<body><pre><a name="1"><font color="gray">/*<searched> picoc parser - parses source and executes statements */</font></a>
<a name="2"></a>
<a name="3">#include "picoc.h"</a>
<a name="4">#include "interpreter.h"</a>
<a name="5"></a>
<a name="6"><font color="gray">/*<searched> deallocate any memory */</font></a>
<a name="7"><font color="red">void</font> <a name="searched">ParseCleanup</a>(Picoc *<a name="searched">pc</a>)</a>
<a name="8">{</a>
<a name="9">    <font color="green">while</font> (pc-&gtCleanupTokenList != NULL)</a>
<a name="10">    {</a>
<a name="11">        <font color="brown">struct</font> CleanupTokenNode *<a name="searched">Next</a> = <a href="parse_c.html#7">pc</a>-&gtCleanupTokenList-&gt<a name="searched">Next</a>;</a>
<a name="12">        </a>
<a name="13">        <a href="heap_c.html#226">HeapFreeMem</a>(pc, <a href="parse_c.html#7">pc</a>-&gtCleanupTokenList-&gtTokens);</a>
<a name="14">        <font color="green">if</font> (pc-&gtCleanupTokenList-&gtSourceText != NULL)</a>
<a name="15">            <a href="heap_c.html#226">HeapFreeMem</a>(pc, (<font color="red">void</font> *)pc-&gtCleanupTokenList-&gtSourceText);</a>
<a name="16">            </a>
<a name="17">        <a href="heap_c.html#226">HeapFreeMem</a>(pc, <a href="parse_c.html#7">pc</a>-&gtCleanupTokenList);</a>
<a name="18">        <a href="parse_c.html#7">pc</a>-&gtCleanupTokenList = <a href="parse_c.html#11">Next</a>;</a>
<a name="19">    }</a>
<a name="20">}</a>
<a name="21"></a>
<a name="22"><font color="gray">/*<searched> parse a statement, but only run it if Condition is TRUE */</font></a>
<a name="23"><font color="red">enum</font> ParseResult <a name="searched">ParseStatementMaybeRun</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>, <font color="red">int</font> <a name="searched">Condition</a>, <font color="red">int</font> <a name="searched">CheckTrailingSemicolon</a>)</a>
<a name="24">{</a>
<a name="25">    <font color="green">if</font> (Parser-&gtMode != RunModeSkip && !<a href="parse_c.html#23">Condition</a>)</a>
<a name="26">    {</a>
<a name="27">        <font color="red">enum</font> RunMode <a name="searched">OldMode</a> = <a href="parse_c.html#23">Parser</a>-&gtMode;</a>
<a name="28">        <font color="red">int</font> <a name="searched">Result</a>;</a>
<a name="29">        <a href="parse_c.html#23">Parser</a>-&gtMode = RunModeSkip;</a>
<a name="30">        <a href="parse_c.html#28">Result</a> = <a href="parse_c.html#568">ParseStatement</a>(Parser, <a href="parse_c.html#23">CheckTrailingSemicolon</a>);</a>
<a name="31">        <a href="parse_c.html#23">Parser</a>-&gtMode = <a href="parse_c.html#27">OldMode</a>;</a>
<a name="32">        <font color="green">return</font> <a href="parse_c.html#28">Result</a>;</a>
<a name="33">    }</a>
<a name="34">    <font color="green">else</font></a>
<a name="35">        <font color="green">return</font> <a href="parse_c.html#568">ParseStatement</a>(Parser, <a href="parse_c.html#23">CheckTrailingSemicolon</a>);</a>
<a name="36">}</a>
<a name="37"></a>
<a name="38"><font color="gray">/*<searched> count the number of parameters to a function or macro */</font></a>
<a name="39"><font color="red">int</font> <a name="searched">ParseCountParams</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>)</a>
<a name="40">{</a>
<a name="41">    <font color="red">int</font> <a name="searched">ParamCount</a> = 0;</a>
<a name="42">    </a>
<a name="43">    <font color="red">enum</font> Lex<a name="searched">Token</a> <a name="searched">Token</a> = LexGet<a name="searched">Token</a>(Parser, NULL, TRUE);</a>
<a name="44">    <font color="green">if</font> (Token != TokenCloseBracket && <a href="parse_c.html#43">Token</a> != TokenEOF)</a>
<a name="45">    { </a>
<a name="46">        <font color="gray">/*<searched> count the number of parameters */</font></a>
<a name="47">        <a href="parse_c.html#41">ParamCount</a>++;</a>
<a name="48">        <font color="green">while</font> ((Token = <a href="lex_c.html#883">LexGetToken</a>(Parser, NULL, TRUE)) != TokenCloseBracket && <a href="parse_c.html#43">Token</a> != TokenEOF)</a>
<a name="49">        { </a>
<a name="50">            <font color="green">if</font> (Token == TokenComma)</a>
<a name="51">                <a href="parse_c.html#41">ParamCount</a>++;</a>
<a name="52">        } </a>
<a name="53">    }</a>
<a name="54">    </a>
<a name="55">    <font color="green">return</font> <a href="parse_c.html#41">ParamCount</a>;</a>
<a name="56">}</a>
<a name="57"></a>
<a name="58"><font color="gray">/*<searched> parse a function definition and store it for later */</font></a>
<a name="59"><font color="brown">struct</font> Value *<a name="searched">ParseFunctionDefinition</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>, <font color="brown">struct</font> ValueType *<a name="searched">ReturnType</a>, <font color="red">char</font> *<a name="searched">Identifier</a>)</a>
<a name="60">{</a>
<a name="61">    <font color="brown">struct</font> ValueType *<a name="searched">ParamType</a>;</a>
<a name="62">    <font color="red">char</font> *<a name="searched">ParamIdentifier</a>;</a>
<a name="63">    <font color="red">enum</font> Lex<a name="searched">Token</a> <a name="searched">Token</a> = <a name="searched">Token</a>None;</a>
<a name="64">    <font color="brown">struct</font> ParseState <a name="searched">ParamParser</a>;</a>
<a name="65">    <font color="brown">struct</font> Value *<a name="searched">FuncValue</a>;</a>
<a name="66">    <font color="brown">struct</font> Value *<a name="searched">OldFuncValue</a>;</a>
<a name="67">    <font color="brown">struct</font> ParseState <a name="searched">FuncBody</a>;</a>
<a name="68">    <font color="red">int</font> <a name="searched">ParamCount</a> = 0;</a>
<a name="69">    Picoc *<a name="searched">pc</a> = <a href="parse_c.html#59">Parser</a>-&gt<a name="searched">pc</a>;</a>
<a name="70"></a>
<a name="71">    <font color="green">if</font> (pc-&gtTopStackFrame != NULL)</a>
<a name="72">        <a href="platform_c.html#134">ProgramFail</a>(Parser, "nested function definitions are not allowed");</a>
<a name="73">        </a>
<a name="74">    LexGetToken(Parser, NULL, TRUE);  <font color="gray">/*<searched> open bracket */</font></a>
<a name="75">    <a href="parse_c.html#429">ParserCopy</a>(&<a href="parse_c.html#64">ParamParser</a>, <a href="parse_c.html#59">Parser</a>);</a>
<a name="76">    <a href="parse_c.html#68">ParamCount</a> = <a href="parse_c.html#39">ParseCountParams</a>(Parser);</a>
<a name="77">    <font color="green">if</font> (ParamCount &gt PARAMETER_MAX)</a>
<a name="78">        <a href="platform_c.html#134">ProgramFail</a>(Parser, "too many parameters (%d allowed)", PARAMETER_MAX);</a>
<a name="79">    </a>
<a name="80">    <a href="parse_c.html#65">FuncValue</a> = <a href="variable_c.html#89">VariableAllocValueAndData</a>(pc, <a href="parse_c.html#59">Parser</a>, sizeof(<font color="brown">struct</font> FuncDef) + sizeof(<font color="brown">struct</font> ValueType *) * <a href="parse_c.html#68">ParamCount</a> + sizeof(const <font color="red">char</font> *) * <a href="parse_c.html#68">ParamCount</a>, FALSE, NULL, TRUE);</a>
<a name="81">    <a href="parse_c.html#65">FuncValue</a>-&gtTyp = &<a href="parse_c.html#69">pc</a>-&gtFunctionType;</a>
<a name="82">    <a href="parse_c.html#65">FuncValue</a>-&gtVal-&gtFuncDef.ReturnType = <a href="parse_c.html#59">ReturnType</a>;</a>
<a name="83">    <a href="parse_c.html#65">FuncValue</a>-&gtVal-&gtFuncDef.NumParams = <a href="parse_c.html#68">ParamCount</a>;</a>
<a name="84">    <a href="parse_c.html#65">FuncValue</a>-&gtVal-&gtFuncDef.VarArgs = FALSE;</a>
<a name="85">    <a href="parse_c.html#65">FuncValue</a>-&gtVal-&gtFuncDef.ParamType = (<font color="brown">struct</font> ValueType **)((<font color="red">char</font> *)FuncValue-&gtVal + sizeof(<font color="brown">struct</font> FuncDef));</a>
<a name="86">    <a href="parse_c.html#65">FuncValue</a>-&gtVal-&gtFuncDef.ParamName = (<font color="red">char</font> **)((<font color="red">char</font> *)FuncValue-&gtVal-&gtFuncDef.ParamType + sizeof(<font color="brown">struct</font> ValueType *) * <a href="parse_c.html#68">ParamCount</a>);</a>
<a name="87">   </a>
<a name="88">    <font color="green">for</font> (ParamCount = 0; <a href="parse_c.html#68">ParamCount</a> &lt <a href="parse_c.html#65">FuncValue</a>-&gtVal-&gtFuncDef.NumParams; <a href="parse_c.html#68">ParamCount</a>++)</a>
<a name="89">    { </a>
<a name="90">        <font color="gray">/*<searched> harvest the parameters into the function definition */</font></a>
<a name="91">        <font color="green">if</font> (ParamCount == <a href="parse_c.html#65">FuncValue</a>-&gtVal-&gtFuncDef.NumParams-1 && <a href="lex_c.html#883">LexGetToken</a>(&<a href="parse_c.html#64">ParamParser</a>, NULL, FALSE) == TokenEllipsis)</a>
<a name="92">        { </a>
<a name="93">            <font color="gray">/*<searched> ellipsis at end */</font></a>
<a name="94">            <a href="parse_c.html#65">FuncValue</a>-&gtVal-&gtFuncDef.NumParams--;</a>
<a name="95">            <a href="parse_c.html#65">FuncValue</a>-&gtVal-&gtFuncDef.VarArgs = TRUE;</a>
<a name="96">            break;</a>
<a name="97">        }</a>
<a name="98">        <font color="green">else</font></a>
<a name="99">        { </a>
<a name="100">            <font color="gray">/*<searched> add a parameter */</font></a>
<a name="101">            <a href="type_c.html#526">TypeParse</a>(&<a href="parse_c.html#64">ParamParser</a>, &<a href="parse_c.html#61">ParamType</a>, &<a href="parse_c.html#62">ParamIdentifier</a>, NULL);</a>
<a name="102">            <font color="green">if</font> (ParamType-&gtBase == TypeVoid)</a>
<a name="103">            {</a>
<a name="104">                <font color="gray">/*<searched> this isn't a real parameter at all - delete it */</font></a>
<a name="105">                <a href="parse_c.html#68">ParamCount</a>--;</a>
<a name="106">                <a href="parse_c.html#65">FuncValue</a>-&gtVal-&gtFuncDef.NumParams--;</a>
<a name="107">            }</a>
<a name="108">            <font color="green">else</font></a>
<a name="109">            {</a>
<a name="110">                <a href="parse_c.html#65">FuncValue</a>-&gtVal-&gtFuncDef.ParamType[<a href="parse_c.html#68">ParamCount</a>] = <a href="parse_c.html#61">ParamType</a>;</a>
<a name="111">                <a href="parse_c.html#65">FuncValue</a>-&gtVal-&gtFuncDef.ParamName[<a href="parse_c.html#68">ParamCount</a>] = <a href="parse_c.html#62">ParamIdentifier</a>;</a>
<a name="112">            }</a>
<a name="113">        }</a>
<a name="114">        </a>
<a name="115">        <a href="parse_c.html#63">Token</a> = <a href="lex_c.html#883">LexGetToken</a>(&<a href="parse_c.html#64">ParamParser</a>, NULL, TRUE);</a>
<a name="116">        <font color="green">if</font> (Token != TokenComma && <a href="parse_c.html#68">ParamCount</a> &lt <a href="parse_c.html#65">FuncValue</a>-&gtVal-&gtFuncDef.NumParams-1)</a>
<a name="117">            <a href="platform_c.html#134">ProgramFail</a>(&<a href="parse_c.html#64">ParamParser</a>, "comma expected");</a>
<a name="118">    }</a>
<a name="119">    </a>
<a name="120">    <font color="green">if</font> (FuncValue-&gtVal-&gtFuncDef.NumParams != 0 && <a href="parse_c.html#63">Token</a> != TokenCloseBracket && <a href="parse_c.html#63">Token</a> != TokenComma && <a href="parse_c.html#63">Token</a> != TokenEllipsis)</a>
<a name="121">        <a href="platform_c.html#134">ProgramFail</a>(&<a href="parse_c.html#64">ParamParser</a>, "bad parameter");</a>
<a name="122">    </a>
<a name="123">    <font color="green">if</font> (strcmp(Identifier, "<a href="picoc_c.html#16">main</a>") == 0)</a>
<a name="124">    {</a>
<a name="125">        <font color="gray">/*<searched> make sure it's int main() */</font></a>
<a name="126">        <font color="green">if</font> ( <a href="parse_c.html#65">FuncValue</a>-&gtVal-&gtFuncDef.ReturnType != &<a href="parse_c.html#69">pc</a>-&gtIntType &&</a>
<a name="127">             <a href="parse_c.html#65">FuncValue</a>-&gtVal-&gtFuncDef.ReturnType != &<a href="parse_c.html#69">pc</a>-&gtVoidType )</a>
<a name="128">            <a href="platform_c.html#134">ProgramFail</a>(Parser, "<a href="picoc_c.html#16">main</a>() should <font color="green">return</font> an <font color="red">int</font> or <font color="red">void</font>");</a>
<a name="129"></a>
<a name="130">        <font color="green">if</font> (FuncValue-&gtVal-&gtFuncDef.NumParams != 0 &&</a>
<a name="131">             (FuncValue-&gtVal-&gtFuncDef.NumParams != 2 || <a href="parse_c.html#65">FuncValue</a>-&gtVal-&gtFuncDef.ParamType[0] != &<a href="parse_c.html#69">pc</a>-&gtIntType) )</a>
<a name="132">            <a href="platform_c.html#134">ProgramFail</a>(Parser, "bad parameters to <a href="picoc_c.html#16">main</a>()");</a>
<a name="133">    }</a>
<a name="134">    </a>
<a name="135">    <font color="gray">/*<searched> look for a function body */</font></a>
<a name="136">    <a href="parse_c.html#63">Token</a> = <a href="lex_c.html#883">LexGetToken</a>(Parser, NULL, FALSE);</a>
<a name="137">    <font color="green">if</font> (Token == TokenSemicolon)</a>
<a name="138">        LexGetToken(Parser, NULL, TRUE);    <font color="gray">/*<searched> it's a prototype, absorb the trailing semicolon */</font></a>
<a name="139">    <font color="green">else</font></a>
<a name="140">    {</a>
<a name="141">        <font color="gray">/*<searched> it's a full function definition with a body */</font></a>
<a name="142">        <font color="green">if</font> (Token != TokenLeftBrace)</a>
<a name="143">            <a href="platform_c.html#134">ProgramFail</a>(Parser, "bad function definition");</a>
<a name="144">        </a>
<a name="145">        <a href="parse_c.html#429">ParserCopy</a>(&<a href="parse_c.html#67">FuncBody</a>, <a href="parse_c.html#59">Parser</a>);</a>
<a name="146">        <font color="green">if</font> (ParseStatementMaybeRun(Parser, FALSE, TRUE) != ParseResultOk)</a>
<a name="147">            <a href="platform_c.html#134">ProgramFail</a>(Parser, "function definition expected");</a>
<a name="148"></a>
<a name="149">        <a href="parse_c.html#65">FuncValue</a>-&gtVal-&gtFuncDef.Body = <a href="parse_c.html#67">FuncBody</a>;</a>
<a name="150">        <a href="parse_c.html#65">FuncValue</a>-&gtVal-&gtFuncDef.Body.Pos = <a href="lex_c.html#934">LexCopyTokens</a>(&<a href="parse_c.html#67">FuncBody</a>, <a href="parse_c.html#59">Parser</a>);</a>
<a name="151"></a>
<a name="152">        <font color="gray">/*<searched> is this function already in the global table? */</font></a>
<a name="153">        <font color="green">if</font> (TableGet(&<a href="parse_c.html#69">pc</a>-&gtGlobalTable, <a href="parse_c.html#59">Identifier</a>, &<a href="parse_c.html#66">OldFuncValue</a>, NULL, NULL, NULL))</a>
<a name="154">        {</a>
<a name="155">            <font color="green">if</font> (OldFuncValue-&gtVal-&gtFuncDef.Body.Pos == NULL)</a>
<a name="156">            {</a>
<a name="157">                <font color="gray">/*<searched> override an old function prototype */</font></a>
<a name="158">                <a href="variable_c.html#19">VariableFree</a>(pc, <a href="table_c.html#101">TableDelete</a>(pc, &<a href="parse_c.html#69">pc</a>-&gtGlobalTable, <a href="parse_c.html#59">Identifier</a>));</a>
<a name="159">            }</a>
<a name="160">            <font color="green">else</font></a>
<a name="161">                <a href="platform_c.html#134">ProgramFail</a>(Parser, "'%s' is already defined", <a href="parse_c.html#59">Identifier</a>);</a>
<a name="162">        }</a>
<a name="163">    }</a>
<a name="164"></a>
<a name="165">    <font color="green">if</font> (!<a href="table_c.html#58">TableSet</a>(pc, &<a href="parse_c.html#69">pc</a>-&gtGlobalTable, <a href="parse_c.html#59">Identifier</a>, <a href="parse_c.html#65">FuncValue</a>, (<font color="red">char</font> *)Parser-&gtFileName, <a href="parse_c.html#59">Parser</a>-&gtLine, <a href="parse_c.html#59">Parser</a>-&gtCharacterPos))</a>
<a name="166">        <a href="platform_c.html#134">ProgramFail</a>(Parser, "'%s' is already defined", <a href="parse_c.html#59">Identifier</a>);</a>
<a name="167">        </a>
<a name="168">    <font color="green">return</font> <a href="parse_c.html#65">FuncValue</a>;</a>
<a name="169">}</a>
<a name="170"></a>
<a name="171"><font color="gray">/*<searched> parse an array initialiser and assign to a variable */</font></a>
<a name="172"><font color="red">int</font> <a name="searched">ParseArrayInitialiser</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>, <font color="brown">struct</font> Value *<a name="searched">NewVariable</a>, <font color="red">int</font> <a name="searched">DoAssignment</a>)</a>
<a name="173">{</a>
<a name="174">    <font color="red">int</font> <a name="searched">ArrayIndex</a> = 0;</a>
<a name="175">    <font color="red">enum</font> Lex<a name="searched">Token</a> <a name="searched">Token</a>;</a>
<a name="176">    <font color="brown">struct</font> Value *<a name="searched">CValue</a>;</a>
<a name="177">    </a>
<a name="178">    <font color="gray">/*<searched> count the number of elements in the array */</font></a>
<a name="179">    <font color="green">if</font> (DoAssignment && <a href="parse_c.html#172">Parser</a>-&gtMode == RunModeRun)</a>
<a name="180">    {</a>
<a name="181">        <font color="brown">struct</font> ParseState <a name="searched">CountParser</a>;</a>
<a name="182">        <font color="red">int</font> <a name="searched">NumElements</a>;</a>
<a name="183">        </a>
<a name="184">        <a href="parse_c.html#429">ParserCopy</a>(&<a href="parse_c.html#181">CountParser</a>, <a href="parse_c.html#172">Parser</a>);</a>
<a name="185">        <a href="parse_c.html#182">NumElements</a> = <a href="parse_c.html#172">ParseArrayInitialiser</a>(&<a href="parse_c.html#181">CountParser</a>, <a href="parse_c.html#172">NewVariable</a>, FALSE);</a>
<a name="186"></a>
<a name="187">        <font color="green">if</font> (NewVariable-&gtTyp-&gtBase != TypeArray)</a>
<a name="188">            <a href="platform_c.html#159">AssignFail</a>(Parser, "%t from array initializer", <a href="parse_c.html#172">NewVariable</a>-&gtTyp, NULL, 0, 0, NULL, 0);</a>
<a name="189"></a>
<a name="190">        <font color="green">if</font> (NewVariable-&gtTyp-&gtArraySize == 0)</a>
<a name="191">        {</a>
<a name="192">            <a href="parse_c.html#172">NewVariable</a>-&gtTyp = <a href="type_c.html#32">TypeGetMatching</a>(Parser-&gtpc, <a href="parse_c.html#172">Parser</a>, <a href="parse_c.html#172">NewVariable</a>-&gtTyp-&gtFromType, <a href="parse_c.html#172">NewVariable</a>-&gtTyp-&gtBase, <a href="parse_c.html#182">NumElements</a>, <a href="parse_c.html#172">NewVariable</a>-&gtTyp-&gtIdentifier, TRUE);</a>
<a name="193">            <a href="variable_c.html#156">VariableRealloc</a>(Parser, <a href="parse_c.html#172">NewVariable</a>, <a href="type_c.html#69">TypeSizeValue</a>(NewVariable, FALSE));</a>
<a name="194">        }</a>
<a name="195">        #ifdef DEBUG_ARRAY_INITIALIZER</a>
<a name="196">        PRINT_SOURCE_POS;</a>
<a name="197">        printf("array size: %d \n", <a href="parse_c.html#172">NewVariable</a>-&gtTyp-&gtArraySize);</a>
<a name="198">        #endif</a>
<a name="199">    }</a>
<a name="200">    </a>
<a name="201">    <font color="gray">/*<searched> parse the array initialiser */</font></a>
<a name="202">    <a href="parse_c.html#175">Token</a> = <a href="lex_c.html#883">LexGetToken</a>(Parser, NULL, FALSE);</a>
<a name="203">    <font color="green">while</font> (Token != TokenRightBrace)</a>
<a name="204">    {</a>
<a name="205">        <font color="green">if</font> (LexGetToken(Parser, NULL, FALSE) == TokenLeftBrace)</a>
<a name="206">        {</a>
<a name="207">            <font color="gray">/*<searched> this is a sub-array initialiser */</font></a>
<a name="208">            <font color="red">int</font> <a name="searched">SubArraySize</a> = 0;</a>
<a name="209">            <font color="brown">struct</font> Value *<a name="searched">SubArray</a> = <a href="parse_c.html#172">NewVariable</a>; </a>
<a name="210">            <font color="green">if</font> (Parser-&gtMode == RunModeRun && <a href="parse_c.html#172">DoAssignment</a>)</a>
<a name="211">            {</a>
<a name="212">                <a href="parse_c.html#208">SubArraySize</a> = <a href="type_c.html#80">TypeSize</a>(NewVariable-&gtTyp-&gtFromType, <a href="parse_c.html#172">NewVariable</a>-&gtTyp-&gtFromType-&gtArraySize, TRUE);</a>
<a name="213">                <a href="parse_c.html#209">SubArray</a> = <a href="variable_c.html#135">VariableAllocValueFromExistingData</a>(Parser, <a href="parse_c.html#172">NewVariable</a>-&gtTyp-&gtFromType, (union AnyValue *)(&<a href="parse_c.html#172">NewVariable</a>-&gtVal-&gtArrayMem[0] + <a href="parse_c.html#208">SubArraySize</a> * <a href="parse_c.html#174">ArrayIndex</a>), TRUE, <a href="parse_c.html#172">NewVariable</a>);</a>
<a name="214">                #ifdef DEBUG_ARRAY_INITIALIZER</a>
<a name="215">                <font color="red">int</font> FullArraySize = <a href="type_c.html#80">TypeSize</a>(NewVariable-&gtTyp, <a href="parse_c.html#172">NewVariable</a>-&gtTyp-&gtArraySize, TRUE);</a>
<a name="216">                PRINT_SOURCE_POS;</a>
<a name="217">                PRINT_TYPE(NewVariable-&gtTyp)</a>
<a name="218">                printf("[%d] subarray size: %d (full: %d,%d) \n", <a href="parse_c.html#174">ArrayIndex</a>, <a href="parse_c.html#208">SubArraySize</a>, FullArraySize, <a href="parse_c.html#172">NewVariable</a>-&gtTyp-&gtArraySize);</a>
<a name="219">                #endif</a>
<a name="220">                <font color="green">if</font> (ArrayIndex &gt= <a href="parse_c.html#172">NewVariable</a>-&gtTyp-&gtArraySize)</a>
<a name="221">                    <a href="platform_c.html#134">ProgramFail</a>(Parser, "too many array elements");</a>
<a name="222">            }</a>
<a name="223">            <a href="lex_c.html#883">LexGetToken</a>(Parser, NULL, TRUE);</a>
<a name="224">            <a href="parse_c.html#172">ParseArrayInitialiser</a>(Parser, <a href="parse_c.html#209">SubArray</a>, <a href="parse_c.html#172">DoAssignment</a>);</a>
<a name="225">        }</a>
<a name="226">        <font color="green">else</font></a>
<a name="227">        {</a>
<a name="228">            <font color="brown">struct</font> Value *<a name="searched">ArrayElement</a> = NULL;</a>
<a name="229">        </a>
<a name="230">            <font color="green">if</font> (Parser-&gtMode == RunModeRun && <a href="parse_c.html#172">DoAssignment</a>)</a>
<a name="231">            {</a>
<a name="232">                <font color="brown">struct</font> ValueType * <a name="searched">ElementType</a> = <a href="parse_c.html#172">NewVariable</a>-&gtTyp;</a>
<a name="233">                <font color="red">int</font> <a name="searched">TotalSize</a> = 1;</a>
<a name="234">                <font color="red">int</font> <a name="searched">ElementSize</a> = 0;</a>
<a name="235">                </a>
<a name="236">                <font color="gray">/*<searched> int x[3][3] = {1,2,3,4} =&gt handle it just like int x[9] = {1,2,3,4} */</font></a>
<a name="237">                <font color="green">while</font> (ElementType-&gtBase == TypeArray)</a>
<a name="238">                {</a>
<a name="239">                    <a href="parse_c.html#233">TotalSize</a> *= <a href="parse_c.html#232">ElementType</a>-&gtArraySize;</a>
<a name="240">                    <a href="parse_c.html#232">ElementType</a> = <a href="parse_c.html#232">ElementType</a>-&gtFromType;</a>
<a name="241">                    </a>
<a name="242">                    <font color="gray">/*<searched> char x[10][10] = {"abc", "def"} =&gt assign "abc" to x[0], "def" to x[1] etc */</font></a>
<a name="243">                    <font color="green">if</font> (LexGetToken(Parser, NULL, FALSE) == TokenStringConstant && <a href="parse_c.html#232">ElementType</a>-&gtFromType-&gtBase == TypeChar)</a>
<a name="244">                        break;</a>
<a name="245">                }</a>
<a name="246">                <a href="parse_c.html#234">ElementSize</a> = <a href="type_c.html#80">TypeSize</a>(ElementType, <a href="parse_c.html#232">ElementType</a>-&gtArraySize, TRUE);</a>
<a name="247">                #ifdef DEBUG_ARRAY_INITIALIZER</a>
<a name="248">                PRINT_SOURCE_POS;</a>
<a name="249">                printf("[%d/%d] element size: %d (x%d) \n", <a href="parse_c.html#174">ArrayIndex</a>, <a href="parse_c.html#233">TotalSize</a>, <a href="parse_c.html#234">ElementSize</a>, <a href="parse_c.html#232">ElementType</a>-&gtArraySize);</a>
<a name="250">                #endif</a>
<a name="251">                <font color="green">if</font> (ArrayIndex &gt= <a href="parse_c.html#233">TotalSize</a>)</a>
<a name="252">                    <a href="platform_c.html#134">ProgramFail</a>(Parser, "too many array elements");</a>
<a name="253">                <a href="parse_c.html#228">ArrayElement</a> = <a href="variable_c.html#135">VariableAllocValueFromExistingData</a>(Parser, <a href="parse_c.html#232">ElementType</a>, (union AnyValue *)(&<a href="parse_c.html#172">NewVariable</a>-&gtVal-&gtArrayMem[0] + <a href="parse_c.html#234">ElementSize</a> * <a href="parse_c.html#174">ArrayIndex</a>), TRUE, <a href="parse_c.html#172">NewVariable</a>);</a>
<a name="254">            }</a>
<a name="255"></a>
<a name="256">            <font color="gray">/*<searched> this is a normal expression initialiser */</font></a>
<a name="257">            <font color="green">if</font> (!<a href="expression_c.html#1077">ExpressionParse</a>(Parser, &<a href="parse_c.html#176">CValue</a>))</a>
<a name="258">                <a href="platform_c.html#134">ProgramFail</a>(Parser, "expression expected");</a>
<a name="259"></a>
<a name="260">            <font color="green">if</font> (Parser-&gtMode == RunModeRun && <a href="parse_c.html#172">DoAssignment</a>)</a>
<a name="261">            {</a>
<a name="262">                <a href="expression_c.html#391">ExpressionAssign</a>(Parser, <a href="parse_c.html#228">ArrayElement</a>, <a href="parse_c.html#176">CValue</a>, FALSE, NULL, 0, FALSE);</a>
<a name="263">                <a href="variable_c.html#386">VariableStackPop</a>(Parser, <a href="parse_c.html#176">CValue</a>);</a>
<a name="264">                <a href="variable_c.html#386">VariableStackPop</a>(Parser, <a href="parse_c.html#228">ArrayElement</a>);</a>
<a name="265">            }</a>
<a name="266">        }</a>
<a name="267">        </a>
<a name="268">        <a href="parse_c.html#174">ArrayIndex</a>++;</a>
<a name="269"></a>
<a name="270">        <a href="parse_c.html#175">Token</a> = <a href="lex_c.html#883">LexGetToken</a>(Parser, NULL, FALSE);</a>
<a name="271">        <font color="green">if</font> (Token == TokenComma)</a>
<a name="272">        {</a>
<a name="273">            <a href="lex_c.html#883">LexGetToken</a>(Parser, NULL, TRUE);</a>
<a name="274">            <a href="parse_c.html#175">Token</a> = <a href="lex_c.html#883">LexGetToken</a>(Parser, NULL, FALSE);</a>
<a name="275">        }   </a>
<a name="276">        <font color="green">else</font> <font color="green">if</font> (Token != TokenRightBrace)</a>
<a name="277">            <a href="platform_c.html#134">ProgramFail</a>(Parser, "comma expected");</a>
<a name="278">    }</a>
<a name="279">    </a>
<a name="280">    <font color="green">if</font> (Token == TokenRightBrace)</a>
<a name="281">        <a href="lex_c.html#883">LexGetToken</a>(Parser, NULL, TRUE);</a>
<a name="282">    <font color="green">else</font></a>
<a name="283">        <a href="platform_c.html#134">ProgramFail</a>(Parser, "'}' expected");</a>
<a name="284">    </a>
<a name="285">    <font color="green">return</font> <a href="parse_c.html#174">ArrayIndex</a>;</a>
<a name="286">}</a>
<a name="287"></a>
<a name="288"><font color="gray">/*<searched> assign an initial value to a variable */</font></a>
<a name="289"><font color="red">void</font> <a name="searched">ParseDeclarationAssignment</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>, <font color="brown">struct</font> Value *<a name="searched">NewVariable</a>, <font color="red">int</font> <a name="searched">DoAssignment</a>)</a>
<a name="290">{</a>
<a name="291">    <font color="brown">struct</font> Value *<a name="searched">CValue</a>;</a>
<a name="292"></a>
<a name="293">    <font color="green">if</font> (LexGetToken(Parser, NULL, FALSE) == TokenLeftBrace)</a>
<a name="294">    {</a>
<a name="295">        <font color="gray">/*<searched> this is an array initialiser */</font></a>
<a name="296">        <a href="lex_c.html#883">LexGetToken</a>(Parser, NULL, TRUE);</a>
<a name="297">        <a href="parse_c.html#172">ParseArrayInitialiser</a>(Parser, <a href="parse_c.html#289">NewVariable</a>, <a href="parse_c.html#289">DoAssignment</a>);</a>
<a name="298">    }</a>
<a name="299">    <font color="green">else</font></a>
<a name="300">    {</a>
<a name="301">        <font color="gray">/*<searched> this is a normal expression initialiser */</font></a>
<a name="302">        <font color="green">if</font> (!<a href="expression_c.html#1077">ExpressionParse</a>(Parser, &<a href="parse_c.html#291">CValue</a>))</a>
<a name="303">            <a href="platform_c.html#134">ProgramFail</a>(Parser, "expression expected");</a>
<a name="304">            </a>
<a name="305">        <font color="green">if</font> (Parser-&gtMode == RunModeRun && <a href="parse_c.html#289">DoAssignment</a>)</a>
<a name="306">        {</a>
<a name="307">            <a href="expression_c.html#391">ExpressionAssign</a>(Parser, <a href="parse_c.html#289">NewVariable</a>, <a href="parse_c.html#291">CValue</a>, FALSE, NULL, 0, FALSE);</a>
<a name="308">            <a href="variable_c.html#386">VariableStackPop</a>(Parser, <a href="parse_c.html#291">CValue</a>);</a>
<a name="309">        }</a>
<a name="310">    }</a>
<a name="311">}</a>
<a name="312"></a>
<a name="313"><font color="gray">/*<searched> declare a variable or function */</font></a>
<a name="314"><font color="red">int</font> <a name="searched">ParseDeclaration</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>, <font color="red">enum</font> Lex<a name="searched">Token</a> <a name="searched">Token</a>)</a>
<a name="315">{</a>
<a name="316">    <font color="red">char</font> *<a name="searched">Identifier</a>;</a>
<a name="317">    <font color="brown">struct</font> ValueType *<a name="searched">BasicType</a>;</a>
<a name="318">    <font color="brown">struct</font> Value<a name="searched">Typ</a>e *<a name="searched">Typ</a>;</a>
<a name="319">    <font color="brown">struct</font> Value *<a name="searched">NewVariable</a> = NULL;</a>
<a name="320">    <font color="red">int</font> <a name="searched">IsStatic</a> = FALSE;</a>
<a name="321">    <font color="red">int</font> <a name="searched">FirstVisit</a> = FALSE;</a>
<a name="322">    Picoc *<a name="searched">pc</a> = <a href="parse_c.html#314">Parser</a>-&gt<a name="searched">pc</a>;</a>
<a name="323"></a>
<a name="324">    <a href="type_c.html#350">TypeParseFront</a>(Parser, &<a href="parse_c.html#317">BasicType</a>, &<a href="parse_c.html#320">IsStatic</a>);</a>
<a name="325">    do</a>
<a name="326">    {</a>
<a name="327">        <a href="type_c.html#472">TypeParseIdentPart</a>(Parser, <a href="parse_c.html#317">BasicType</a>, &<a href="parse_c.html#318">Typ</a>, &<a href="parse_c.html#316">Identifier</a>);</a>
<a name="328">        <font color="green">if</font> ((Token != TokenVoidType && <a href="parse_c.html#314">Token</a> != TokenStructType && <a href="parse_c.html#314">Token</a> != TokenUnionType && <a href="parse_c.html#314">Token</a> != TokenEnumType) && <a href="parse_c.html#316">Identifier</a> == <a href="parse_c.html#322">pc</a>-&gtStrEmpty)</a>
<a name="329">            <a href="platform_c.html#134">ProgramFail</a>(Parser, "identifier expected");</a>
<a name="330">            </a>
<a name="331">        <font color="green">if</font> (Identifier != <a href="parse_c.html#322">pc</a>-&gtStrEmpty)</a>
<a name="332">        {</a>
<a name="333">            <font color="gray">/*<searched> handle function definitions */</font></a>
<a name="334">            <font color="green">if</font> (LexGetToken(Parser, NULL, FALSE) == TokenOpenBracket)</a>
<a name="335">            {</a>
<a name="336">                <a href="parse_c.html#59">ParseFunctionDefinition</a>(Parser, <a href="parse_c.html#318">Typ</a>, <a href="parse_c.html#316">Identifier</a>);</a>
<a name="337">                <font color="green">return</font> FALSE;</a>
<a name="338">            }</a>
<a name="339">            <font color="green">else</font></a>
<a name="340">            {</a>
<a name="341">                <font color="green">if</font> (Typ == &<a href="parse_c.html#322">pc</a>-&gtVoidType && <a href="parse_c.html#316">Identifier</a> != <a href="parse_c.html#322">pc</a>-&gtStrEmpty)</a>
<a name="342">                    <a href="platform_c.html#134">ProgramFail</a>(Parser, "can't define a <font color="red">void</font> variable");</a>
<a name="343">                    </a>
<a name="344">                <font color="green">if</font> (Parser-&gtMode == RunModeRun || <a href="parse_c.html#314">Parser</a>-&gtMode == RunModeGoto)</a>
<a name="345">                    <a href="parse_c.html#319">NewVariable</a> = <a href="variable_c.html#285">VariableDefineButIgnoreIdentical</a>(Parser, <a href="parse_c.html#316">Identifier</a>, <a href="parse_c.html#318">Typ</a>, <a href="parse_c.html#320">IsStatic</a>, &<a href="parse_c.html#321">FirstVisit</a>);</a>
<a name="346">                </a>
<a name="347">                <font color="green">if</font> (LexGetToken(Parser, NULL, FALSE) == TokenAssign)</a>
<a name="348">                {</a>
<a name="349">                    <font color="gray">/*<searched> we're assigning an initial value */</font></a>
<a name="350">                    <a href="lex_c.html#883">LexGetToken</a>(Parser, NULL, TRUE);</a>
<a name="351">                    <a href="parse_c.html#289">ParseDeclarationAssignment</a>(Parser, <a href="parse_c.html#319">NewVariable</a>, !<a href="parse_c.html#320">IsStatic</a> || <a href="parse_c.html#321">FirstVisit</a>);</a>
<a name="352">                }</a>
<a name="353">            }</a>
<a name="354">        }</a>
<a name="355">        </a>
<a name="356">        <a href="parse_c.html#314">Token</a> = <a href="lex_c.html#883">LexGetToken</a>(Parser, NULL, FALSE);</a>
<a name="357">        <font color="green">if</font> (Token == TokenComma)</a>
<a name="358">            <a href="lex_c.html#883">LexGetToken</a>(Parser, NULL, TRUE);</a>
<a name="359">            </a>
<a name="360">    } <font color="green">while</font> (Token == TokenComma);</a>
<a name="361">    </a>
<a name="362">    <font color="green">return</font> TRUE;</a>
<a name="363">}</a>
<a name="364"></a>
<a name="365"><font color="gray">/*<searched> parse a #define macro definition and store it for later */</font></a>
<a name="366"><font color="red">void</font> <a name="searched">ParseMacroDefinition</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>)</a>
<a name="367">{</a>
<a name="368">    <font color="brown">struct</font> Value *<a name="searched">MacroName</a>;</a>
<a name="369">    <font color="red">char</font> *<a name="searched">MacroNameStr</a>;</a>
<a name="370">    <font color="brown">struct</font> Value *<a name="searched">ParamName</a>;</a>
<a name="371">    <font color="brown">struct</font> Value *<a name="searched">MacroValue</a>;</a>
<a name="372"></a>
<a name="373">    <font color="green">if</font> (LexGetToken(Parser, &<a href="parse_c.html#368">MacroName</a>, TRUE) != TokenIdentifier)</a>
<a name="374">        <a href="platform_c.html#134">ProgramFail</a>(Parser, "identifier expected");</a>
<a name="375">    </a>
<a name="376">    <a href="parse_c.html#369">MacroNameStr</a> = <a href="parse_c.html#368">MacroName</a>-&gtVal-&gtIdentifier;</a>
<a name="377">    </a>
<a name="378">    <font color="green">if</font> (LexRawPeekToken(Parser) == TokenOpenMacroBracket)</a>
<a name="379">    {</a>
<a name="380">        <font color="gray">/*<searched> it's a parameterised macro, read the parameters */</font></a>
<a name="381">        <font color="red">enum</font> Lex<a name="searched">Token</a> <a name="searched">Token</a> = LexGet<a name="searched">Token</a>(Parser, NULL, TRUE);</a>
<a name="382">        <font color="brown">struct</font> ParseState <a name="searched">ParamParser</a>;</a>
<a name="383">        <font color="red">int</font> <a name="searched">NumParams</a>;</a>
<a name="384">        <font color="red">int</font> <a name="searched">ParamCount</a> = 0;</a>
<a name="385">        </a>
<a name="386">        <a href="parse_c.html#429">ParserCopy</a>(&<a href="parse_c.html#382">ParamParser</a>, <a href="parse_c.html#366">Parser</a>);</a>
<a name="387">        <a href="parse_c.html#383">NumParams</a> = <a href="parse_c.html#39">ParseCountParams</a>(&<a href="parse_c.html#382">ParamParser</a>);</a>
<a name="388">        <a href="parse_c.html#371">MacroValue</a> = <a href="variable_c.html#89">VariableAllocValueAndData</a>(Parser-&gtpc, <a href="parse_c.html#366">Parser</a>, sizeof(<font color="brown">struct</font> MacroDef) + sizeof(const <font color="red">char</font> *) * <a href="parse_c.html#383">NumParams</a>, FALSE, NULL, TRUE);</a>
<a name="389">        <a href="parse_c.html#371">MacroValue</a>-&gtVal-&gtMacroDef.NumParams = <a href="parse_c.html#383">NumParams</a>;</a>
<a name="390">        <a href="parse_c.html#371">MacroValue</a>-&gtVal-&gtMacroDef.ParamName = (<font color="red">char</font> **)((<font color="red">char</font> *)MacroValue-&gtVal + sizeof(<font color="brown">struct</font> MacroDef));</a>
<a name="391"></a>
<a name="392">        <a href="parse_c.html#381">Token</a> = <a href="lex_c.html#883">LexGetToken</a>(Parser, &<a href="parse_c.html#370">ParamName</a>, TRUE);</a>
<a name="393">        </a>
<a name="394">        <font color="green">while</font> (Token == TokenIdentifier)</a>
<a name="395">        {</a>
<a name="396">            <font color="gray">/*<searched> store a parameter name */</font></a>
<a name="397">            <a href="parse_c.html#371">MacroValue</a>-&gtVal-&gtMacroDef.ParamName[<a href="parse_c.html#384">ParamCount</a>++] = <a href="parse_c.html#370">ParamName</a>-&gtVal-&gtIdentifier;</a>
<a name="398">            </a>
<a name="399">            <font color="gray">/*<searched> get the trailing comma */</font></a>
<a name="400">            <a href="parse_c.html#381">Token</a> = <a href="lex_c.html#883">LexGetToken</a>(Parser, NULL, TRUE);</a>
<a name="401">            <font color="green">if</font> (Token == TokenComma)</a>
<a name="402">                <a href="parse_c.html#381">Token</a> = <a href="lex_c.html#883">LexGetToken</a>(Parser, &<a href="parse_c.html#370">ParamName</a>, TRUE);</a>
<a name="403">                </a>
<a name="404">            <font color="green">else</font> <font color="green">if</font> (Token != TokenCloseBracket)</a>
<a name="405">                <a href="platform_c.html#134">ProgramFail</a>(Parser, "comma expected");</a>
<a name="406">        }</a>
<a name="407">        </a>
<a name="408">        <font color="green">if</font> (Token != TokenCloseBracket)</a>
<a name="409">            <a href="platform_c.html#134">ProgramFail</a>(Parser, "close bracket expected");</a>
<a name="410">    }</a>
<a name="411">    <font color="green">else</font></a>
<a name="412">    {</a>
<a name="413">        <font color="gray">/*<searched> allocate a simple unparameterised macro */</font></a>
<a name="414">        <a href="parse_c.html#371">MacroValue</a> = <a href="variable_c.html#89">VariableAllocValueAndData</a>(Parser-&gtpc, <a href="parse_c.html#366">Parser</a>, sizeof(<font color="brown">struct</font> MacroDef), FALSE, NULL, TRUE);</a>
<a name="415">        <a href="parse_c.html#371">MacroValue</a>-&gtVal-&gtMacroDef.NumParams = 0;</a>
<a name="416">    }</a>
<a name="417">    </a>
<a name="418">    <font color="gray">/*<searched> copy the body of the macro to execute later */</font></a>
<a name="419">    <a href="parse_c.html#429">ParserCopy</a>(&<a href="parse_c.html#371">MacroValue</a>-&gtVal-&gtMacroDef.Body, <a href="parse_c.html#366">Parser</a>);</a>
<a name="420">    <a href="parse_c.html#371">MacroValue</a>-&gtTyp = &<a href="parse_c.html#366">Parser</a>-&gtpc-&gtMacroType;</a>
<a name="421">    <a href="lex_c.html#921">LexToEndOfLine</a>(Parser);</a>
<a name="422">    <a href="parse_c.html#371">MacroValue</a>-&gtVal-&gtMacroDef.Body.Pos = <a href="lex_c.html#934">LexCopyTokens</a>(&<a href="parse_c.html#371">MacroValue</a>-&gtVal-&gtMacroDef.Body, <a href="parse_c.html#366">Parser</a>);</a>
<a name="423">    </a>
<a name="424">    <font color="green">if</font> (!<a href="table_c.html#58">TableSet</a>(Parser-&gtpc, &<a href="parse_c.html#366">Parser</a>-&gtpc-&gtGlobalTable, <a href="parse_c.html#369">MacroNameStr</a>, <a href="parse_c.html#371">MacroValue</a>, (<font color="red">char</font> *)Parser-&gtFileName, <a href="parse_c.html#366">Parser</a>-&gtLine, <a href="parse_c.html#366">Parser</a>-&gtCharacterPos))</a>
<a name="425">        <a href="platform_c.html#134">ProgramFail</a>(Parser, "'%s' is already defined", <a href="parse_c.html#369">MacroNameStr</a>);</a>
<a name="426">}</a>
<a name="427"></a>
<a name="428"><font color="gray">/*<searched> copy the entire parser state */</font></a>
<a name="429"><font color="red">void</font> <a name="searched">ParserCopy</a>(<font color="brown">struct</font> ParseState *<a name="searched">To</a>, <font color="brown">struct</font> ParseState *<a name="searched">From</a>)</a>
<a name="430">{</a>
<a name="431">    memcpy((<font color="red">void</font> *)To, (<font color="red">void</font> *)From, sizeof(*To));</a>
<a name="432">}</a>
<a name="433"></a>
<a name="434"><font color="gray">/*<searched> copy where we're at in the parsing */</font></a>
<a name="435"><font color="red">void</font> <a name="searched">ParserCopyPos</a>(<font color="brown">struct</font> ParseState *<a name="searched">To</a>, <font color="brown">struct</font> ParseState *<a name="searched">From</a>)</a>
<a name="436">{</a>
<a name="437">    <a href="parse_c.html#435">To</a>-&gtPos = <a href="parse_c.html#435">From</a>-&gtPos;</a>
<a name="438">    <a href="parse_c.html#435">To</a>-&gtLine = <a href="parse_c.html#435">From</a>-&gtLine;</a>
<a name="439">    <a href="parse_c.html#435">To</a>-&gtHashIfLevel = <a href="parse_c.html#435">From</a>-&gtHashIfLevel;</a>
<a name="440">    <a href="parse_c.html#435">To</a>-&gtHashIfEvaluateToLevel = <a href="parse_c.html#435">From</a>-&gtHashIfEvaluateToLevel;</a>
<a name="441">    <a href="parse_c.html#435">To</a>-&gtCharacterPos = <a href="parse_c.html#435">From</a>-&gtCharacterPos;</a>
<a name="442">}</a>
<a name="443"></a>
<a name="444"><font color="gray">/*<searched> parse a "for" statement */</font></a>
<a name="445"><font color="red">void</font> <a name="searched">ParseFor</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>)</a>
<a name="446">{</a>
<a name="447">    <font color="red">int</font> <a name="searched">Condition</a>;</a>
<a name="448">    <font color="brown">struct</font> ParseState <a name="searched">PreConditional</a>;</a>
<a name="449">    <font color="brown">struct</font> ParseState <a name="searched">PreIncrement</a>;</a>
<a name="450">    <font color="brown">struct</font> ParseState <a name="searched">PreStatement</a>;</a>
<a name="451">    <font color="brown">struct</font> ParseState <a name="searched">After</a>;</a>
<a name="452">    </a>
<a name="453">    <font color="red">enum</font> RunMode <a name="searched">OldMode</a> = <a href="parse_c.html#445">Parser</a>-&gtMode;</a>
<a name="454">    </a>
<a name="455">    <font color="red">int</font> <a name="searched">Prev<a name="searched">ScopeID</a></a> = 0, <a name="searched">ScopeID</a> = <a href="variable_c.html#165">VariableScopeBegin</a>(Parser, &<a name="searched">Prev<a name="searched">ScopeID</a></a>);</a>
<a name="456"></a>
<a name="457">    <font color="green">if</font> (LexGetToken(Parser, NULL, TRUE) != TokenOpenBracket)</a>
<a name="458">        <a href="platform_c.html#134">ProgramFail</a>(Parser, "'(' expected");</a>
<a name="459">                        </a>
<a name="460">    <font color="green">if</font> (ParseStatement(Parser, TRUE) != ParseResultOk)</a>
<a name="461">        <a href="platform_c.html#134">ProgramFail</a>(Parser, "statement expected");</a>
<a name="462">    </a>
<a name="463">    <a href="parse_c.html#435">ParserCopyPos</a>(&<a href="parse_c.html#448">PreConditional</a>, <a href="parse_c.html#445">Parser</a>);</a>
<a name="464">    <font color="green">if</font> (LexGetToken(Parser, NULL, FALSE) == TokenSemicolon)</a>
<a name="465">        <a href="parse_c.html#447">Condition</a> = TRUE;</a>
<a name="466">    <font color="green">else</font></a>
<a name="467">        <a href="parse_c.html#447">Condition</a> = <a href="expression_c.html#1569">ExpressionParseInt</a>(Parser);</a>
<a name="468">    </a>
<a name="469">    <font color="green">if</font> (LexGetToken(Parser, NULL, TRUE) != TokenSemicolon)</a>
<a name="470">        <a href="platform_c.html#134">ProgramFail</a>(Parser, "';' expected");</a>
<a name="471">    </a>
<a name="472">    <a href="parse_c.html#435">ParserCopyPos</a>(&<a href="parse_c.html#449">PreIncrement</a>, <a href="parse_c.html#445">Parser</a>);</a>
<a name="473">    <a href="parse_c.html#23">ParseStatementMaybeRun</a>(Parser, FALSE, FALSE);</a>
<a name="474">    </a>
<a name="475">    <font color="green">if</font> (LexGetToken(Parser, NULL, TRUE) != TokenCloseBracket)</a>
<a name="476">        <a href="platform_c.html#134">ProgramFail</a>(Parser, "')' expected");</a>
<a name="477">    </a>
<a name="478">    <a href="parse_c.html#435">ParserCopyPos</a>(&<a href="parse_c.html#450">PreStatement</a>, <a href="parse_c.html#445">Parser</a>);</a>
<a name="479">    <font color="green">if</font> (ParseStatementMaybeRun(Parser, <a href="parse_c.html#447">Condition</a>, TRUE) != ParseResultOk)</a>
<a name="480">        <a href="platform_c.html#134">ProgramFail</a>(Parser, "statement expected");</a>
<a name="481">    </a>
<a name="482">    <font color="green">if</font> (Parser-&gtMode == RunModeContinue && <a href="parse_c.html#453">OldMode</a> == RunModeRun)</a>
<a name="483">        <a href="parse_c.html#445">Parser</a>-&gtMode = RunModeRun;</a>
<a name="484">        </a>
<a name="485">    <a href="parse_c.html#435">ParserCopyPos</a>(&<a href="parse_c.html#451">After</a>, <a href="parse_c.html#445">Parser</a>);</a>
<a name="486">        </a>
<a name="487">    <font color="green">while</font> (Condition && <a href="parse_c.html#445">Parser</a>-&gtMode == RunModeRun)</a>
<a name="488">    {</a>
<a name="489">        <a href="parse_c.html#435">ParserCopyPos</a>(Parser, &<a href="parse_c.html#449">PreIncrement</a>);</a>
<a name="490">        <a href="parse_c.html#568">ParseStatement</a>(Parser, FALSE);</a>
<a name="491">                        </a>
<a name="492">        <a href="parse_c.html#435">ParserCopyPos</a>(Parser, &<a href="parse_c.html#448">PreConditional</a>);</a>
<a name="493">        <font color="green">if</font> (LexGetToken(Parser, NULL, FALSE) == TokenSemicolon)</a>
<a name="494">            <a href="parse_c.html#447">Condition</a> = TRUE;</a>
<a name="495">        <font color="green">else</font></a>
<a name="496">            <a href="parse_c.html#447">Condition</a> = <a href="expression_c.html#1569">ExpressionParseInt</a>(Parser);</a>
<a name="497">        </a>
<a name="498">        <font color="green">if</font> (Condition)</a>
<a name="499">        {</a>
<a name="500">            <a href="parse_c.html#435">ParserCopyPos</a>(Parser, &<a href="parse_c.html#450">PreStatement</a>);</a>
<a name="501">            <a href="parse_c.html#568">ParseStatement</a>(Parser, TRUE);</a>
<a name="502">            </a>
<a name="503">            <font color="green">if</font> (Parser-&gtMode == RunModeContinue)</a>
<a name="504">                <a href="parse_c.html#445">Parser</a>-&gtMode = RunModeRun;                </a>
<a name="505">        }</a>
<a name="506">    }</a>
<a name="507">    </a>
<a name="508">    <font color="green">if</font> (Parser-&gtMode == RunModeBreak && <a href="parse_c.html#453">OldMode</a> == RunModeRun)</a>
<a name="509">        <a href="parse_c.html#445">Parser</a>-&gtMode = RunModeRun;</a>
<a name="510"></a>
<a name="511">    <a href="variable_c.html#206">VariableScopeEnd</a>(Parser, <a href="parse_c.html#455">ScopeID</a>, <a href="parse_c.html#455">PrevScopeID</a>);</a>
<a name="512"></a>
<a name="513">    <a href="parse_c.html#435">ParserCopyPos</a>(Parser, &<a href="parse_c.html#451">After</a>);</a>
<a name="514">}</a>
<a name="515"></a>
<a name="516"><font color="gray">/*<searched> parse a block of code and return what mode it returned in */</font></a>
<a name="517"><font color="red">enum</font> RunMode <a name="searched">ParseBlock</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>, <font color="red">int</font> <a name="searched">AbsorbOpenBrace</a>, <font color="red">int</font> <a name="searched">Condition</a>)</a>
<a name="518">{</a>
<a name="519">    <font color="red">int</font> <a name="searched">Prev<a name="searched">ScopeID</a></a> = 0, <a name="searched">ScopeID</a> = <a href="variable_c.html#165">VariableScopeBegin</a>(Parser, &<a name="searched">Prev<a name="searched">ScopeID</a></a>);</a>
<a name="520"></a>
<a name="521">    <font color="green">if</font> (AbsorbOpenBrace && <a href="lex_c.html#883">LexGetToken</a>(Parser, NULL, TRUE) != TokenLeftBrace)</a>
<a name="522">        <a href="platform_c.html#134">ProgramFail</a>(Parser, "'{' expected");</a>
<a name="523"></a>
<a name="524">    <font color="green">if</font> (Parser-&gtMode == RunModeSkip || !<a href="parse_c.html#517">Condition</a>)</a>
<a name="525">    { </a>
<a name="526">        <font color="gray">/*<searched> condition failed - skip this block instead */</font></a>
<a name="527">        <font color="red">enum</font> RunMode <a name="searched">OldMode</a> = <a href="parse_c.html#517">Parser</a>-&gtMode;</a>
<a name="528">        <a href="parse_c.html#517">Parser</a>-&gtMode = RunModeSkip;</a>
<a name="529">        <font color="green">while</font> (ParseStatement(Parser, TRUE) == ParseResultOk)</a>
<a name="530">        {}</a>
<a name="531">        <a href="parse_c.html#517">Parser</a>-&gtMode = <a href="parse_c.html#527">OldMode</a>;</a>
<a name="532">    }</a>
<a name="533">    <font color="green">else</font></a>
<a name="534">    { </a>
<a name="535">        <font color="gray">/*<searched> just run it in its current mode */</font></a>
<a name="536">        <font color="green">while</font> (ParseStatement(Parser, TRUE) == ParseResultOk)</a>
<a name="537">        {}</a>
<a name="538">    }</a>
<a name="539">    </a>
<a name="540">    <font color="green">if</font> (LexGetToken(Parser, NULL, TRUE) != TokenRightBrace)</a>
<a name="541">        <a href="platform_c.html#134">ProgramFail</a>(Parser, "'}' expected");</a>
<a name="542"></a>
<a name="543">    <a href="variable_c.html#206">VariableScopeEnd</a>(Parser, <a href="parse_c.html#519">ScopeID</a>, <a href="parse_c.html#519">PrevScopeID</a>);</a>
<a name="544"></a>
<a name="545">    <font color="green">return</font> <a href="parse_c.html#517">Parser</a>-&gtMode;</a>
<a name="546">}</a>
<a name="547"></a>
<a name="548"><font color="gray">/*<searched> parse a typedef declaration */</font></a>
<a name="549"><font color="red">void</font> <a name="searched">ParseTypedef</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>)</a>
<a name="550">{</a>
<a name="551">    <font color="brown">struct</font> Value<a name="searched">Typ</a>e *<a name="searched">Typ</a>;</a>
<a name="552">    <font color="brown">struct</font> ValueType **<a name="searched">TypPtr</a>;</a>
<a name="553">    <font color="red">char</font> *<a name="searched">TypeName</a>;</a>
<a name="554">    <font color="brown">struct</font> Value <a name="searched">InitValue</a>;</a>
<a name="555">    </a>
<a name="556">    <a href="type_c.html#526">TypeParse</a>(Parser, &<a href="parse_c.html#551">Typ</a>, &<a href="parse_c.html#553">TypeName</a>, NULL);</a>
<a name="557">    </a>
<a name="558">    <font color="green">if</font> (Parser-&gtMode == RunModeRun)</a>
<a name="559">    {</a>
<a name="560">        <a href="parse_c.html#552">TypPtr</a> = &<a href="parse_c.html#551">Typ</a>;</a>
<a name="561">        <a href="parse_c.html#554">InitValue</a>.Typ = &<a href="parse_c.html#549">Parser</a>-&gtpc-&gtTypeType;</a>
<a name="562">        <a href="parse_c.html#554">InitValue</a>.Val = (union AnyValue *)TypPtr;</a>
<a name="563">        <a href="variable_c.html#259">VariableDefine</a>(Parser-&gtpc, <a href="parse_c.html#549">Parser</a>, <a href="parse_c.html#553">TypeName</a>, &<a href="parse_c.html#554">InitValue</a>, NULL, FALSE);</a>
<a name="564">    }</a>
<a name="565">}</a>
<a name="566"></a>
<a name="567"><font color="gray">/*<searched> parse a statement */</font></a>
<a name="568"><font color="red">enum</font> ParseResult <a name="searched">ParseStatement</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>, <font color="red">int</font> <a name="searched">CheckTrailingSemicolon</a>)</a>
<a name="569">{</a>
<a name="570">    <font color="brown">struct</font> Value *<a name="searched">CValue</a>;</a>
<a name="571">    <font color="brown">struct</font> Value *<a name="searched">LexerValue</a>;</a>
<a name="572">    <font color="brown">struct</font> Value *<a name="searched">VarValue</a>;</a>
<a name="573">    <font color="red">int</font> <a name="searched">Condition</a>;</a>
<a name="574">    <font color="brown">struct</font> ParseState <a name="searched">PreState</a>;</a>
<a name="575">    <font color="red">enum</font> Lex<a name="searched">Token</a> <a name="searched">Token</a>;</a>
<a name="576">    </a>
<a name="577">    <font color="gray">/*<searched> if we're debugging, check for a breakpoint */</font></a>
<a name="578">    <font color="green">if</font> (Parser-&gtDebugMode && <a href="parse_c.html#568">Parser</a>-&gtMode == RunModeRun)</a>
<a name="579">        <a href="debug_c.html#97">DebugCheckStatement</a>(Parser);</a>
<a name="580">    </a>
<a name="581">    <font color="gray">/*<searched> take note of where we are and then grab a token to see what statement we have */</font>   </a>
<a name="582">    <a href="parse_c.html#429">ParserCopy</a>(&<a href="parse_c.html#574">PreState</a>, <a href="parse_c.html#568">Parser</a>);</a>
<a name="583">    <a href="parse_c.html#575">Token</a> = <a href="lex_c.html#883">LexGetToken</a>(Parser, &<a href="parse_c.html#571">LexerValue</a>, TRUE);</a>
<a name="584">    </a>
<a name="585">    <font color="green">switch</font> (Token)</a>
<a name="586">    {</a>
<a name="587">        <font color="green">case</font> TokenEOF:</a>
<a name="588">            <font color="green">return</font> ParseResultEOF;</a>
<a name="589">            </a>
<a name="590">        <font color="green">case</font> TokenIdentifier:</a>
<a name="591">            <font color="gray">/*<searched> might be a typedef-typed variable declaration or it might be an expression */</font></a>
<a name="592">            <font color="green">if</font> (VariableDefined(Parser-&gtpc, <a href="parse_c.html#571">LexerValue</a>-&gtVal-&gtIdentifier))</a>
<a name="593">            {</a>
<a name="594">                <a href="variable_c.html#360">VariableGet</a>(Parser-&gtpc, <a href="parse_c.html#568">Parser</a>, <a href="parse_c.html#571">LexerValue</a>-&gtVal-&gtIdentifier, &<a href="parse_c.html#572">VarValue</a>);</a>
<a name="595">                <font color="green">if</font> (VarValue-&gtTyp-&gtBase == Type_Type)</a>
<a name="596">                {</a>
<a name="597">                    *Parser = <a href="parse_c.html#574">PreState</a>;</a>
<a name="598">                    <a href="parse_c.html#314">ParseDeclaration</a>(Parser, <a href="parse_c.html#575">Token</a>);</a>
<a name="599">                    break;</a>
<a name="600">                }</a>
<a name="601">            }</a>
<a name="602">            <font color="green">else</font></a>
<a name="603">            {</a>
<a name="604">                <font color="gray">/*<searched> it might be a goto label */</font></a>
<a name="605">                <font color="red">enum</font> LexToken <a name="searched">NextToken</a> = <a href="lex_c.html#883">LexGetToken</a>(Parser, NULL, FALSE);</a>
<a name="606">                <font color="green">if</font> (NextToken == TokenColon)</a>
<a name="607">                {</a>
<a name="608">                    <font color="gray">/*<searched> declare the identifier as a goto label */</font></a>
<a name="609">                    <a href="lex_c.html#883">LexGetToken</a>(Parser, NULL, TRUE);</a>
<a name="610">                    <font color="green">if</font> (Parser-&gtMode == RunModeGoto && <a href="parse_c.html#571">LexerValue</a>-&gtVal-&gtIdentifier == <a href="parse_c.html#568">Parser</a>-&gtSearchGotoLabel)</a>
<a name="611">                        <a href="parse_c.html#568">Parser</a>-&gtMode = RunModeRun;</a>
<a name="612">        </a>
<a name="613">                    <a href="parse_c.html#568">CheckTrailingSemicolon</a> = FALSE;</a>
<a name="614">                    break;</a>
<a name="615">                }</a>
<a name="616">#ifdef FEATURE_AUTO_DECLARE_VARIABLES</a>
<a name="617">                else <font color="gray">/*<searched> new_identifier = something */</font></a>
<a name="618">                {    <font color="gray">/*<searched> try to guess type and declare the variable based on assigned value */</font></a>
<a name="619">                    <font color="green">if</font> (NextToken == TokenAssign && !<a href="variable_c.html#241">VariableDefinedAndOutOfScope</a>(Parser-&gtpc, <a href="parse_c.html#571">LexerValue</a>-&gtVal-&gtIdentifier))</a>
<a name="620">                    {</a>
<a name="621">                        <font color="green">if</font> (Parser-&gtMode == RunModeRun)</a>
<a name="622">                        {</a>
<a name="623">                            <font color="brown">struct</font> Value *CValue;</a>
<a name="624">                            <font color="red">char</font>* Identifier = <a href="parse_c.html#571">LexerValue</a>-&gtVal-&gtIdentifier;</a>
<a name="625"></a>
<a name="626">                            <a href="lex_c.html#883">LexGetToken</a>(Parser, NULL, TRUE);</a>
<a name="627">                            <font color="green">if</font> (!<a href="expression_c.html#1077">ExpressionParse</a>(Parser, &<a href="parse_c.html#570">CValue</a>))</a>
<a name="628">                            {</a>
<a name="629">                                <a href="platform_c.html#134">ProgramFail</a>(Parser, "expected: expression");</a>
<a name="630">                            }</a>
<a name="631">                            </a>
<a name="632">                            #<font color="green">if</font> 0</a>
<a name="633">                            PRINT_SOURCE_POS;</a>
<a name="634">                            <a href="platform_c.html#192">PlatformPrintf</a>(Parser-&gtpc-&gtCStdOut, "%t %s = %d;\n", <a href="parse_c.html#570">CValue</a>-&gtTyp, Identifier, <a href="parse_c.html#570">CValue</a>-&gtVal-&gtInteger);</a>
<a name="635">                            printf("%d\n", <a href="variable_c.html#346">VariableDefined</a>(Parser-&gtpc, Identifier));</a>
<a name="636">                            #endif</a>
<a name="637">                            <a href="variable_c.html#259">VariableDefine</a>(Parser-&gtpc, <a href="parse_c.html#568">Parser</a>, Identifier, <a href="parse_c.html#570">CValue</a>, <a href="parse_c.html#570">CValue</a>-&gtTyp, TRUE);</a>
<a name="638">                            break;</a>
<a name="639">                        }</a>
<a name="640">                    }</a>
<a name="641">                }</a>
<a name="642">#endif</a>
<a name="643">            }</a>
<a name="644">            <font color="gray">/*<searched> else fallthrough to expression */</font></a>
<a name="645">	    <font color="gray">/*<searched> no break */</font></a>
<a name="646">            </a>
<a name="647">        <font color="green">case</font> TokenAsterisk: </a>
<a name="648">        <font color="green">case</font> TokenAmpersand: </a>
<a name="649">        <font color="green">case</font> TokenIncrement: </a>
<a name="650">        <font color="green">case</font> TokenDecrement: </a>
<a name="651">        <font color="green">case</font> TokenOpenBracket: </a>
<a name="652">            *Parser = <a href="parse_c.html#574">PreState</a>;</a>
<a name="653">            <a href="expression_c.html#1077">ExpressionParse</a>(Parser, &<a href="parse_c.html#570">CValue</a>);</a>
<a name="654">            <font color="green">if</font> (Parser-&gtMode == RunModeRun) </a>
<a name="655">                <a href="variable_c.html#386">VariableStackPop</a>(Parser, <a href="parse_c.html#570">CValue</a>);</a>
<a name="656">            break;</a>
<a name="657">            </a>
<a name="658">        <font color="green">case</font> TokenLeftBrace:</a>
<a name="659">            <a href="parse_c.html#517">ParseBlock</a>(Parser, FALSE, TRUE);</a>
<a name="660">            <a href="parse_c.html#568">CheckTrailingSemicolon</a> = FALSE;</a>
<a name="661">            break;</a>
<a name="662">            </a>
<a name="663">        <font color="green">case</font> TokenIf:</a>
<a name="664">            <font color="green">if</font> (LexGetToken(Parser, NULL, TRUE) != TokenOpenBracket)</a>
<a name="665">                <a href="platform_c.html#134">ProgramFail</a>(Parser, "'(' expected");</a>
<a name="666">                </a>
<a name="667">            <a href="parse_c.html#573">Condition</a> = <a href="expression_c.html#1569">ExpressionParseInt</a>(Parser);</a>
<a name="668">            </a>
<a name="669">            <font color="green">if</font> (LexGetToken(Parser, NULL, TRUE) != TokenCloseBracket)</a>
<a name="670">                <a href="platform_c.html#134">ProgramFail</a>(Parser, "')' expected");</a>
<a name="671"></a>
<a name="672">            <font color="green">if</font> (ParseStatementMaybeRun(Parser, <a href="parse_c.html#573">Condition</a>, TRUE) != ParseResultOk)</a>
<a name="673">                <a href="platform_c.html#134">ProgramFail</a>(Parser, "statement expected");</a>
<a name="674">            </a>
<a name="675">            <font color="green">if</font> (LexGetToken(Parser, NULL, FALSE) == TokenElse)</a>
<a name="676">            {</a>
<a name="677">                <a href="lex_c.html#883">LexGetToken</a>(Parser, NULL, TRUE);</a>
<a name="678">                <font color="green">if</font> (ParseStatementMaybeRun(Parser, !<a href="parse_c.html#573">Condition</a>, TRUE) != ParseResultOk)</a>
<a name="679">                    <a href="platform_c.html#134">ProgramFail</a>(Parser, "statement expected");</a>
<a name="680">            }</a>
<a name="681">            <a href="parse_c.html#568">CheckTrailingSemicolon</a> = FALSE;</a>
<a name="682">            break;</a>
<a name="683">        </a>
<a name="684">        <font color="green">case</font> TokenWhile:</a>
<a name="685">            {</a>
<a name="686">                <font color="brown">struct</font> ParseState <a name="searched">PreConditional</a>;</a>
<a name="687">                <font color="red">enum</font> RunMode <a name="searched">PreMode</a> = <a href="parse_c.html#568">Parser</a>-&gtMode;</a>
<a name="688"></a>
<a name="689">                <font color="green">if</font> (LexGetToken(Parser, NULL, TRUE) != TokenOpenBracket)</a>
<a name="690">                    <a href="platform_c.html#134">ProgramFail</a>(Parser, "'(' expected");</a>
<a name="691">                    </a>
<a name="692">                <a href="parse_c.html#435">ParserCopyPos</a>(&<a href="parse_c.html#686">PreConditional</a>, <a href="parse_c.html#568">Parser</a>);</a>
<a name="693">                do</a>
<a name="694">                {</a>
<a name="695">                    <a href="parse_c.html#435">ParserCopyPos</a>(Parser, &<a href="parse_c.html#686">PreConditional</a>);</a>
<a name="696">                    <a href="parse_c.html#573">Condition</a> = <a href="expression_c.html#1569">ExpressionParseInt</a>(Parser);</a>
<a name="697">                    <font color="green">if</font> (LexGetToken(Parser, NULL, TRUE) != TokenCloseBracket)</a>
<a name="698">                        <a href="platform_c.html#134">ProgramFail</a>(Parser, "')' expected");</a>
<a name="699">                    </a>
<a name="700">                    <font color="green">if</font> (ParseStatementMaybeRun(Parser, <a href="parse_c.html#573">Condition</a>, TRUE) != ParseResultOk)</a>
<a name="701">                        <a href="platform_c.html#134">ProgramFail</a>(Parser, "statement expected");</a>
<a name="702">                    </a>
<a name="703">                    <font color="green">if</font> (Parser-&gtMode == RunModeContinue)</a>
<a name="704">                        <a href="parse_c.html#568">Parser</a>-&gtMode = <a href="parse_c.html#687">PreMode</a>;</a>
<a name="705">                    </a>
<a name="706">                } <font color="green">while</font> (Parser-&gtMode == RunModeRun && <a href="parse_c.html#573">Condition</a>);</a>
<a name="707">                </a>
<a name="708">                <font color="green">if</font> (Parser-&gtMode == RunModeBreak)</a>
<a name="709">                    <a href="parse_c.html#568">Parser</a>-&gtMode = <a href="parse_c.html#687">PreMode</a>;</a>
<a name="710"></a>
<a name="711">                <a href="parse_c.html#568">CheckTrailingSemicolon</a> = FALSE;</a>
<a name="712">            }</a>
<a name="713">            break;</a>
<a name="714">                </a>
<a name="715">        <font color="green">case</font> TokenDo:</a>
<a name="716">            {</a>
<a name="717">                <font color="brown">struct</font> ParseState <a name="searched">PreStatement</a>;</a>
<a name="718">                <font color="red">enum</font> RunMode <a name="searched">PreMode</a> = <a href="parse_c.html#568">Parser</a>-&gtMode;</a>
<a name="719">                <a href="parse_c.html#435">ParserCopyPos</a>(&<a href="parse_c.html#717">PreStatement</a>, <a href="parse_c.html#568">Parser</a>);</a>
<a name="720">                do</a>
<a name="721">                {</a>
<a name="722">                    <a href="parse_c.html#435">ParserCopyPos</a>(Parser, &<a href="parse_c.html#717">PreStatement</a>);</a>
<a name="723">                    <font color="green">if</font> (ParseStatement(Parser, TRUE) != ParseResultOk)</a>
<a name="724">                        <a href="platform_c.html#134">ProgramFail</a>(Parser, "statement expected");</a>
<a name="725">                </a>
<a name="726">                    <font color="green">if</font> (Parser-&gtMode == RunModeContinue)</a>
<a name="727">                        <a href="parse_c.html#568">Parser</a>-&gtMode = <a href="parse_c.html#718">PreMode</a>;</a>
<a name="728"></a>
<a name="729">                    <font color="green">if</font> (LexGetToken(Parser, NULL, TRUE) != TokenWhile)</a>
<a name="730">                        <a href="platform_c.html#134">ProgramFail</a>(Parser, "'<font color="green">while</font>' expected");</a>
<a name="731">                    </a>
<a name="732">                    <font color="green">if</font> (LexGetToken(Parser, NULL, TRUE) != TokenOpenBracket)</a>
<a name="733">                        <a href="platform_c.html#134">ProgramFail</a>(Parser, "'(' expected");</a>
<a name="734">                        </a>
<a name="735">                    <a href="parse_c.html#573">Condition</a> = <a href="expression_c.html#1569">ExpressionParseInt</a>(Parser);</a>
<a name="736">                    <font color="green">if</font> (LexGetToken(Parser, NULL, TRUE) != TokenCloseBracket)</a>
<a name="737">                        <a href="platform_c.html#134">ProgramFail</a>(Parser, "')' expected");</a>
<a name="738">                    </a>
<a name="739">                } <font color="green">while</font> (Condition && <a href="parse_c.html#568">Parser</a>-&gtMode == RunModeRun);           </a>
<a name="740">                </a>
<a name="741">                <font color="green">if</font> (Parser-&gtMode == RunModeBreak)</a>
<a name="742">                    <a href="parse_c.html#568">Parser</a>-&gtMode = <a href="parse_c.html#718">PreMode</a>;</a>
<a name="743">            }</a>
<a name="744">            break;</a>
<a name="745">                </a>
<a name="746">        <font color="green">case</font> TokenFor:</a>
<a name="747">            <a href="parse_c.html#445">ParseFor</a>(Parser);</a>
<a name="748">            <a href="parse_c.html#568">CheckTrailingSemicolon</a> = FALSE;</a>
<a name="749">            break;</a>
<a name="750"></a>
<a name="751">        <font color="green">case</font> TokenSemicolon: </a>
<a name="752">            <a href="parse_c.html#568">CheckTrailingSemicolon</a> = FALSE; </a>
<a name="753">            break;</a>
<a name="754"></a>
<a name="755">        <font color="green">case</font> TokenIntType:</a>
<a name="756">        <font color="green">case</font> TokenShortType:</a>
<a name="757">        <font color="green">case</font> TokenCharType:</a>
<a name="758">        <font color="green">case</font> TokenLongType:</a>
<a name="759">        <font color="green">case</font> TokenFloatType:</a>
<a name="760">        <font color="green">case</font> TokenDoubleType:</a>
<a name="761">        <font color="green">case</font> TokenVoidType:</a>
<a name="762">        <font color="green">case</font> TokenStructType:</a>
<a name="763">        <font color="green">case</font> TokenUnionType:</a>
<a name="764">        <font color="green">case</font> TokenEnumType:</a>
<a name="765">        <font color="green">case</font> TokenSignedType:</a>
<a name="766">        <font color="green">case</font> TokenUnsignedType:</a>
<a name="767">        <font color="green">case</font> TokenStaticType:</a>
<a name="768">        <font color="green">case</font> TokenAutoType:</a>
<a name="769">        <font color="green">case</font> TokenRegisterType:</a>
<a name="770">        <font color="green">case</font> TokenExternType:</a>
<a name="771">            *Parser = <a href="parse_c.html#574">PreState</a>;</a>
<a name="772">            <a href="parse_c.html#568">CheckTrailingSemicolon</a> = <a href="parse_c.html#314">ParseDeclaration</a>(Parser, <a href="parse_c.html#575">Token</a>);</a>
<a name="773">            break;</a>
<a name="774">        </a>
<a name="775">        <font color="green">case</font> TokenHashDefine:</a>
<a name="776">            <a href="parse_c.html#366">ParseMacroDefinition</a>(Parser);</a>
<a name="777">            <a href="parse_c.html#568">CheckTrailingSemicolon</a> = FALSE;</a>
<a name="778">            break;</a>
<a name="779">            </a>
<a name="780">#ifndef NO_HASH_INCLUDE</a>
<a name="781">        <font color="green">case</font> TokenHashInclude:</a>
<a name="782">            <font color="green">if</font> (LexGetToken(Parser, &<a href="parse_c.html#571">LexerValue</a>, TRUE) != TokenStringConstant)</a>
<a name="783">                <a href="platform_c.html#134">ProgramFail</a>(Parser, "\"filename.h\" expected");</a>
<a name="784">            </a>
<a name="785">            <a href="include_c.html#68">IncludeFile</a>(Parser-&gtpc, (<font color="red">char</font> *)LexerValue-&gtVal-&gtPointer);</a>
<a name="786">            <a href="parse_c.html#568">CheckTrailingSemicolon</a> = FALSE;</a>
<a name="787">            break;</a>
<a name="788">#endif</a>
<a name="789"></a>
<a name="790">        <font color="green">case</font> TokenSwitch:</a>
<a name="791">            <font color="green">if</font> (LexGetToken(Parser, NULL, TRUE) != TokenOpenBracket)</a>
<a name="792">                <a href="platform_c.html#134">ProgramFail</a>(Parser, "'(' expected");</a>
<a name="793">                </a>
<a name="794">            <a href="parse_c.html#573">Condition</a> = <a href="expression_c.html#1569">ExpressionParseInt</a>(Parser);</a>
<a name="795">            </a>
<a name="796">            <font color="green">if</font> (LexGetToken(Parser, NULL, TRUE) != TokenCloseBracket)</a>
<a name="797">                <a href="platform_c.html#134">ProgramFail</a>(Parser, "')' expected");</a>
<a name="798">            </a>
<a name="799">            <font color="green">if</font> (LexGetToken(Parser, NULL, FALSE) != TokenLeftBrace)</a>
<a name="800">                <a href="platform_c.html#134">ProgramFail</a>(Parser, "'{' expected");</a>
<a name="801">            </a>
<a name="802">            { </a>
<a name="803">                <font color="gray">/*<searched> new block so we can store parser state */</font></a>
<a name="804">                <font color="red">enum</font> RunMode <a name="searched">OldMode</a> = <a href="parse_c.html#568">Parser</a>-&gtMode;</a>
<a name="805">                <font color="red">int</font> <a name="searched">OldSearchLabel</a> = <a href="parse_c.html#568">Parser</a>-&gtSearchLabel;</a>
<a name="806">                <a href="parse_c.html#568">Parser</a>-&gtMode = RunModeCaseSearch;</a>
<a name="807">                <a href="parse_c.html#568">Parser</a>-&gtSearchLabel = <a href="parse_c.html#573">Condition</a>;</a>
<a name="808">                </a>
<a name="809">                <a href="parse_c.html#517">ParseBlock</a>(Parser, TRUE, (OldMode != RunModeSkip) && (OldMode != RunModeReturn));</a>
<a name="810">                </a>
<a name="811">                <font color="green">if</font> (Parser-&gtMode != RunModeReturn)</a>
<a name="812">                    <a href="parse_c.html#568">Parser</a>-&gtMode = <a href="parse_c.html#804">OldMode</a>;</a>
<a name="813"></a>
<a name="814">                <a href="parse_c.html#568">Parser</a>-&gtSearchLabel = <a href="parse_c.html#805">OldSearchLabel</a>;</a>
<a name="815">            }</a>
<a name="816"></a>
<a name="817">            <a href="parse_c.html#568">CheckTrailingSemicolon</a> = FALSE;</a>
<a name="818">            break;</a>
<a name="819"></a>
<a name="820">        <font color="green">case</font> TokenCase:</a>
<a name="821">            <font color="green">if</font> (Parser-&gtMode == RunModeCaseSearch)</a>
<a name="822">            {</a>
<a name="823">                <a href="parse_c.html#568">Parser</a>-&gtMode = RunModeRun;</a>
<a name="824">                <a href="parse_c.html#573">Condition</a> = <a href="expression_c.html#1569">ExpressionParseInt</a>(Parser);</a>
<a name="825">                <a href="parse_c.html#568">Parser</a>-&gtMode = RunModeCaseSearch;</a>
<a name="826">            }</a>
<a name="827">            <font color="green">else</font></a>
<a name="828">                <a href="parse_c.html#573">Condition</a> = <a href="expression_c.html#1569">ExpressionParseInt</a>(Parser);</a>
<a name="829">                </a>
<a name="830">            <font color="green">if</font> (LexGetToken(Parser, NULL, TRUE) != TokenColon)</a>
<a name="831">                <a href="platform_c.html#134">ProgramFail</a>(Parser, "':' expected");</a>
<a name="832">            </a>
<a name="833">            <font color="green">if</font> (Parser-&gtMode == RunModeCaseSearch && <a href="parse_c.html#573">Condition</a> == <a href="parse_c.html#568">Parser</a>-&gtSearchLabel)</a>
<a name="834">                <a href="parse_c.html#568">Parser</a>-&gtMode = RunModeRun;</a>
<a name="835"></a>
<a name="836">            <a href="parse_c.html#568">CheckTrailingSemicolon</a> = FALSE;</a>
<a name="837">            break;</a>
<a name="838">            </a>
<a name="839">        <font color="green">case</font> TokenDefault:</a>
<a name="840">            <font color="green">if</font> (LexGetToken(Parser, NULL, TRUE) != TokenColon)</a>
<a name="841">                <a href="platform_c.html#134">ProgramFail</a>(Parser, "':' expected");</a>
<a name="842">            </a>
<a name="843">            <font color="green">if</font> (Parser-&gtMode == RunModeCaseSearch)</a>
<a name="844">                <a href="parse_c.html#568">Parser</a>-&gtMode = RunModeRun;</a>
<a name="845">                </a>
<a name="846">            <a href="parse_c.html#568">CheckTrailingSemicolon</a> = FALSE;</a>
<a name="847">            break;</a>
<a name="848"></a>
<a name="849">        <font color="green">case</font> TokenBreak:</a>
<a name="850">            <font color="green">if</font> (Parser-&gtMode == RunModeRun)</a>
<a name="851">                <a href="parse_c.html#568">Parser</a>-&gtMode = RunModeBreak;</a>
<a name="852">            break;</a>
<a name="853">            </a>
<a name="854">        <font color="green">case</font> TokenContinue:</a>
<a name="855">            <font color="green">if</font> (Parser-&gtMode == RunModeRun)</a>
<a name="856">                <a href="parse_c.html#568">Parser</a>-&gtMode = RunModeContinue;</a>
<a name="857">            break;</a>
<a name="858">            </a>
<a name="859">        <font color="green">case</font> TokenReturn:</a>
<a name="860">            <font color="green">if</font> (Parser-&gtMode == RunModeRun)</a>
<a name="861">            {</a>
<a name="862">                <font color="green">if</font> (!<a href="parse_c.html#568">Parser</a>-&gtpc-&gtTopStackFrame || <a href="parse_c.html#568">Parser</a>-&gtpc-&gtTopStackFrame-&gtReturnValue-&gtTyp-&gtBase != TypeVoid)</a>
<a name="863">                {</a>
<a name="864">                    <font color="green">if</font> (!<a href="expression_c.html#1077">ExpressionParse</a>(Parser, &<a href="parse_c.html#570">CValue</a>))</a>
<a name="865">                        <a href="platform_c.html#134">ProgramFail</a>(Parser, "value required in <font color="green">return</font>");</a>
<a name="866">                    </a>
<a name="867">                    if (!<a href="parse_c.html#568">Parser</a>-&gtpc-&gtTopStackFrame) <font color="gray">/*<searched> return from top-level program? */</font></a>
<a name="868">                        <a href="platform_unix_c.html#135">PlatformExit</a>(Parser-&gtpc, <a href="expression_c.html#164">ExpressionCoerceInteger</a>(CValue));</a>
<a name="869">                    <font color="green">else</font></a>
<a name="870">                        <a href="expression_c.html#391">ExpressionAssign</a>(Parser, <a href="parse_c.html#568">Parser</a>-&gtpc-&gtTopStackFrame-&gtReturnValue, <a href="parse_c.html#570">CValue</a>, TRUE, NULL, 0, FALSE);</a>
<a name="871"></a>
<a name="872">                    <a href="variable_c.html#386">VariableStackPop</a>(Parser, <a href="parse_c.html#570">CValue</a>);</a>
<a name="873">                }</a>
<a name="874">                <font color="green">else</font></a>
<a name="875">                {</a>
<a name="876">                    <font color="green">if</font> (ExpressionParse(Parser, &<a href="parse_c.html#570">CValue</a>))</a>
<a name="877">                        <a href="platform_c.html#134">ProgramFail</a>(Parser, "value in <font color="green">return</font> from a <font color="red">void</font> function");                    </a>
<a name="878">                }</a>
<a name="879">                </a>
<a name="880">                <a href="parse_c.html#568">Parser</a>-&gtMode = RunModeReturn;</a>
<a name="881">            }</a>
<a name="882">            <font color="green">else</font></a>
<a name="883">                <a href="expression_c.html#1077">ExpressionParse</a>(Parser, &<a href="parse_c.html#570">CValue</a>);</a>
<a name="884">            break;</a>
<a name="885"></a>
<a name="886">        <font color="green">case</font> TokenTypedef:</a>
<a name="887">            <a href="parse_c.html#549">ParseTypedef</a>(Parser);</a>
<a name="888">            break;</a>
<a name="889">            </a>
<a name="890">        <font color="green">case</font> TokenGoto:</a>
<a name="891">            <font color="green">if</font> (LexGetToken(Parser, &<a href="parse_c.html#571">LexerValue</a>, TRUE) != TokenIdentifier)</a>
<a name="892">                <a href="platform_c.html#134">ProgramFail</a>(Parser, "identifier expected");</a>
<a name="893">            </a>
<a name="894">            <font color="green">if</font> (Parser-&gtMode == RunModeRun)</a>
<a name="895">            { </a>
<a name="896">                <font color="gray">/*<searched> start scanning for the goto label */</font></a>
<a name="897">                <a href="parse_c.html#568">Parser</a>-&gtSearchGotoLabel = <a href="parse_c.html#571">LexerValue</a>-&gtVal-&gtIdentifier;</a>
<a name="898">                <a href="parse_c.html#568">Parser</a>-&gtMode = RunModeGoto;</a>
<a name="899">            }</a>
<a name="900">            break;</a>
<a name="901">                </a>
<a name="902">        <font color="green">case</font> TokenDelete:</a>
<a name="903">        {</a>
<a name="904">            <font color="gray">/*<searched> try it as a function or variable name to delete */</font></a>
<a name="905">            <font color="green">if</font> (LexGetToken(Parser, &<a href="parse_c.html#571">LexerValue</a>, TRUE) != TokenIdentifier)</a>
<a name="906">                <a href="platform_c.html#134">ProgramFail</a>(Parser, "identifier expected");</a>
<a name="907">                </a>
<a name="908">            <font color="green">if</font> (Parser-&gtMode == RunModeRun)</a>
<a name="909">            { </a>
<a name="910">                <font color="gray">/*<searched> delete this variable or function */</font></a>
<a name="911">                <a href="parse_c.html#570">CValue</a> = <a href="table_c.html#101">TableDelete</a>(Parser-&gtpc, &<a href="parse_c.html#568">Parser</a>-&gtpc-&gtGlobalTable, <a href="parse_c.html#571">LexerValue</a>-&gtVal-&gtIdentifier);</a>
<a name="912"></a>
<a name="913">                <font color="green">if</font> (CValue == NULL)</a>
<a name="914">                    <a href="platform_c.html#134">ProgramFail</a>(Parser, "'%s' is not defined", <a href="parse_c.html#571">LexerValue</a>-&gtVal-&gtIdentifier);</a>
<a name="915">                </a>
<a name="916">                <a href="variable_c.html#19">VariableFree</a>(Parser-&gtpc, <a href="parse_c.html#570">CValue</a>);</a>
<a name="917">            }</a>
<a name="918">            break;</a>
<a name="919">        }</a>
<a name="920">        </a>
<a name="921">        default:</a>
<a name="922">            *Parser = <a href="parse_c.html#574">PreState</a>;</a>
<a name="923">            <font color="green">return</font> ParseResultError;</a>
<a name="924">    }</a>
<a name="925">    </a>
<a name="926">    <font color="green">if</font> (CheckTrailingSemicolon)</a>
<a name="927">    {</a>
<a name="928">        <font color="green">if</font> (LexGetToken(Parser, NULL, TRUE) != TokenSemicolon)</a>
<a name="929">            <a href="platform_c.html#134">ProgramFail</a>(Parser, "';' expected");</a>
<a name="930">    }</a>
<a name="931">    </a>
<a name="932">    <font color="green">return</font> ParseResultOk;</a>
<a name="933">}</a>
<a name="934"></a>
<a name="935"><font color="gray">/*<searched> quick scan a source file for definitions */</font></a>
<a name="936"><font color="red">void</font> <a name="searched">PicocParse</a>(Picoc *<a name="searched">pc</a>, const <font color="red">char</font> *<a name="searched">FileName</a>, const <font color="red">char</font> *Source, <font color="red">int</font> <a name="searched">SourceLen</a>, <font color="red">int</font> <a name="searched">RunIt</a>, <font color="red">int</font> <a name="searched">CleanupNow</a>, <font color="red">int</font> <a name="searched">CleanupSource</a>, <font color="red">int</font> <a name="searched">EnableDebugger</a>)</a>
<a name="937">{</a>
<a name="938">    <font color="brown">struct</font> ParseState <a name="searched">Parser</a>;</a>
<a name="939">    <font color="red">enum</font> ParseResult <a name="searched">Ok</a>;</a>
<a name="940">    <font color="brown">struct</font> CleanupTokenNode *<a name="searched">NewCleanupNode</a>;</a>
<a name="941">    <font color="red">char</font> *<a name="searched">RegFileName</a> = <a href="table_c.html#166">TableStrRegister</a>(pc, <a href="parse_c.html#936">FileName</a>);</a>
<a name="942">    </a>
<a name="943">    <font color="red">void</font> *<a name="searched">Tokens</a> = <a href="lex_c.html#593">LexAnalyse</a>(pc, <a href="parse_c.html#941">RegFileName</a>, Source, <a href="parse_c.html#936">SourceLen</a>, NULL);</a>
<a name="944">    </a>
<a name="945">    <font color="gray">/*<searched> allocate a cleanup node so we can clean up the tokens later */</font></a>
<a name="946">    <font color="green">if</font> (!<a href="parse_c.html#936">CleanupNow</a>)</a>
<a name="947">    {</a>
<a name="948">        <a href="parse_c.html#940">NewCleanupNode</a> = <a href="heap_c.html#135">HeapAllocMem</a>(pc, sizeof(<font color="brown">struct</font> CleanupTokenNode));</a>
<a name="949">        <font color="green">if</font> (NewCleanupNode == NULL)</a>
<a name="950">            <a href="platform_c.html#147">ProgramFailNoParser</a>(pc, "out of memory");</a>
<a name="951">        </a>
<a name="952">        <a href="parse_c.html#940">NewCleanupNode</a>-&gtTokens = <a href="parse_c.html#943">Tokens</a>;</a>
<a name="953">        <font color="green">if</font> (CleanupSource)</a>
<a name="954">            <a href="parse_c.html#940">NewCleanupNode</a>-&gtSourceText = <a href="parse_c.html#936">Source</a>;</a>
<a name="955">        <font color="green">else</font></a>
<a name="956">            <a href="parse_c.html#940">NewCleanupNode</a>-&gtSourceText = NULL;</a>
<a name="957">            </a>
<a name="958">        <a href="parse_c.html#940">NewCleanupNode</a>-&gtNext = <a href="parse_c.html#936">pc</a>-&gtCleanupTokenList;</a>
<a name="959">        <a href="parse_c.html#936">pc</a>-&gtCleanupTokenList = <a href="parse_c.html#940">NewCleanupNode</a>;</a>
<a name="960">    }</a>
<a name="961">    </a>
<a name="962">    <font color="gray">/*<searched> do the parsing */</font></a>
<a name="963">    <a href="lex_c.html#610">LexInitParser</a>(&<a href="parse_c.html#938">Parser</a>, <a href="parse_c.html#936">pc</a>, <a href="parse_c.html#936">Source</a>, <a href="parse_c.html#943">Tokens</a>, <a href="parse_c.html#941">RegFileName</a>, <a href="parse_c.html#936">RunIt</a>, <a href="parse_c.html#936">EnableDebugger</a>);</a>
<a name="964"></a>
<a name="965">    do {</a>
<a name="966">        <a href="parse_c.html#939">Ok</a> = <a href="parse_c.html#568">ParseStatement</a>(&<a href="parse_c.html#938">Parser</a>, TRUE);</a>
<a name="967">    } <font color="green">while</font> (Ok == ParseResultOk);</a>
<a name="968">    </a>
<a name="969">    <font color="green">if</font> (Ok == ParseResultError)</a>
<a name="970">        <a href="platform_c.html#134">ProgramFail</a>(&<a href="parse_c.html#938">Parser</a>, "parse error");</a>
<a name="971">    </a>
<a name="972">    <font color="gray">/*<searched> clean up */</font></a>
<a name="973">    <font color="green">if</font> (CleanupNow)</a>
<a name="974">        <a href="heap_c.html#226">HeapFreeMem</a>(pc, <a href="parse_c.html#943">Tokens</a>);</a>
<a name="975">}</a>
<a name="976"></a>
<a name="977"><font color="gray">/*<searched> parse interactively */</font></a>
<a name="978"><font color="red">void</font> <a name="searched">PicocParseInteractiveNoStartPrompt</a>(Picoc *<a name="searched">pc</a>, <font color="red">int</font> <a name="searched">EnableDebugger</a>)</a>
<a name="979">{</a>
<a name="980">    <font color="brown">struct</font> ParseState <a name="searched">Parser</a>;</a>
<a name="981">    <font color="red">enum</font> ParseResult <a name="searched">Ok</a>;</a>
<a name="982">    </a>
<a name="983">    <a href="lex_c.html#610">LexInitParser</a>(&<a href="parse_c.html#980">Parser</a>, <a href="parse_c.html#978">pc</a>, NULL, NULL, <a href="parse_c.html#978">pc</a>-&gtStrEmpty, TRUE, <a href="parse_c.html#978">EnableDebugger</a>);</a>
<a name="984">    PicocPlatformSetExitPoint(pc);</a>
<a name="985">    <a href="lex_c.html#995">LexInteractiveClear</a>(pc, &<a href="parse_c.html#980">Parser</a>);</a>
<a name="986"></a>
<a name="987">    do</a>
<a name="988">    {</a>
<a name="989">        <a href="lex_c.html#1034">LexInteractiveStatementPrompt</a>(pc);</a>
<a name="990">        <a href="parse_c.html#981">Ok</a> = <a href="parse_c.html#568">ParseStatement</a>(&<a href="parse_c.html#980">Parser</a>, TRUE);</a>
<a name="991">        <a href="lex_c.html#1013">LexInteractiveCompleted</a>(pc, &<a href="parse_c.html#980">Parser</a>);</a>
<a name="992">        </a>
<a name="993">    } <font color="green">while</font> (Ok == ParseResultOk);</a>
<a name="994">    </a>
<a name="995">    <font color="green">if</font> (Ok == ParseResultError)</a>
<a name="996">        <a href="platform_c.html#134">ProgramFail</a>(&<a href="parse_c.html#980">Parser</a>, "parse error");</a>
<a name="997">    </a>
<a name="998">    <a href="platform_c.html#192">PlatformPrintf</a>(pc-&gtCStdOut, "\n");</a>
<a name="999">}</a>
<a name="1000"></a>
<a name="1001"><font color="gray">/*<searched> parse interactively, showing a startup message */</font></a>
<a name="1002"><font color="red">void</font> <a name="searched">PicocParseInteractive</a>(Picoc *<a name="searched">pc</a>)</a>
<a name="1003">{</a>
<a name="1004">    <a href="platform_c.html#192">PlatformPrintf</a>(pc-&gtCStdOut, INTERACTIVE_PROMPT_START);</a>
<a name="1005">    <a href="parse_c.html#978">PicocParseInteractiveNoStartPrompt</a>(pc, TRUE);</a>
<a name="1006">}</a>
</pre></body></html>