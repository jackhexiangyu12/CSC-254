<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/></head>
<body><pre><a name="1"><font color="gray">/*<searched> picoc lexer - converts source text into a tokenised form */</font> </a>
<a name="2"></a>
<a name="3">#include "interpreter.h"</a>
<a name="4"></a>
<a name="5">#ifdef NO_CTYPE</a>
<a name="6">#define isalpha(c) (((c) &gt= 'a' && (c) &lt= 'z') || ((c) &gt= 'A' && (c) &lt= 'Z'))</a>
<a name="7">#define isdigit(c) ((c) &gt= '0' && (c) &lt= '9')</a>
<a name="8">#define isalnum(c) (isalpha(c) || isdigit(c))</a>
<a name="9">#define isspace(c) ((c) == ' ' || (c) == '\t' || (c) == '\r' || (c) == '\n')</a>
<a name="10">#endif</a>
<a name="11">#define isCidstart(c) (isalpha(c) || (c)=='_' || (c)=='#')</a>
<a name="12">#define isCident(c) (isalnum(c) || (c)=='_')</a>
<a name="13"></a>
<a name="14">#define IS_HEX_ALPHA_DIGIT(c) (((c) &gt= 'a' && (c) &lt= 'f') || ((c) &gt= 'A' && (c) &lt= 'F'))</a>
<a name="15">#define IS_BASE_DIGIT(c,b) (((c) &gt= '0' && (c) &lt '0' + (((b)&lt10)?(b):10)) || (((b) &gt 10) ? IS_HEX_ALPHA_DIGIT(c) : FALSE))</a>
<a name="16">#define GET_BASE_DIGIT(c) (((c) &lt= '9') ? ((c) - '0') : (((c) &lt= 'F') ? ((c) - 'A' + 10) : ((c) - 'a' + 10)))</a>
<a name="17"></a>
<a name="18">#define NEXTIS(c,x,y) { <font color="green">if</font> (NextChar == (c)) { LEXER_INC(Lexer); GotToken = (x); } <font color="green">else</font> GotToken = (y); }</a>
<a name="19">#define NEXTIS3(c,x,d,y,z) { <font color="green">if</font> (NextChar == (c)) { LEXER_INC(Lexer); GotToken = (x); } <font color="green">else</font> NEXTIS(d,y,z) }</a>
<a name="20">#define NEXTIS4(c,x,d,y,e,z,a) { <font color="green">if</font> (NextChar == (c)) { LEXER_INC(Lexer); GotToken = (x); } <font color="green">else</font> NEXTIS3(d,y,e,z,a) }</a>
<a name="21">#define NEXTIS3PLUS(c,x,d,y,e,z,a) { <font color="green">if</font> (NextChar == (c)) { LEXER_INC(Lexer); GotToken = (x); } <font color="green">else</font> <font color="green">if</font> (NextChar == (d)) { <font color="green">if</font> (Lexer-&gtPos[1] == (e)) { LEXER_INCN(Lexer, 2); GotToken = (z); } <font color="green">else</font> { LEXER_INC(Lexer); GotToken = (y); } } <font color="green">else</font> GotToken = (a); }</a>
<a name="22">#define NEXTISEXACTLY3(c,d,y,z) { <font color="green">if</font> (NextChar == (c) && Lexer-&gtPos[1] == (d)) { LEXER_INCN(Lexer, 2); GotToken = (y); } <font color="green">else</font> GotToken = (z); }</a>
<a name="23"></a>
<a name="24">#define LEXER_INC(l) ( (l)-&gtPos++, (l)-&gtCharacterPos++ )</a>
<a name="25">#define LEXER_INCN(l, n) ( (l)-&gtPos+=(n), (l)-&gtCharacterPos+=(n) )</a>
<a name="26">#define TOKEN_DATA_OFFSET 2</a>
<a name="27"></a>
<a name="28">#define MAX_CHAR_VALUE 255      <font color="gray">/*<searched> maximum value which can be represented by a "char" data type */</font></a>
<a name="29"></a>
<a name="30"></a>
<a name="31"><font color="brown">struct</font> ReservedWord</a>
<a name="32">{</a>
<a name="33">    const <font color="red">char</font> *Word;</a>
<a name="34">    <font color="red">enum</font> LexToken Token;</a>
<a name="35">};</a>
<a name="36"></a>
<a name="37">static <font color="brown">struct</font> ReservedWord <a name="searched">ReservedWords</a>[] =</a>
<a name="38">{</a>
<a name="39">    { "#define", TokenHashDefine },</a>
<a name="40">    { "#<font color="green">else</font>", TokenHashElse },</a>
<a name="41">    { "#endif", TokenHashEndif },</a>
<a name="42">    { "#if", TokenHashIf },</a>
<a name="43">    { "#ifdef", TokenHashIfdef },</a>
<a name="44">    { "#ifndef", TokenHashIfndef },</a>
<a name="45">    { "#include", TokenHashInclude },</a>
<a name="46">    { "auto", TokenAutoType },</a>
<a name="47">    { "break", TokenBreak },</a>
<a name="48">    { "<font color="green">case</font>", TokenCase },</a>
<a name="49">    { "<font color="red">char</font>", TokenCharType },</a>
<a name="50">    { "continue", TokenContinue },</a>
<a name="51">    { "default", TokenDefault },</a>
<a name="52">    { "delete", TokenDelete },</a>
<a name="53">    { "do", TokenDo },</a>
<a name="54">#ifndef NO_FP</a>
<a name="55">    { "<font color="red">double</font>", TokenDoubleType },</a>
<a name="56">#endif</a>
<a name="57">    { "<font color="green">else</font>", TokenElse },</a>
<a name="58">    { "<font color="red">enum</font>", TokenEnumType },</a>
<a name="59">    { "extern", TokenExternType },</a>
<a name="60">#ifndef NO_FP</a>
<a name="61">    { "<font color="red">float</font>", TokenFloatType },</a>
<a name="62">#endif</a>
<a name="63">    { "<font color="green">for</font>", TokenFor },</a>
<a name="64">    { "<font color="green">goto</font>", TokenGoto },</a>
<a name="65">    { "if", TokenIf },</a>
<a name="66">    { "<font color="red">int</font>", TokenIntType },</a>
<a name="67">    { "<font color="red">long</font>", TokenLongType },</a>
<a name="68">    { "new", TokenNew },</a>
<a name="69">    { "register", TokenRegisterType },</a>
<a name="70">    { "<font color="green">return</font>", TokenReturn },</a>
<a name="71">    { "<font color="red">short</font>", TokenShortType },</a>
<a name="72">    { "signed", TokenSignedType },</a>
<a name="73">    { "sizeof", TokenSizeof },</a>
<a name="74">    { "static", TokenStaticType },</a>
<a name="75">    { "<font color="brown">struct</font>", TokenStructType },</a>
<a name="76">    { "<font color="green">switch</font>", TokenSwitch },</a>
<a name="77">    { "<font color="brown">typedef</font>", TokenTypedef },</a>
<a name="78">    { "union", TokenUnionType },</a>
<a name="79">    { "<font color="red">unsigned</font>", TokenUnsignedType },</a>
<a name="80">    { "<font color="red">void</font>", TokenVoidType },</a>
<a name="81">    { "<font color="green">while</font>", TokenWhile }</a>
<a name="82">};</a>
<a name="83"></a>
<a name="84"></a>
<a name="85"></a>
<a name="86"><font color="gray">/*<searched> initialise the lexer */</font></a>
<a name="87"><font color="red">void</font> <a name="searched">LexInit</a>(Picoc *<a name="searched">pc</a>)</a>
<a name="88">{</a>
<a name="89">    <font color="red">int</font> <a name="searched">Count</a>;</a>
<a name="90">    </a>
<a name="91">    <a href="table_c.html#32">TableInitTable</a>(&<a href="lex_c.html#87">pc</a>-&gtReservedWordTable, &<a href="lex_c.html#87">pc</a>-&gtReservedWordHashTable[0], sizeof(ReservedWords) / sizeof(<font color="brown">struct</font> ReservedWord) * 2, TRUE);</a>
<a name="92"></a>
<a name="93">    <font color="green">for</font> (Count = 0; <a href="lex_c.html#89">Count</a> &lt sizeof(ReservedWords) / sizeof(<font color="brown">struct</font> ReservedWord); <a href="lex_c.html#89">Count</a>++)</a>
<a name="94">    {</a>
<a name="95">        <a href="table_c.html#58">TableSet</a>(pc, &<a href="lex_c.html#87">pc</a>-&gtReservedWordTable, <a href="table_c.html#166">TableStrRegister</a>(pc, <a href="lex_c.html#37">ReservedWords</a>[<a href="lex_c.html#89">Count</a>].Word), (<font color="brown">struct</font> Value *)&<a href="lex_c.html#37">ReservedWords</a>[<a href="lex_c.html#89">Count</a>], NULL, 0, 0);</a>
<a name="96">    }</a>
<a name="97">    </a>
<a name="98">    <a href="lex_c.html#87">pc</a>-&gtLexValue.Typ = NULL;</a>
<a name="99">    <a href="lex_c.html#87">pc</a>-&gtLexValue.Val = &<a href="lex_c.html#87">pc</a>-&gtLexAnyValue;</a>
<a name="100">    <a href="lex_c.html#87">pc</a>-&gtLexValue.LValueFrom = FALSE;</a>
<a name="101">    <a href="lex_c.html#87">pc</a>-&gtLexValue.ValOnHeap = FALSE;</a>
<a name="102">    <a href="lex_c.html#87">pc</a>-&gtLexValue.ValOnStack = FALSE;</a>
<a name="103">    <a href="lex_c.html#87">pc</a>-&gtLexValue.AnyValOnHeap = FALSE;</a>
<a name="104">    <a href="lex_c.html#87">pc</a>-&gtLexValue.IsLValue = FALSE;</a>
<a name="105">}</a>
<a name="106"></a>
<a name="107"><font color="gray">/*<searched> deallocate */</font></a>
<a name="108"><font color="red">void</font> <a name="searched">LexCleanup</a>(Picoc *<a name="searched">pc</a>)</a>
<a name="109">{</a>
<a name="110">    <font color="red">int</font> <a name="searched">Count</a>;</a>
<a name="111"></a>
<a name="112">    <a href="lex_c.html#995">LexInteractiveClear</a>(pc, NULL);</a>
<a name="113"></a>
<a name="114">    <font color="green">for</font> (Count = 0; <a href="lex_c.html#110">Count</a> &lt sizeof(ReservedWords) / sizeof(<font color="brown">struct</font> ReservedWord); <a href="lex_c.html#110">Count</a>++)</a>
<a name="115">        <a href="table_c.html#101">TableDelete</a>(pc, &<a href="lex_c.html#108">pc</a>-&gtReservedWordTable, <a href="table_c.html#166">TableStrRegister</a>(pc, <a href="lex_c.html#37">ReservedWords</a>[<a href="lex_c.html#110">Count</a>].Word));</a>
<a name="116">}</a>
<a name="117"></a>
<a name="118"><font color="gray">/*<searched> check if a word is a reserved word - used while scanning */</font></a>
<a name="119"><font color="red">enum</font> LexToken LexCheckReserved<a name="searched">Word</a>(Picoc *<a name="searched">pc</a>, const <font color="red">char</font> *<a name="searched">Word</a>)</a>
<a name="120">{</a>
<a name="121">    <font color="brown">struct</font> Value *<a name="searched">val</a>;</a>
<a name="122">    </a>
<a name="123">    <font color="green">if</font> (TableGet(&<a href="lex_c.html#119">pc</a>-&gtReservedWordTable, <a href="lex_c.html#119">Word</a>, &<a href="lex_c.html#121">val</a>, NULL, NULL, NULL))</a>
<a name="124">        <font color="green">return</font> ((<font color="brown">struct</font> ReservedWord *)val)-&gtToken;</a>
<a name="125">    <font color="green">else</font></a>
<a name="126">        <font color="green">return</font> TokenNone;</a>
<a name="127">}</a>
<a name="128"></a>
<a name="129"><font color="gray">/*<searched> get a numeric literal - used while scanning */</font></a>
<a name="130"><font color="red">enum</font> LexToken <a name="searched">LexGetNumber</a>(Picoc *<a name="searched">pc</a>, <font color="brown">struct</font> LexState *<a name="searched">Lexer</a>, <font color="brown">struct</font> <a name="searched">Value</a> *<a name="searched">Value</a>)</a>
<a name="131">{</a>
<a name="132">    <font color="red">long</font> <a name="searched">Result</a> = 0;</a>
<a name="133">    <font color="red">long</font> <a name="searched">Base</a> = 10;</a>
<a name="134">    <font color="red">enum</font> LexToken <a name="searched">ResultToken</a>;</a>
<a name="135">#ifndef NO_FP</a>
<a name="136">    <font color="red">double</font> <a name="searched">FPResult</a>;</a>
<a name="137">    <font color="red">double</font> <a name="searched">FPDiv</a>;</a>
<a name="138">#endif</a>
<a name="139">    <font color="gray">/*<searched> long/unsigned flags */</font></a>
<a name="140">#if 0 <font color="gray">/*<searched> unused for now */</font></a>
<a name="141">    <font color="red">char</font> IsLong = 0;</a>
<a name="142">    <font color="red">char</font> IsUnsigned = 0;</a>
<a name="143">#endif</a>
<a name="144">    </a>
<a name="145">    <font color="green">if</font> (*Lexer-&gtPos == '0')</a>
<a name="146">    { </a>
<a name="147">        <font color="gray">/*<searched> a binary, octal or hex literal */</font></a>
<a name="148">        LEXER_INC(Lexer);</a>
<a name="149">        <font color="green">if</font> (Lexer-&gtPos != <a href="lex_c.html#130">Lexer</a>-&gtEnd)</a>
<a name="150">        {</a>
<a name="151">            <font color="green">if</font> (*Lexer-&gtPos == 'x' || *Lexer-&gtPos == 'X')</a>
<a name="152">                { <a href="lex_c.html#133">Base</a> = 16; LEXER_INC(Lexer); }</a>
<a name="153">            <font color="green">else</font> <font color="green">if</font> (*Lexer-&gtPos == 'b' || *Lexer-&gtPos == 'B')</a>
<a name="154">                { <a href="lex_c.html#133">Base</a> = 2; LEXER_INC(Lexer); }</a>
<a name="155">            <font color="green">else</font> <font color="green">if</font> (*Lexer-&gtPos != '.')</a>
<a name="156">                <a href="lex_c.html#133">Base</a> = 8;</a>
<a name="157">        }</a>
<a name="158">    }</a>
<a name="159"></a>
<a name="160">    <font color="gray">/*<searched> get the value */</font></a>
<a name="161">    <font color="green">for</font> (; <a href="lex_c.html#130">Lexer</a>-&gtPos != <a href="lex_c.html#130">Lexer</a>-&gtEnd && IS_BASE_DIGIT(*Lexer-&gtPos, <a href="lex_c.html#133">Base</a>); LEXER_INC(Lexer))</a>
<a name="162">        <a href="lex_c.html#132">Result</a> = <a href="lex_c.html#132">Result</a> * <a href="lex_c.html#133">Base</a> + GET_BASE_DIGIT(*Lexer-&gtPos);</a>
<a name="163"></a>
<a name="164">    <font color="green">if</font> (*Lexer-&gtPos == 'u' || *Lexer-&gtPos == 'U')</a>
<a name="165">    {</a>
<a name="166">        LEXER_INC(Lexer);</a>
<a name="167">        <font color="gray">/*<searched> IsUnsigned = 1; */</font></a>
<a name="168">    }</a>
<a name="169">    <font color="green">if</font> (*Lexer-&gtPos == 'l' || *Lexer-&gtPos == 'L')</a>
<a name="170">    {</a>
<a name="171">        LEXER_INC(Lexer);</a>
<a name="172">        <font color="gray">/*<searched> IsLong = 1; */</font></a>
<a name="173">    }</a>
<a name="174">    </a>
<a name="175">    <a href="lex_c.html#130">Value</a>-&gtTyp = &<a href="lex_c.html#130">pc</a>-&gtLongType; <font color="gray">/*<searched> ignored? */</font></a>
<a name="176">    <a href="lex_c.html#130">Value</a>-&gtVal-&gtLongInteger = <a href="lex_c.html#132">Result</a>;</a>
<a name="177"></a>
<a name="178">    <a href="lex_c.html#134">ResultToken</a> = TokenIntegerConstant;</a>
<a name="179">    </a>
<a name="180">    <font color="green">if</font> (Lexer-&gtPos == <a href="lex_c.html#130">Lexer</a>-&gtEnd)</a>
<a name="181">        <font color="green">return</font> <a href="lex_c.html#134">ResultToken</a>;</a>
<a name="182">        </a>
<a name="183">#ifndef NO_FP</a>
<a name="184">    <font color="green">if</font> (Lexer-&gtPos == <a href="lex_c.html#130">Lexer</a>-&gtEnd)</a>
<a name="185">    {</a>
<a name="186">        <font color="green">return</font> <a href="lex_c.html#134">ResultToken</a>;</a>
<a name="187">    }</a>
<a name="188">    </a>
<a name="189">    <font color="green">if</font> (*Lexer-&gtPos != '.' && *Lexer-&gtPos != 'e' && *Lexer-&gtPos != 'E')</a>
<a name="190">    {</a>
<a name="191">        <font color="green">return</font> <a href="lex_c.html#134">ResultToken</a>;</a>
<a name="192">    }</a>
<a name="193">    </a>
<a name="194">    <a href="lex_c.html#130">Value</a>-&gtTyp = &<a href="lex_c.html#130">pc</a>-&gtFPType;</a>
<a name="195">    <a href="lex_c.html#136">FPResult</a> = (<font color="red">double</font>)Result;</a>
<a name="196">    </a>
<a name="197">    <font color="green">if</font> (*Lexer-&gtPos == '.')</a>
<a name="198">    {</a>
<a name="199">        LEXER_INC(Lexer);</a>
<a name="200">        <font color="green">for</font> (FPDiv = 1.0/Base; <a href="lex_c.html#130">Lexer</a>-&gtPos != <a href="lex_c.html#130">Lexer</a>-&gtEnd && IS_BASE_DIGIT(*Lexer-&gtPos, <a href="lex_c.html#133">Base</a>); LEXER_INC(Lexer), <a href="lex_c.html#137">FPDiv</a> /= (<font color="red">double</font>)Base)</a>
<a name="201">        {</a>
<a name="202">            <a href="lex_c.html#136">FPResult</a> += GET_BASE_DIGIT(*Lexer-&gtPos) * <a href="lex_c.html#137">FPDiv</a>;</a>
<a name="203">        }</a>
<a name="204">    }</a>
<a name="205"></a>
<a name="206">    <font color="green">if</font> (Lexer-&gtPos != <a href="lex_c.html#130">Lexer</a>-&gtEnd && (*Lexer-&gtPos == 'e' || *Lexer-&gtPos == 'E'))</a>
<a name="207">    {</a>
<a name="208">        <font color="red">int</font> <a name="searched">ExponentSign</a> = 1;</a>
<a name="209">        </a>
<a name="210">        LEXER_INC(Lexer);</a>
<a name="211">        <font color="green">if</font> (Lexer-&gtPos != <a href="lex_c.html#130">Lexer</a>-&gtEnd && *Lexer-&gtPos == '-')</a>
<a name="212">        {</a>
<a name="213">            <a href="lex_c.html#208">ExponentSign</a> = -1;</a>
<a name="214">            LEXER_INC(Lexer);</a>
<a name="215">        }</a>
<a name="216">        </a>
<a name="217">        <a href="lex_c.html#132">Result</a> = 0;</a>
<a name="218">        <font color="green">while</font> (Lexer-&gtPos != <a href="lex_c.html#130">Lexer</a>-&gtEnd && IS_BASE_DIGIT(*Lexer-&gtPos, <a href="lex_c.html#133">Base</a>))</a>
<a name="219">        {</a>
<a name="220">            <a href="lex_c.html#132">Result</a> = <a href="lex_c.html#132">Result</a> * <a href="lex_c.html#133">Base</a> + GET_BASE_DIGIT(*Lexer-&gtPos);</a>
<a name="221">            LEXER_INC(Lexer);</a>
<a name="222">        }</a>
<a name="223"></a>
<a name="224">        <a href="lex_c.html#136">FPResult</a> *= pow((<font color="red">double</font>)Base, (<font color="red">double</font>)Result * <a href="lex_c.html#208">ExponentSign</a>);</a>
<a name="225">    }</a>
<a name="226">    </a>
<a name="227">    <a href="lex_c.html#130">Value</a>-&gtVal-&gtFP = <a href="lex_c.html#136">FPResult</a>;</a>
<a name="228"></a>
<a name="229">    <font color="green">if</font> (*Lexer-&gtPos == 'f' || *Lexer-&gtPos == 'F')</a>
<a name="230">        LEXER_INC(Lexer);</a>
<a name="231"></a>
<a name="232">    <font color="green">return</font> TokenFPConstant;</a>
<a name="233">#<font color="green">else</font></a>
<a name="234">    <font color="green">return</font> <a href="lex_c.html#134">ResultToken</a>;</a>
<a name="235">#endif</a>
<a name="236">}</a>
<a name="237"></a>
<a name="238"><font color="gray">/*<searched> get a reserved word or identifier - used while scanning */</font></a>
<a name="239"><font color="red">enum</font> LexToken <a name="searched">LexGetWord</a>(Picoc *<a name="searched">pc</a>, <font color="brown">struct</font> LexState *<a name="searched">Lexer</a>, <font color="brown">struct</font> <a name="searched">Value</a> *<a name="searched">Value</a>)</a>
<a name="240">{</a>
<a name="241">    const <font color="red">char</font> *<a name="searched">StartPos</a> = <a href="lex_c.html#239">Lexer</a>-&gtPos;</a>
<a name="242">    <font color="red">enum</font> Lex<a name="searched">Token</a> <a name="searched">Token</a>;</a>
<a name="243">    </a>
<a name="244">    do {</a>
<a name="245">        LEXER_INC(Lexer);</a>
<a name="246">    } <font color="green">while</font> (Lexer-&gtPos != <a href="lex_c.html#239">Lexer</a>-&gtEnd && isCident((<font color="red">int</font>)*Lexer-&gtPos));</a>
<a name="247">    </a>
<a name="248">    <a href="lex_c.html#239">Value</a>-&gtTyp = NULL;</a>
<a name="249">    <a href="lex_c.html#239">Value</a>-&gtVal-&gtIdentifier = <a href="table_c.html#161">TableStrRegister2</a>(pc, <a href="lex_c.html#241">StartPos</a>, <a href="lex_c.html#239">Lexer</a>-&gtPos - <a href="lex_c.html#241">StartPos</a>);</a>
<a name="250">    </a>
<a name="251">    <a href="lex_c.html#242">Token</a> = <a href="lex_c.html#119">LexCheckReservedWord</a>(pc, <a href="lex_c.html#239">Value</a>-&gtVal-&gtIdentifier);</a>
<a name="252">    <font color="green">switch</font> (Token)</a>
<a name="253">    {</a>
<a name="254">        <font color="green">case</font> TokenHashInclude: <a href="lex_c.html#239">Lexer</a>-&gtMode = LexModeHashInclude; break;</a>
<a name="255">        <font color="green">case</font> TokenHashDefine: <a href="lex_c.html#239">Lexer</a>-&gtMode = LexModeHashDefine; break;</a>
<a name="256">        default: break;</a>
<a name="257">    }</a>
<a name="258">        </a>
<a name="259">    <font color="green">if</font> (Token != TokenNone)</a>
<a name="260">        <font color="green">return</font> <a href="lex_c.html#242">Token</a>;</a>
<a name="261">    </a>
<a name="262">    <font color="green">if</font> (Lexer-&gtMode == LexModeHashDefineSpace)</a>
<a name="263">        <a href="lex_c.html#239">Lexer</a>-&gtMode = LexModeHashDefineSpaceIdent;</a>
<a name="264">    </a>
<a name="265">    <font color="green">return</font> TokenIdentifier;</a>
<a name="266">}</a>
<a name="267"></a>
<a name="268"><font color="gray">/*<searched> unescape a character from an octal character constant */</font></a>
<a name="269"><font color="red">unsigned</font> <font color="red">char</font> <a name="searched">LexUnEscapeCharacterConstant</a>(const <font color="red">char</font> **<a name="searched">From</a>, const <font color="red">char</font> *<a name="searched">End</a>, <font color="red">unsigned</font> <font color="red">char</font> <a name="searched">FirstChar</a>, <font color="red">int</font> <a name="searched">Base</a>)</a>
<a name="270">{</a>
<a name="271">    <font color="red">unsigned</font> <font color="red">char</font> <a name="searched">Total</a> = GET_BASE_DIGIT(FirstChar);</a>
<a name="272">    <font color="red">int</font> <a name="searched">CCount</a>;</a>
<a name="273">    <font color="green">for</font> (CCount = 0; IS_BASE_DIGIT(**From, <a href="lex_c.html#269">Base</a>) && <a href="lex_c.html#272">CCount</a> &lt 2; <a href="lex_c.html#272">CCount</a>++, (*From)++)</a>
<a name="274">        <a href="lex_c.html#271">Total</a> = <a href="lex_c.html#271">Total</a> * <a href="lex_c.html#269">Base</a> + GET_BASE_DIGIT(**From);</a>
<a name="275">    </a>
<a name="276">    <font color="green">return</font> <a href="lex_c.html#271">Total</a>;</a>
<a name="277">}</a>
<a name="278"></a>
<a name="279"><font color="gray">/*<searched> unescape a character from a string or character constant */</font></a>
<a name="280"><font color="red">unsigned</font> <font color="red">char</font> <a name="searched">LexUnEscapeCharacter</a>(const <font color="red">char</font> **<a name="searched">From</a>, const <font color="red">char</font> *<a name="searched">End</a>)</a>
<a name="281">{</a>
<a name="282">    <font color="red">unsigned</font> <font color="red">char</font> <a name="searched">ThisChar</a>;</a>
<a name="283">    </a>
<a name="284">    <font color="green">while</font> ( *From != <a href="lex_c.html#280">End</a> && **From == '\\' && </a>
<a name="285">            &(*From)[1] != <a href="lex_c.html#280">End</a> && (*From)[1] == '\n' )</a>
<a name="286">        (*From) += 2;       <font color="gray">/*<searched> skip escaped end of lines with LF line termination */</font></a>
<a name="287">    </a>
<a name="288">    <font color="green">while</font> ( *From != <a href="lex_c.html#280">End</a> && **From == '\\' && </a>
<a name="289">            &(*From)[1] != <a href="lex_c.html#280">End</a> && &(*From)[2] != <a href="lex_c.html#280">End</a> && (*From)[1] == '\r' && (*From)[2] == '\n')</a>
<a name="290">        (*From) += 3;       <font color="gray">/*<searched> skip escaped end of lines with CR/LF line termination */</font></a>
<a name="291">    </a>
<a name="292">    <font color="green">if</font> (*From == <a href="lex_c.html#280">End</a>)</a>
<a name="293">        <font color="green">return</font> '\\';</a>
<a name="294">    </a>
<a name="295">    <font color="green">if</font> (**From == '\\')</a>
<a name="296">    { </a>
<a name="297">        <font color="gray">/*<searched> it's escaped */</font></a>
<a name="298">        (*From)++;</a>
<a name="299">        <font color="green">if</font> (*From == <a href="lex_c.html#280">End</a>)</a>
<a name="300">            <font color="green">return</font> '\\';</a>
<a name="301">        </a>
<a name="302">        <a href="lex_c.html#282">ThisChar</a> = *(*From)++;</a>
<a name="303">        <font color="green">switch</font> (ThisChar)</a>
<a name="304">        {</a>
<a name="305">            <font color="green">case</font> '\\': <font color="green">return</font> '\\'; </a>
<a name="306">            <font color="green">case</font> '\'': <font color="green">return</font> '\'';</a>
<a name="307">            <font color="green">case</font> '"':  <font color="green">return</font> '"';</a>
<a name="308">            <font color="green">case</font> 'a':  <font color="green">return</font> '\a';</a>
<a name="309">            <font color="green">case</font> 'b':  <font color="green">return</font> '\b';</a>
<a name="310">            <font color="green">case</font> 'f':  <font color="green">return</font> '\f';</a>
<a name="311">            <font color="green">case</font> 'n':  <font color="green">return</font> '\n';</a>
<a name="312">            <font color="green">case</font> 'r':  <font color="green">return</font> '\r';</a>
<a name="313">            <font color="green">case</font> 't':  <font color="green">return</font> '\t';</a>
<a name="314">            <font color="green">case</font> 'v':  <font color="green">return</font> '\v';</a>
<a name="315">            <font color="green">case</font> '0': <font color="green">case</font> '1': <font color="green">case</font> '2': <font color="green">case</font> '3': <font color="green">return</font> <a href="lex_c.html#269">LexUnEscapeCharacterConstant</a>(From, <a href="lex_c.html#280">End</a>, <a href="lex_c.html#282">ThisChar</a>, 8);</a>
<a name="316">            <font color="green">case</font> 'x': <font color="green">return</font> <a href="lex_c.html#269">LexUnEscapeCharacterConstant</a>(From, <a href="lex_c.html#280">End</a>, '0', 16);</a>
<a name="317">            default:   <font color="green">return</font> <a href="lex_c.html#282">ThisChar</a>;</a>
<a name="318">        }</a>
<a name="319">    }</a>
<a name="320">    <font color="green">else</font></a>
<a name="321">        <font color="green">return</font> *(*From)++;</a>
<a name="322">}</a>
<a name="323"></a>
<a name="324"><font color="gray">/*<searched> get a string constant - used while scanning */</font></a>
<a name="325"><font color="red">enum</font> LexToken <a name="searched">LexGetStringConstant</a>(Picoc *<a name="searched">pc</a>, <font color="brown">struct</font> LexState *<a name="searched">Lexer</a>, <font color="brown">struct</font> <a name="searched">Value</a> *<a name="searched">Value</a>, <font color="red">char</font> <a name="searched">EndChar</a>)</a>
<a name="326">{</a>
<a name="327">    <font color="red">int</font> <a name="searched">Escape</a> = FALSE;</a>
<a name="328">    const <font color="red">char</font> *<a name="searched">StartPos</a> = <a href="lex_c.html#325">Lexer</a>-&gtPos;</a>
<a name="329">    const <font color="red">char</font> *<a name="searched">EndPos</a>;</a>
<a name="330">    <font color="red">char</font> *<a name="searched">EscBuf</a>;</a>
<a name="331">    <font color="red">char</font> *<a name="searched">EscBufPos</a>;</a>
<a name="332">    <font color="red">char</font> *<a name="searched">RegString</a>;</a>
<a name="333">    <font color="brown">struct</font> <a href="lex_c.html#325">Value</a> *<a name="searched">ArrayValue</a>;</a>
<a name="334">    </a>
<a name="335">    <font color="green">while</font> (Lexer-&gtPos != <a href="lex_c.html#325">Lexer</a>-&gtEnd && (*Lexer-&gtPos != <a href="lex_c.html#325">EndChar</a> || <a href="lex_c.html#327">Escape</a>))</a>
<a name="336">    { </a>
<a name="337">        <font color="gray">/*<searched> find the end */</font></a>
<a name="338">        <font color="green">if</font> (Escape)</a>
<a name="339">        {</a>
<a name="340">            <font color="green">if</font> (*Lexer-&gtPos == '\r' && <a href="lex_c.html#325">Lexer</a>-&gtPos+1 != <a href="lex_c.html#325">Lexer</a>-&gtEnd)</a>
<a name="341">                <a href="lex_c.html#325">Lexer</a>-&gtPos++;</a>
<a name="342">            </a>
<a name="343">            <font color="green">if</font> (*Lexer-&gtPos == '\n' && <a href="lex_c.html#325">Lexer</a>-&gtPos+1 != <a href="lex_c.html#325">Lexer</a>-&gtEnd)</a>
<a name="344">            {</a>
<a name="345">                <a href="lex_c.html#325">Lexer</a>-&gtLine++;</a>
<a name="346">                <a href="lex_c.html#325">Lexer</a>-&gtPos++;</a>
<a name="347">                <a href="lex_c.html#325">Lexer</a>-&gtCharacterPos = 0;</a>
<a name="348">                <a href="lex_c.html#325">Lexer</a>-&gtEmitExtraNewlines++;</a>
<a name="349">            }</a>
<a name="350">            </a>
<a name="351">            <a href="lex_c.html#327">Escape</a> = FALSE;</a>
<a name="352">        }</a>
<a name="353">        <font color="green">else</font> <font color="green">if</font> (*Lexer-&gtPos == '\\')</a>
<a name="354">            <a href="lex_c.html#327">Escape</a> = TRUE;</a>
<a name="355">            </a>
<a name="356">        LEXER_INC(Lexer);</a>
<a name="357">    }</a>
<a name="358">    <a href="lex_c.html#329">EndPos</a> = <a href="lex_c.html#325">Lexer</a>-&gtPos;</a>
<a name="359">    </a>
<a name="360">    <a href="lex_c.html#330">EscBuf</a> = <a href="heap_c.html#67">HeapAllocStack</a>(pc, <a href="lex_c.html#329">EndPos</a> - <a href="lex_c.html#328">StartPos</a>);</a>
<a name="361">    <font color="green">if</font> (EscBuf == NULL)</a>
<a name="362">        <a href="platform_c.html#179">LexFail</a>(pc, <a href="lex_c.html#325">Lexer</a>, "out of memory");</a>
<a name="363">    </a>
<a name="364">    <font color="green">for</font> (EscBufPos = <a href="lex_c.html#330">EscBuf</a>, <a href="lex_c.html#325">Lexer</a>-&gtPos = <a href="lex_c.html#328">StartPos</a>; <a href="lex_c.html#325">Lexer</a>-&gtPos != <a href="lex_c.html#329">EndPos</a>;)</a>
<a name="365">        *EscBufPos++ = <a href="lex_c.html#280">LexUnEscapeCharacter</a>(&<a href="lex_c.html#325">Lexer</a>-&gtPos, <a href="lex_c.html#329">EndPos</a>);</a>
<a name="366">    </a>
<a name="367">    <font color="gray">/*<searched> try to find an existing copy of this string literal */</font></a>
<a name="368">    <a href="lex_c.html#332">RegString</a> = <a href="table_c.html#161">TableStrRegister2</a>(pc, <a href="lex_c.html#330">EscBuf</a>, <a href="lex_c.html#331">EscBufPos</a> - <a href="lex_c.html#330">EscBuf</a>);</a>
<a name="369">    <a href="heap_c.html#92">HeapPopStack</a>(pc, <a href="lex_c.html#330">EscBuf</a>, <a href="lex_c.html#329">EndPos</a> - <a href="lex_c.html#328">StartPos</a>);</a>
<a name="370">    <a href="lex_c.html#333">ArrayValue</a> = <a href="variable_c.html#441">VariableStringLiteralGet</a>(pc, <a href="lex_c.html#332">RegString</a>);</a>
<a name="371">    <font color="green">if</font> (ArrayValue == NULL)</a>
<a name="372">    {</a>
<a name="373">        <font color="gray">/*<searched> create and store this string literal */</font></a>
<a name="374">        <a href="lex_c.html#333">ArrayValue</a> = <a href="variable_c.html#89">VariableAllocValueAndData</a>(pc, NULL, 0, FALSE, NULL, TRUE);</a>
<a name="375">        <a href="lex_c.html#333">ArrayValue</a>-&gtTyp = <a href="lex_c.html#325">pc</a>-&gtCharArrayType;</a>
<a name="376">        <a href="lex_c.html#333">ArrayValue</a>-&gtVal = (union AnyValue *)RegString;</a>
<a name="377">        <a href="variable_c.html#452">VariableStringLiteralDefine</a>(pc, <a href="lex_c.html#332">RegString</a>, <a href="lex_c.html#333">ArrayValue</a>);</a>
<a name="378">    }</a>
<a name="379"></a>
<a name="380">    <font color="gray">/*<searched> create the the pointer for this char* */</font></a>
<a name="381">    <a href="lex_c.html#325">Value</a>-&gtTyp = <a href="lex_c.html#325">pc</a>-&gtCharPtrType;</a>
<a name="382">    <a href="lex_c.html#325">Value</a>-&gtVal-&gtPointer = <a href="lex_c.html#332">RegString</a>;</a>
<a name="383">    <font color="green">if</font> (*Lexer-&gtPos == <a href="lex_c.html#325">EndChar</a>)</a>
<a name="384">        LEXER_INC(Lexer);</a>
<a name="385">    </a>
<a name="386">    <font color="green">return</font> TokenStringConstant;</a>
<a name="387">}</a>
<a name="388"></a>
<a name="389"><font color="gray">/*<searched> get a character constant - used while scanning */</font></a>
<a name="390"><font color="red">enum</font> LexToken <a name="searched">LexGetCharacterConstant</a>(Picoc *<a name="searched">pc</a>, <font color="brown">struct</font> LexState *<a name="searched">Lexer</a>, <font color="brown">struct</font> <a name="searched">Value</a> *<a name="searched">Value</a>)</a>
<a name="391">{</a>
<a name="392">    <a href="lex_c.html#390">Value</a>-&gtTyp = &<a href="lex_c.html#390">pc</a>-&gtCharType;</a>
<a name="393">    <a href="lex_c.html#390">Value</a>-&gtVal-&gtCharacter = <a href="lex_c.html#280">LexUnEscapeCharacter</a>(&<a href="lex_c.html#390">Lexer</a>-&gtPos, <a href="lex_c.html#390">Lexer</a>-&gtEnd);</a>
<a name="394">    <font color="green">if</font> (Lexer-&gtPos != <a href="lex_c.html#390">Lexer</a>-&gtEnd && *Lexer-&gtPos != '\'')</a>
<a name="395">        <a href="platform_c.html#179">LexFail</a>(pc, <a href="lex_c.html#390">Lexer</a>, "expected \"'\"");</a>
<a name="396">        </a>
<a name="397">    LEXER_INC(Lexer);</a>
<a name="398">    <font color="green">return</font> TokenCharacterConstant;</a>
<a name="399">}</a>
<a name="400"></a>
<a name="401"><font color="gray">/*<searched> skip a comment - used while scanning */</font></a>
<a name="402"><font color="red">void</font> <a name="searched">LexSkipComment</a>(<font color="brown">struct</font> LexState *<a name="searched">Lexer</a>, <font color="red">char</font> <a name="searched">NextChar</a>, <font color="red">enum</font> LexToken *<a name="searched">ReturnToken</a>)</a>
<a name="403">{</a>
<a name="404">    <font color="green">if</font> (NextChar == '*')</a>
<a name="405">    {   </a>
<a name="406">        <font color="gray">/*<searched> conventional C comment */</font></a>
<a name="407">        <font color="green">while</font> (Lexer-&gtPos != <a href="lex_c.html#402">Lexer</a>-&gtEnd && (*(Lexer-&gtPos-1) != '*' || *Lexer-&gtPos != '/'))</a>
<a name="408">        {</a>
<a name="409">            <font color="green">if</font> (*Lexer-&gtPos == '\n')</a>
<a name="410">                <a href="lex_c.html#402">Lexer</a>-&gtEmitExtraNewlines++;</a>
<a name="411"></a>
<a name="412">            LEXER_INC(Lexer);</a>
<a name="413">        }</a>
<a name="414">        </a>
<a name="415">        <font color="green">if</font> (Lexer-&gtPos != <a href="lex_c.html#402">Lexer</a>-&gtEnd)</a>
<a name="416">            LEXER_INC(Lexer);</a>
<a name="417">        </a>
<a name="418">        <a href="lex_c.html#402">Lexer</a>-&gtMode = LexModeNormal;</a>
<a name="419">    }</a>
<a name="420">    <font color="green">else</font></a>
<a name="421">    {   </a>
<a name="422">        <font color="gray">/*<searched> C++ style comment */</font></a>
<a name="423">        <font color="green">while</font> (Lexer-&gtPos != <a href="lex_c.html#402">Lexer</a>-&gtEnd && *Lexer-&gtPos != '\n')</a>
<a name="424">            LEXER_INC(Lexer);</a>
<a name="425">    }</a>
<a name="426">}</a>
<a name="427"></a>
<a name="428"><font color="gray">/*<searched> get a single token from the source - used while scanning */</font></a>
<a name="429"><font color="red">enum</font> LexToken <a name="searched">LexScanGetToken</a>(Picoc *<a name="searched">pc</a>, <font color="brown">struct</font> LexState *<a name="searched">Lexer</a>, <font color="brown">struct</font> <a name="searched">Value</a> **<a name="searched">Value</a>)</a>
<a name="430">{</a>
<a name="431">    <font color="red">char</font> <a name="searched">ThisChar</a>;</a>
<a name="432">    <font color="red">char</font> <a name="searched">NextChar</a>;</a>
<a name="433">    <font color="red">enum</font> LexToken <a name="searched">GotToken</a> = TokenNone;</a>
<a name="434">    </a>
<a name="435">    <font color="gray">/*<searched> handle cases line multi-line comments or string constants which mess up the line count */</font></a>
<a name="436">    <font color="green">if</font> (Lexer-&gtEmitExtraNewlines &gt 0)</a>
<a name="437">    {</a>
<a name="438">        <a href="lex_c.html#429">Lexer</a>-&gtEmitExtraNewlines--;</a>
<a name="439">        <font color="green">return</font> TokenEndOfLine;</a>
<a name="440">    }</a>
<a name="441">    </a>
<a name="442">    <font color="gray">/*<searched> scan for a token */</font></a>
<a name="443">    do</a>
<a name="444">    {</a>
<a name="445">        *Value = &<a href="lex_c.html#429">pc</a>-&gtLexValue;</a>
<a name="446">        <font color="green">while</font> (Lexer-&gtPos != <a href="lex_c.html#429">Lexer</a>-&gtEnd && isspace((<font color="red">int</font>)*Lexer-&gtPos))</a>
<a name="447">        {</a>
<a name="448">            <font color="green">if</font> (*Lexer-&gtPos == '\n')</a>
<a name="449">            {</a>
<a name="450">                <a href="lex_c.html#429">Lexer</a>-&gtLine++;</a>
<a name="451">                <a href="lex_c.html#429">Lexer</a>-&gtPos++;</a>
<a name="452">                <a href="lex_c.html#429">Lexer</a>-&gtMode = LexModeNormal;</a>
<a name="453">                <a href="lex_c.html#429">Lexer</a>-&gtCharacterPos = 0;</a>
<a name="454">                <font color="green">return</font> TokenEndOfLine;</a>
<a name="455">            }</a>
<a name="456">            <font color="green">else</font> <font color="green">if</font> (Lexer-&gtMode == LexModeHashDefine || <a href="lex_c.html#429">Lexer</a>-&gtMode == LexModeHashDefineSpace)</a>
<a name="457">                <a href="lex_c.html#429">Lexer</a>-&gtMode = LexModeHashDefineSpace;</a>
<a name="458">            </a>
<a name="459">            <font color="green">else</font> <font color="green">if</font> (Lexer-&gtMode == LexModeHashDefineSpaceIdent)</a>
<a name="460">                <a href="lex_c.html#429">Lexer</a>-&gtMode = LexModeNormal;</a>
<a name="461">    </a>
<a name="462">            LEXER_INC(Lexer);</a>
<a name="463">        }</a>
<a name="464">        </a>
<a name="465">        <font color="green">if</font> (Lexer-&gtPos == <a href="lex_c.html#429">Lexer</a>-&gtEnd || *Lexer-&gtPos == '\0')</a>
<a name="466">            <font color="green">return</font> TokenEOF;</a>
<a name="467">        </a>
<a name="468">        <a href="lex_c.html#431">ThisChar</a> = *Lexer-&gtPos;</a>
<a name="469">        <font color="green">if</font> (isCidstart((<font color="red">int</font>)ThisChar))</a>
<a name="470">            <font color="green">return</font> <a href="lex_c.html#239">LexGetWord</a>(pc, <a href="lex_c.html#429">Lexer</a>, *Value);</a>
<a name="471">        </a>
<a name="472">        <font color="green">if</font> (isdigit((<font color="red">int</font>)ThisChar))</a>
<a name="473">            <font color="green">return</font> <a href="lex_c.html#130">LexGetNumber</a>(pc, <a href="lex_c.html#429">Lexer</a>, *Value);</a>
<a name="474">        </a>
<a name="475">        <a href="lex_c.html#432">NextChar</a> = (Lexer-&gtPos+1 != <a href="lex_c.html#429">Lexer</a>-&gtEnd) ? *(Lexer-&gtPos+1) : 0;</a>
<a name="476">        LEXER_INC(Lexer);</a>
<a name="477">        <font color="green">switch</font> (ThisChar)</a>
<a name="478">        {</a>
<a name="479">            <font color="green">case</font> '"': <a href="lex_c.html#433">GotToken</a> = <a href="lex_c.html#325">LexGetStringConstant</a>(pc, <a href="lex_c.html#429">Lexer</a>, *Value, '"'); break;</a>
<a name="480">            <font color="green">case</font> '\'': <a href="lex_c.html#433">GotToken</a> = <a href="lex_c.html#390">LexGetCharacterConstant</a>(pc, <a href="lex_c.html#429">Lexer</a>, *Value); break;</a>
<a name="481">            <font color="green">case</font> '(': <font color="green">if</font> (Lexer-&gtMode == LexModeHashDefineSpaceIdent) <a href="lex_c.html#433">GotToken</a> = TokenOpenMacroBracket; <font color="green">else</font> <a href="lex_c.html#433">GotToken</a> = TokenOpenBracket; <a href="lex_c.html#429">Lexer</a>-&gtMode = LexModeNormal; break;</a>
<a name="482">            <font color="green">case</font> ')': <a href="lex_c.html#433">GotToken</a> = TokenCloseBracket; break;</a>
<a name="483">            <font color="green">case</font> '=': NEXTIS('=', TokenEqual, TokenAssign); break;</a>
<a name="484">            <font color="green">case</font> '+': NEXTIS3('=', TokenAddAssign, '+', TokenIncrement, TokenPlus); break;</a>
<a name="485">            <font color="green">case</font> '-': NEXTIS4('=', TokenSubtractAssign, '&gt', TokenArrow, '-', TokenDecrement, TokenMinus); break;</a>
<a name="486">            <font color="green">case</font> '*': NEXTIS('=', TokenMultiplyAssign, TokenAsterisk); break;</a>
<a name="487">            <font color="green">case</font> '/': <font color="green">if</font> (NextChar == '/' || <a href="lex_c.html#432">NextChar</a> == '*') { LEXER_INC(Lexer); <a href="lex_c.html#402">LexSkipComment</a>(Lexer, <a href="lex_c.html#432">NextChar</a>, &<a href="lex_c.html#433">GotToken</a>); } <font color="green">else</font> NEXTIS('=', TokenDivideAssign, TokenSlash); break;</a>
<a name="488">            <font color="green">case</font> '%': NEXTIS('=', TokenModulusAssign, TokenModulus); break;</a>
<a name="489">            <font color="green">case</font> '&lt': <font color="green">if</font> (Lexer-&gtMode == LexModeHashInclude) <a href="lex_c.html#433">GotToken</a> = <a href="lex_c.html#325">LexGetStringConstant</a>(pc, <a href="lex_c.html#429">Lexer</a>, *Value, '&gt'); <font color="green">else</font> { NEXTIS3PLUS('=', TokenLessEqual, '&lt', TokenShiftLeft, '=', TokenShiftLeftAssign, TokenLessThan); } break; </a>
<a name="490">            <font color="green">case</font> '&gt': NEXTIS3PLUS('=', TokenGreaterEqual, '&gt', TokenShiftRight, '=', TokenShiftRightAssign, TokenGreaterThan); break;</a>
<a name="491">            <font color="green">case</font> ';': <a href="lex_c.html#433">GotToken</a> = TokenSemicolon; break;</a>
<a name="492">            <font color="green">case</font> '&': NEXTIS3('=', TokenArithmeticAndAssign, '&', TokenLogicalAnd, TokenAmpersand); break;</a>
<a name="493">            <font color="green">case</font> '|': NEXTIS3('=', TokenArithmeticOrAssign, '|', TokenLogicalOr, TokenArithmeticOr); break;</a>
<a name="494">            <font color="green">case</font> '{': <a href="lex_c.html#433">GotToken</a> = TokenLeftBrace; break;</a>
<a name="495">            <font color="green">case</font> '}': <a href="lex_c.html#433">GotToken</a> = TokenRightBrace; break;</a>
<a name="496">            <font color="green">case</font> '[': <a href="lex_c.html#433">GotToken</a> = TokenLeftSquareBracket; break;</a>
<a name="497">            <font color="green">case</font> ']': <a href="lex_c.html#433">GotToken</a> = TokenRightSquareBracket; break;</a>
<a name="498">            <font color="green">case</font> '!': NEXTIS('=', TokenNotEqual, TokenUnaryNot); break;</a>
<a name="499">            <font color="green">case</font> '^': NEXTIS('=', TokenArithmeticExorAssign, TokenArithmeticExor); break;</a>
<a name="500">            <font color="green">case</font> '~': <a href="lex_c.html#433">GotToken</a> = TokenUnaryExor; break;</a>
<a name="501">            <font color="green">case</font> ',': <a href="lex_c.html#433">GotToken</a> = TokenComma; break;</a>
<a name="502">            <font color="green">case</font> '.': NEXTISEXACTLY3('.', '.', TokenEllipsis, TokenDot); break;</a>
<a name="503">            <font color="green">case</font> '?': <a href="lex_c.html#433">GotToken</a> = TokenQuestionMark; break;</a>
<a name="504">            <font color="green">case</font> ':': <a href="lex_c.html#433">GotToken</a> = TokenColon; break;</a>
<a name="505">            default:  <a href="platform_c.html#179">LexFail</a>(pc, <a href="lex_c.html#429">Lexer</a>, "illegal character '%c'", <a href="lex_c.html#431">ThisChar</a>); break;</a>
<a name="506">        }</a>
<a name="507">    } <font color="green">while</font> (GotToken == TokenNone);</a>
<a name="508">    </a>
<a name="509">    <font color="green">return</font> <a href="lex_c.html#433">GotToken</a>;</a>
<a name="510">}</a>
<a name="511"></a>
<a name="512"><font color="gray">/*<searched> what size value goes with each token */</font></a>
<a name="513"><font color="red">int</font> Lex<a name="searched">Token</a>Size(<font color="red">enum</font> Lex<a name="searched">Token</a> <a name="searched">Token</a>)</a>
<a name="514">{</a>
<a name="515">    <font color="green">switch</font> (Token)</a>
<a name="516">    {</a>
<a name="517">        <font color="green">case</font> TokenIdentifier: <font color="green">case</font> TokenStringConstant: <font color="green">return</font> sizeof(<font color="red">char</font> *);</a>
<a name="518">        <font color="green">case</font> TokenIntegerConstant: <font color="green">return</font> sizeof(<font color="red">long</font>);</a>
<a name="519">        <font color="green">case</font> TokenCharacterConstant: <font color="green">return</font> sizeof(<font color="red">unsigned</font> <font color="red">char</font>);</a>
<a name="520">        <font color="green">case</font> TokenFPConstant: <font color="green">return</font> sizeof(<font color="red">double</font>);</a>
<a name="521">        default: <font color="green">return</font> 0;</a>
<a name="522">    }</a>
<a name="523">}</a>
<a name="524"></a>
<a name="525"><font color="gray">/*<searched> produce tokens from the lexer and return a heap buffer with the result - used for scanning */</font></a>
<a name="526"><font color="red">void</font> *<a name="searched">LexTokenise</a>(Picoc *<a name="searched">pc</a>, <font color="brown">struct</font> LexState *<a name="searched">Lexer</a>, <font color="red">int</font> *<a name="searched">TokenLen</a>)</a>
<a name="527">{</a>
<a name="528">    <font color="red">enum</font> Lex<a name="searched">Token</a> <a name="searched">Token</a>;</a>
<a name="529">    <font color="red">void</font> *<a name="searched">HeapMem</a>;</a>
<a name="530">    <font color="brown">struct</font> Value *<a name="searched">GotValue</a>;</a>
<a name="531">    <font color="red">int</font> <a name="searched">MemUsed</a> = 0;</a>
<a name="532">    <font color="red">int</font> <a name="searched">ValueSize</a>;</a>
<a name="533">    <font color="red">int</font> <a name="searched">ReserveSpace</a> = (Lexer-&gtEnd - <a href="lex_c.html#526">Lexer</a>-&gtPos) * 4 + 16; </a>
<a name="534">    <font color="red">void</font> *<a name="searched">TokenSpace</a> = <a href="heap_c.html#67">HeapAllocStack</a>(pc, <a href="lex_c.html#533">ReserveSpace</a>);</a>
<a name="535">    <font color="red">char</font> *<a name="searched">TokenPos</a> = (<font color="red">char</font> *)TokenSpace;</a>
<a name="536">    <font color="red">int</font> <a name="searched">LastCharacterPos</a> = 0;</a>
<a name="537"></a>
<a name="538">    <font color="green">if</font> (TokenSpace == NULL)</a>
<a name="539">        <a href="platform_c.html#179">LexFail</a>(pc, <a href="lex_c.html#526">Lexer</a>, "out of memory");</a>
<a name="540">    </a>
<a name="541">    do</a>
<a name="542">    { </a>
<a name="543">        <font color="gray">/*<searched> store the token at the end of the stack area */</font></a>
<a name="544">        <a href="lex_c.html#528">Token</a> = <a href="lex_c.html#429">LexScanGetToken</a>(pc, <a href="lex_c.html#526">Lexer</a>, &<a href="lex_c.html#530">GotValue</a>);</a>
<a name="545"></a>
<a name="546">#ifdef DEBUG_LEXER</a>
<a name="547">        printf("<a href="lex_c.html#528">Token</a>: %02x\n", <a href="lex_c.html#528">Token</a>);</a>
<a name="548">#endif</a>
<a name="549">        *(<font color="red">unsigned</font> <font color="red">char</font> *)TokenPos = <a href="lex_c.html#528">Token</a>;</a>
<a name="550">        <a href="lex_c.html#535">TokenPos</a>++;</a>
<a name="551">        <a href="lex_c.html#531">MemUsed</a>++;</a>
<a name="552"></a>
<a name="553">        *(<font color="red">unsigned</font> <font color="red">char</font> *)TokenPos = (<font color="red">unsigned</font> <font color="red">char</font>)LastCharacterPos;</a>
<a name="554">        <a href="lex_c.html#535">TokenPos</a>++;</a>
<a name="555">        <a href="lex_c.html#531">MemUsed</a>++;</a>
<a name="556"></a>
<a name="557">        <a href="lex_c.html#532">ValueSize</a> = <a href="lex_c.html#513">LexTokenSize</a>(Token);</a>
<a name="558">        <font color="green">if</font> (ValueSize &gt 0)</a>
<a name="559">        { </a>
<a name="560">            <font color="gray">/*<searched> store a value as well */</font></a>
<a name="561">            memcpy((<font color="red">void</font> *)TokenPos, (<font color="red">void</font> *)GotValue-&gtVal, <a href="lex_c.html#532">ValueSize</a>);</a>
<a name="562">            <a href="lex_c.html#535">TokenPos</a> += <a href="lex_c.html#532">ValueSize</a>;</a>
<a name="563">            <a href="lex_c.html#531">MemUsed</a> += <a href="lex_c.html#532">ValueSize</a>;</a>
<a name="564">        }</a>
<a name="565">    </a>
<a name="566">        <a href="lex_c.html#536">LastCharacterPos</a> = <a href="lex_c.html#526">Lexer</a>-&gtCharacterPos;</a>
<a name="567">                    </a>
<a name="568">    } <font color="green">while</font> (Token != TokenEOF);</a>
<a name="569">    </a>
<a name="570">    <a href="lex_c.html#529">HeapMem</a> = <a href="heap_c.html#135">HeapAllocMem</a>(pc, <a href="lex_c.html#531">MemUsed</a>);</a>
<a name="571">    <font color="green">if</font> (HeapMem == NULL)</a>
<a name="572">        <a href="platform_c.html#179">LexFail</a>(pc, <a href="lex_c.html#526">Lexer</a>, "out of memory");</a>
<a name="573">        </a>
<a name="574">    assert(ReserveSpace &gt= <a href="lex_c.html#531">MemUsed</a>);</a>
<a name="575">    memcpy(HeapMem, <a href="lex_c.html#534">TokenSpace</a>, <a href="lex_c.html#531">MemUsed</a>);</a>
<a name="576">    <a href="heap_c.html#92">HeapPopStack</a>(pc, <a href="lex_c.html#534">TokenSpace</a>, <a href="lex_c.html#533">ReserveSpace</a>);</a>
<a name="577">#ifdef DEBUG_LEXER</a>
<a name="578">    {</a>
<a name="579">        <font color="red">int</font> Count;</a>
<a name="580">        printf("Tokens: ");</a>
<a name="581">        <font color="green">for</font> (Count = 0; Count &lt <a href="lex_c.html#531">MemUsed</a>; Count++)</a>
<a name="582">            printf("%02x ", *((<font color="red">unsigned</font> <font color="red">char</font> *)HeapMem+Count));</a>
<a name="583">        printf("\n");</a>
<a name="584">    }</a>
<a name="585">#endif</a>
<a name="586">    <font color="green">if</font> (TokenLen)</a>
<a name="587">        *TokenLen = <a href="lex_c.html#531">MemUsed</a>;</a>
<a name="588">    </a>
<a name="589">    <font color="green">return</font> <a href="lex_c.html#529">HeapMem</a>;</a>
<a name="590">}</a>
<a name="591"></a>
<a name="592"><font color="gray">/*<searched> lexically analyse some source text */</font></a>
<a name="593"><font color="red">void</font> *<a name="searched">LexAnalyse</a>(Picoc *<a name="searched">pc</a>, const <font color="red">char</font> *<a name="searched">FileName</a>, const <font color="red">char</font> *Source, <font color="red">int</font> <a name="searched">SourceLen</a>, <font color="red">int</font> *<a name="searched">TokenLen</a>)</a>
<a name="594">{</a>
<a name="595">    <font color="brown">struct</font> LexState <a name="searched">Lexer</a>;</a>
<a name="596">    </a>
<a name="597">    <a href="lex_c.html#595">Lexer</a>.Pos = <a href="lex_c.html#593">Source</a>;</a>
<a name="598">    <a href="lex_c.html#595">Lexer</a>.End = Source + <a href="lex_c.html#593">SourceLen</a>;</a>
<a name="599">    <a href="lex_c.html#595">Lexer</a>.Line = 1;</a>
<a name="600">    <a href="lex_c.html#595">Lexer</a>.FileName = <a href="lex_c.html#593">FileName</a>;</a>
<a name="601">    <a href="lex_c.html#595">Lexer</a>.Mode = LexModeNormal;</a>
<a name="602">    <a href="lex_c.html#595">Lexer</a>.EmitExtraNewlines = 0;</a>
<a name="603">    <a href="lex_c.html#595">Lexer</a>.CharacterPos = 1;</a>
<a name="604">    <a href="lex_c.html#595">Lexer</a>.SourceText = <a href="lex_c.html#593">Source</a>;</a>
<a name="605">    </a>
<a name="606">    <font color="green">return</font> <a href="lex_c.html#526">LexTokenise</a>(pc, &<a href="lex_c.html#595">Lexer</a>, <a href="lex_c.html#593">TokenLen</a>);</a>
<a name="607">}</a>
<a name="608"></a>
<a name="609"><font color="gray">/*<searched> prepare to parse a pre-tokenised buffer */</font></a>
<a name="610"><font color="red">void</font> LexInit<a name="searched">Parser</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>, Picoc *<a name="searched">pc</a>, const <font color="red">char</font> *<a name="searched">SourceText</a>, <font color="red">void</font> *<a name="searched">TokenSource</a>, <font color="red">char</font> *<a name="searched">FileName</a>, <font color="red">int</font> <a name="searched">RunIt</a>, <font color="red">int</font> <a name="searched">EnableDebugger</a>)</a>
<a name="611">{</a>
<a name="612">    <a href="lex_c.html#610">Parser</a>-&gtpc = <a href="lex_c.html#610">pc</a>;</a>
<a name="613">    <a href="lex_c.html#610">Parser</a>-&gtPos = <a href="lex_c.html#610">TokenSource</a>;</a>
<a name="614">    <a href="lex_c.html#610">Parser</a>-&gtLine = 1;</a>
<a name="615">    <a href="lex_c.html#610">Parser</a>-&gtFileName = <a href="lex_c.html#610">FileName</a>;</a>
<a name="616">    <a href="lex_c.html#610">Parser</a>-&gtMode = <a href="lex_c.html#610">RunIt</a> ? RunModeRun : RunModeSkip;</a>
<a name="617">    <a href="lex_c.html#610">Parser</a>-&gtSearchLabel = 0;</a>
<a name="618">    <a href="lex_c.html#610">Parser</a>-&gtHashIfLevel = 0;</a>
<a name="619">    <a href="lex_c.html#610">Parser</a>-&gtHashIfEvaluateToLevel = 0;</a>
<a name="620">    <a href="lex_c.html#610">Parser</a>-&gtCharacterPos = 0;</a>
<a name="621">    <a href="lex_c.html#610">Parser</a>-&gtSourceText = <a href="lex_c.html#610">SourceText</a>;</a>
<a name="622">    <a href="lex_c.html#610">Parser</a>-&gtDebugMode = <a href="lex_c.html#610">EnableDebugger</a>;</a>
<a name="623">}</a>
<a name="624"></a>
<a name="625"><font color="gray">/*<searched> get the next token, without pre-processing */</font></a>
<a name="626"><font color="red">enum</font> LexToken <a name="searched">LexGetRawToken</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>, <font color="brown">struct</font> <a name="searched">Value</a> **<a name="searched">Value</a>, <font color="red">int</font> <a name="searched">IncPos</a>)</a>
<a name="627">{</a>
<a name="628">    <font color="red">enum</font> Lex<a name="searched">Token</a> <a name="searched">Token</a> = <a name="searched">Token</a>None;</a>
<a name="629">    <font color="red">int</font> <a name="searched">ValueSize</a>;</a>
<a name="630">    <font color="red">char</font> *<a name="searched">Prompt</a> = NULL;</a>
<a name="631">    Picoc *<a name="searched">pc</a> = <a href="lex_c.html#626">Parser</a>-&gt<a name="searched">pc</a>;</a>
<a name="632">    </a>
<a name="633">    do</a>
<a name="634">    { </a>
<a name="635">        <font color="gray">/*<searched> get the next token */</font></a>
<a name="636">        <font color="green">if</font> (Parser-&gtPos == NULL && <a href="lex_c.html#631">pc</a>-&gtInteractiveHead != NULL)</a>
<a name="637">            <a href="lex_c.html#626">Parser</a>-&gtPos = <a href="lex_c.html#631">pc</a>-&gtInteractiveHead-&gtTokens;</a>
<a name="638">        </a>
<a name="639">        <font color="green">if</font> (Parser-&gtFileName != <a href="lex_c.html#631">pc</a>-&gtStrEmpty || <a href="lex_c.html#631">pc</a>-&gtInteractiveHead != NULL)</a>
<a name="640">        { </a>
<a name="641">            <font color="gray">/*<searched> skip leading newlines */</font></a>
<a name="642">            <font color="green">while</font> ((Token = (<font color="red">enum</font> LexToken)*(<font color="red">unsigned</font> <font color="red">char</font> *)Parser-&gtPos) == TokenEndOfLine)</a>
<a name="643">            {</a>
<a name="644">                <a href="lex_c.html#626">Parser</a>-&gtLine++;</a>
<a name="645">                <a href="lex_c.html#626">Parser</a>-&gtPos += TOKEN_DATA_OFFSET;</a>
<a name="646">            }</a>
<a name="647">        }</a>
<a name="648">    </a>
<a name="649">        <font color="green">if</font> (Parser-&gtFileName == <a href="lex_c.html#631">pc</a>-&gtStrEmpty && (pc-&gtInteractiveHead == NULL || <a href="lex_c.html#628">Token</a> == TokenEOF))</a>
<a name="650">        { </a>
<a name="651">            <font color="gray">/*<searched> we're at the end of an interactive input token list */</font></a>
<a name="652">            <font color="red">char</font> <a name="searched">LineBuffer</a>[LINEBUFFER_MAX];</a>
<a name="653">            <font color="red">void</font> *<a name="searched">LineTokens</a>;</a>
<a name="654">            <font color="red">int</font> <a name="searched">LineBytes</a>;</a>
<a name="655">            <font color="brown">struct</font> TokenLine *<a name="searched">LineNode</a>;</a>
<a name="656">            </a>
<a name="657">            <font color="green">if</font> (pc-&gtInteractiveHead == NULL || (<font color="red">unsigned</font> <font color="red">char</font> *)Parser-&gtPos == &<a href="lex_c.html#631">pc</a>-&gtInteractiveTail-&gtTokens[<a href="lex_c.html#631">pc</a>-&gtInteractiveTail-&gtNumBytes-TOKEN_DATA_OFFSET])</a>
<a name="658">            { </a>
<a name="659">                <font color="gray">/*<searched> get interactive input */</font></a>
<a name="660">                <font color="green">if</font> (pc-&gtLexUseStatementPrompt)</a>
<a name="661">                {</a>
<a name="662">                    <a href="lex_c.html#630">Prompt</a> = INTERACTIVE_PROMPT_STATEMENT;</a>
<a name="663">                    <a href="lex_c.html#631">pc</a>-&gtLexUseStatementPrompt = FALSE;</a>
<a name="664">                }</a>
<a name="665">                <font color="green">else</font></a>
<a name="666">                    <a href="lex_c.html#630">Prompt</a> = INTERACTIVE_PROMPT_LINE;</a>
<a name="667">                    </a>
<a name="668">                <font color="green">if</font> (PlatformGetLine(&<a href="lex_c.html#652">LineBuffer</a>[0], LINEBUFFER_MAX, <a href="lex_c.html#630">Prompt</a>) == NULL)</a>
<a name="669">                    <font color="green">return</font> TokenEOF;</a>
<a name="670"></a>
<a name="671">                <font color="gray">/*<searched> put the new line at the end of the linked list of interactive lines */</font>        </a>
<a name="672">                <a href="lex_c.html#653">LineTokens</a> = <a href="lex_c.html#593">LexAnalyse</a>(pc, <a href="lex_c.html#631">pc</a>-&gtStrEmpty, &<a href="lex_c.html#652">LineBuffer</a>[0], strlen(LineBuffer), &<a href="lex_c.html#654">LineBytes</a>);</a>
<a name="673">                <a href="lex_c.html#655">LineNode</a> = <a href="variable_c.html#68">VariableAlloc</a>(pc, <a href="lex_c.html#626">Parser</a>, sizeof(<font color="brown">struct</font> TokenLine), TRUE);</a>
<a name="674">                <a href="lex_c.html#655">LineNode</a>-&gtTokens = <a href="lex_c.html#653">LineTokens</a>;</a>
<a name="675">                <a href="lex_c.html#655">LineNode</a>-&gtNumBytes = <a href="lex_c.html#654">LineBytes</a>;</a>
<a name="676">                <font color="green">if</font> (pc-&gtInteractiveHead == NULL)</a>
<a name="677">                { </a>
<a name="678">                    <font color="gray">/*<searched> start a new list */</font></a>
<a name="679">                    <a href="lex_c.html#631">pc</a>-&gtInteractiveHead = <a href="lex_c.html#655">LineNode</a>;</a>
<a name="680">                    <a href="lex_c.html#626">Parser</a>-&gtLine = 1;</a>
<a name="681">                    <a href="lex_c.html#626">Parser</a>-&gtCharacterPos = 0;</a>
<a name="682">                }</a>
<a name="683">                <font color="green">else</font></a>
<a name="684">                    <a href="lex_c.html#631">pc</a>-&gtInteractiveTail-&gtNext = <a href="lex_c.html#655">LineNode</a>;</a>
<a name="685"></a>
<a name="686">                <a href="lex_c.html#631">pc</a>-&gtInteractiveTail = <a href="lex_c.html#655">LineNode</a>;</a>
<a name="687">                <a href="lex_c.html#631">pc</a>-&gtInteractiveCurrentLine = <a href="lex_c.html#655">LineNode</a>;</a>
<a name="688">                <a href="lex_c.html#626">Parser</a>-&gtPos = <a href="lex_c.html#653">LineTokens</a>;</a>
<a name="689">            }</a>
<a name="690">            <font color="green">else</font></a>
<a name="691">            { </a>
<a name="692">                <font color="gray">/*<searched> go to the next token line */</font></a>
<a name="693">                <font color="green">if</font> (Parser-&gtPos != &<a href="lex_c.html#631">pc</a>-&gtInteractiveCurrentLine-&gtTokens[<a href="lex_c.html#631">pc</a>-&gtInteractiveCurrentLine-&gtNumBytes-TOKEN_DATA_OFFSET])</a>
<a name="694">                { </a>
<a name="695">                    <font color="gray">/*<searched> scan for the line */</font></a>
<a name="696">                    <font color="green">for</font> (pc-&gtInteractiveCurrentLine = <a href="lex_c.html#631">pc</a>-&gtInteractiveHead; <a href="lex_c.html#626">Parser</a>-&gtPos != &<a href="lex_c.html#631">pc</a>-&gtInteractiveCurrentLine-&gtTokens[<a href="lex_c.html#631">pc</a>-&gtInteractiveCurrentLine-&gtNumBytes-TOKEN_DATA_OFFSET]; <a href="lex_c.html#631">pc</a>-&gtInteractiveCurrentLine = <a href="lex_c.html#631">pc</a>-&gtInteractiveCurrentLine-&gtNext)</a>
<a name="697">                    { assert(pc-&gtInteractiveCurrentLine-&gtNext != NULL); }</a>
<a name="698">                }</a>
<a name="699"></a>
<a name="700">                assert(pc-&gtInteractiveCurrentLine != NULL);</a>
<a name="701">                <a href="lex_c.html#631">pc</a>-&gtInteractiveCurrentLine = <a href="lex_c.html#631">pc</a>-&gtInteractiveCurrentLine-&gtNext;</a>
<a name="702">                assert(pc-&gtInteractiveCurrentLine != NULL);</a>
<a name="703">                <a href="lex_c.html#626">Parser</a>-&gtPos = <a href="lex_c.html#631">pc</a>-&gtInteractiveCurrentLine-&gtTokens;</a>
<a name="704">            }</a>
<a name="705"></a>
<a name="706">            <a href="lex_c.html#628">Token</a> = (<font color="red">enum</font> LexToken)*(<font color="red">unsigned</font> <font color="red">char</font> *)Parser-&gtPos;</a>
<a name="707">        }</a>
<a name="708">    } <font color="green">while</font> ((Parser-&gtFileName == <a href="lex_c.html#631">pc</a>-&gtStrEmpty && <a href="lex_c.html#628">Token</a> == TokenEOF) || <a href="lex_c.html#628">Token</a> == TokenEndOfLine);</a>
<a name="709"></a>
<a name="710">    <a href="lex_c.html#626">Parser</a>-&gtCharacterPos = *((<font color="red">unsigned</font> <font color="red">char</font> *)Parser-&gtPos + 1);</a>
<a name="711">    <a href="lex_c.html#629">ValueSize</a> = <a href="lex_c.html#513">LexTokenSize</a>(Token);</a>
<a name="712">    <font color="green">if</font> (ValueSize &gt 0)</a>
<a name="713">    { </a>
<a name="714">        <font color="gray">/*<searched> this token requires a value - unpack it */</font></a>
<a name="715">        <font color="green">if</font> (Value != NULL)</a>
<a name="716">        { </a>
<a name="717">            <font color="green">switch</font> (Token)</a>
<a name="718">            {</a>
<a name="719">                <font color="green">case</font> TokenStringConstant:       <a href="lex_c.html#631">pc</a>-&gtLexValue.Typ = <a href="lex_c.html#631">pc</a>-&gtCharPtrType; break;</a>
<a name="720">                <font color="green">case</font> TokenIdentifier:           <a href="lex_c.html#631">pc</a>-&gtLexValue.Typ = NULL; break;</a>
<a name="721">                <font color="green">case</font> TokenIntegerConstant:      <a href="lex_c.html#631">pc</a>-&gtLexValue.Typ = &<a href="lex_c.html#631">pc</a>-&gtLongType; break;</a>
<a name="722">                <font color="green">case</font> TokenCharacterConstant:    <a href="lex_c.html#631">pc</a>-&gtLexValue.Typ = &<a href="lex_c.html#631">pc</a>-&gtCharType; break;</a>
<a name="723">#ifndef NO_FP</a>
<a name="724">                <font color="green">case</font> TokenFPConstant:           <a href="lex_c.html#631">pc</a>-&gtLexValue.Typ = &<a href="lex_c.html#631">pc</a>-&gtFPType; break;</a>
<a name="725">#endif</a>
<a name="726">                default: break;</a>
<a name="727">            }</a>
<a name="728">            </a>
<a name="729">            memcpy((<font color="red">void</font> *)pc-&gtLexValue.Val, (<font color="red">void</font> *)((<font color="red">char</font> *)Parser-&gtPos + TOKEN_DATA_OFFSET), <a href="lex_c.html#629">ValueSize</a>);</a>
<a name="730">            <a href="lex_c.html#631">pc</a>-&gtLexValue.ValOnHeap = FALSE;</a>
<a name="731">            <a href="lex_c.html#631">pc</a>-&gtLexValue.ValOnStack = FALSE;</a>
<a name="732">            <a href="lex_c.html#631">pc</a>-&gtLexValue.IsLValue = FALSE;</a>
<a name="733">            <a href="lex_c.html#631">pc</a>-&gtLexValue.LValueFrom = NULL;</a>
<a name="734">            *Value = &<a href="lex_c.html#631">pc</a>-&gtLexValue;</a>
<a name="735">        }</a>
<a name="736">        </a>
<a name="737">        <font color="green">if</font> (IncPos)</a>
<a name="738">            <a href="lex_c.html#626">Parser</a>-&gtPos += <a href="lex_c.html#629">ValueSize</a> + TOKEN_DATA_OFFSET;</a>
<a name="739">    }</a>
<a name="740">    <font color="green">else</font></a>
<a name="741">    {</a>
<a name="742">        <font color="green">if</font> (IncPos && <a href="lex_c.html#628">Token</a> != TokenEOF)</a>
<a name="743">            <a href="lex_c.html#626">Parser</a>-&gtPos += TOKEN_DATA_OFFSET;</a>
<a name="744">    }</a>
<a name="745">    </a>
<a name="746">#ifdef DEBUG_LEXER</a>
<a name="747">    printf("Got token=%02x inc=%d pos=%d\n", <a href="lex_c.html#628">Token</a>, <a href="lex_c.html#626">IncPos</a>, <a href="lex_c.html#626">Parser</a>-&gtCharacterPos);</a>
<a name="748">#endif</a>
<a name="749">    assert(Token &gt= TokenNone && <a href="lex_c.html#628">Token</a> &lt= TokenEndOfFunction);</a>
<a name="750">    <font color="green">return</font> <a href="lex_c.html#628">Token</a>;</a>
<a name="751">}</a>
<a name="752"></a>
<a name="753"><font color="gray">/*<searched> correct the token position depending if we already incremented the position */</font></a>
<a name="754"><font color="red">void</font> LexHash<a name="searched">IncPos</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>, <font color="red">int</font> <a name="searched">IncPos</a>)</a>
<a name="755">{</a>
<a name="756">    <font color="green">if</font> (!<a href="lex_c.html#754">IncPos</a>)</a>
<a name="757">        <a href="lex_c.html#626">LexGetRawToken</a>(Parser, NULL, TRUE);</a>
<a name="758">}</a>
<a name="759"></a>
<a name="760"><font color="gray">/*<searched> handle a #ifdef directive */</font></a>
<a name="761"><font color="red">void</font> <a name="searched">LexHashIfdef</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>, <font color="red">int</font> <a name="searched">IfNot</a>)</a>
<a name="762">{</a>
<a name="763">    <font color="gray">/*<searched> get symbol to check */</font></a>
<a name="764">    <font color="brown">struct</font> Value *<a name="searched">IdentValue</a>;</a>
<a name="765">    <font color="brown">struct</font> Value *<a name="searched">SavedValue</a>;</a>
<a name="766">    <font color="red">int</font> <a name="searched">IsDefined</a>;</a>
<a name="767">    <font color="red">enum</font> Lex<a name="searched">Token</a> <a name="searched">Token</a> = LexGetRaw<a name="searched">Token</a>(Parser, &<a href="lex_c.html#764">IdentValue</a>, TRUE);</a>
<a name="768">    </a>
<a name="769">    <font color="green">if</font> (Token != TokenIdentifier)</a>
<a name="770">        <a href="platform_c.html#134">ProgramFail</a>(Parser, "identifier expected");</a>
<a name="771">    </a>
<a name="772">    <font color="gray">/*<searched> is the identifier defined? */</font></a>
<a name="773">    <a href="lex_c.html#766">IsDefined</a> = <a href="table_c.html#81">TableGet</a>(&<a href="lex_c.html#761">Parser</a>-&gtpc-&gtGlobalTable, <a href="lex_c.html#764">IdentValue</a>-&gtVal-&gtIdentifier, &<a href="lex_c.html#765">SavedValue</a>, NULL, NULL, NULL);</a>
<a name="774">    <font color="green">if</font> (Parser-&gtHashIfEvaluateToLevel == <a href="lex_c.html#761">Parser</a>-&gtHashIfLevel && ( (IsDefined && !<a href="lex_c.html#761">IfNot</a>) || (!<a href="lex_c.html#766">IsDefined</a> && <a href="lex_c.html#761">IfNot</a>)) )</a>
<a name="775">    {</a>
<a name="776">        <font color="gray">/*<searched> #if is active, evaluate to this new level */</font></a>
<a name="777">        <a href="lex_c.html#761">Parser</a>-&gtHashIfEvaluateToLevel++;</a>
<a name="778">    }</a>
<a name="779">    </a>
<a name="780">    <a href="lex_c.html#761">Parser</a>-&gtHashIfLevel++;</a>
<a name="781">}</a>
<a name="782"></a>
<a name="783"><font color="gray">/*<searched> handle a #if directive */</font></a>
<a name="784"><font color="red">void</font> <a name="searched">LexHashIf</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>)</a>
<a name="785">{</a>
<a name="786">    <font color="gray">/*<searched> get symbol to check */</font></a>
<a name="787">    <font color="brown">struct</font> Value *<a name="searched">IdentValue</a>;</a>
<a name="788">    <font color="brown">struct</font> Value *<a name="searched">SavedValue</a> = NULL;</a>
<a name="789">    <font color="brown">struct</font> ParseState <a name="searched">MacroParser</a>;</a>
<a name="790">    <font color="red">enum</font> Lex<a name="searched">Token</a> <a name="searched">Token</a> = LexGetRaw<a name="searched">Token</a>(Parser, &<a href="lex_c.html#787">IdentValue</a>, TRUE);</a>
<a name="791"></a>
<a name="792">    <font color="green">if</font> (Token == TokenIdentifier)</a>
<a name="793">    {</a>
<a name="794">        <font color="gray">/*<searched> look up a value from a macro definition */</font></a>
<a name="795">        <font color="green">if</font> (!<a href="table_c.html#81">TableGet</a>(&<a href="lex_c.html#784">Parser</a>-&gtpc-&gtGlobalTable, <a href="lex_c.html#787">IdentValue</a>-&gtVal-&gtIdentifier, &<a href="lex_c.html#788">SavedValue</a>, NULL, NULL, NULL))</a>
<a name="796">            <a href="platform_c.html#134">ProgramFail</a>(Parser, "'%s' is undefined", <a href="lex_c.html#787">IdentValue</a>-&gtVal-&gtIdentifier);</a>
<a name="797">        </a>
<a name="798">        <font color="green">if</font> (SavedValue-&gtTyp-&gtBase != TypeMacro)</a>
<a name="799">            <a href="platform_c.html#134">ProgramFail</a>(Parser, "value expected");</a>
<a name="800">        </a>
<a name="801">        <a href="parse_c.html#429">ParserCopy</a>(&<a href="lex_c.html#789">MacroParser</a>, &<a href="lex_c.html#788">SavedValue</a>-&gtVal-&gtMacroDef.Body);</a>
<a name="802">        <a href="lex_c.html#790">Token</a> = <a href="lex_c.html#626">LexGetRawToken</a>(&<a href="lex_c.html#789">MacroParser</a>, &<a href="lex_c.html#787">IdentValue</a>, TRUE);</a>
<a name="803">    }</a>
<a name="804">    </a>
<a name="805">    <font color="green">if</font> (Token != TokenCharacterConstant && <a href="lex_c.html#790">Token</a> != TokenIntegerConstant)</a>
<a name="806">        <a href="platform_c.html#134">ProgramFail</a>(Parser, "value expected");</a>
<a name="807">    </a>
<a name="808">    <font color="gray">/*<searched> is the identifier defined? */</font></a>
<a name="809">    <font color="green">if</font> (Parser-&gtHashIfEvaluateToLevel == <a href="lex_c.html#784">Parser</a>-&gtHashIfLevel && <a href="lex_c.html#787">IdentValue</a>-&gtVal-&gtCharacter)</a>
<a name="810">    {</a>
<a name="811">        <font color="gray">/*<searched> #if is active, evaluate to this new level */</font></a>
<a name="812">        <a href="lex_c.html#784">Parser</a>-&gtHashIfEvaluateToLevel++;</a>
<a name="813">    }</a>
<a name="814">    </a>
<a name="815">    <a href="lex_c.html#784">Parser</a>-&gtHashIfLevel++;</a>
<a name="816">}</a>
<a name="817"></a>
<a name="818"><font color="gray">/*<searched> handle a #else directive */</font></a>
<a name="819"><font color="red">void</font> <a name="searched">LexHashElse</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>)</a>
<a name="820">{</a>
<a name="821">    <font color="green">if</font> (Parser-&gtHashIfEvaluateToLevel == <a href="lex_c.html#819">Parser</a>-&gtHashIfLevel - 1)</a>
<a name="822">        <a href="lex_c.html#819">Parser</a>-&gtHashIfEvaluateToLevel++;     <font color="gray">/*<searched> #if was not active, make this next section active */</font></a>
<a name="823">        </a>
<a name="824">    <font color="green">else</font> <font color="green">if</font> (Parser-&gtHashIfEvaluateToLevel == <a href="lex_c.html#819">Parser</a>-&gtHashIfLevel)</a>
<a name="825">    {</a>
<a name="826">        <font color="gray">/*<searched> #if was active, now go inactive */</font></a>
<a name="827">        <font color="green">if</font> (Parser-&gtHashIfLevel == 0)</a>
<a name="828">            <a href="platform_c.html#134">ProgramFail</a>(Parser, "#<font color="green">else</font> without #if");</a>
<a name="829">            </a>
<a name="830">        <a href="lex_c.html#819">Parser</a>-&gtHashIfEvaluateToLevel--;</a>
<a name="831">    }</a>
<a name="832">}</a>
<a name="833"></a>
<a name="834"><font color="gray">/*<searched> handle a #endif directive */</font></a>
<a name="835"><font color="red">void</font> <a name="searched">LexHashEndif</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>)</a>
<a name="836">{</a>
<a name="837">    <font color="green">if</font> (Parser-&gtHashIfLevel == 0)</a>
<a name="838">        <a href="platform_c.html#134">ProgramFail</a>(Parser, "#endif without #if");</a>
<a name="839"></a>
<a name="840">    <a href="lex_c.html#835">Parser</a>-&gtHashIfLevel--;</a>
<a name="841">    <font color="green">if</font> (Parser-&gtHashIfEvaluateToLevel &gt <a href="lex_c.html#835">Parser</a>-&gtHashIfLevel)</a>
<a name="842">        <a href="lex_c.html#835">Parser</a>-&gtHashIfEvaluateToLevel = <a href="lex_c.html#835">Parser</a>-&gtHashIfLevel;</a>
<a name="843">}</a>
<a name="844"></a>
<a name="845">#if 0 <font color="gray">/*<searched> useful for debug */</font></a>
<a name="846"><font color="red">void</font> LexPrintToken(<font color="red">enum</font> LexToken Token)</a>
<a name="847">{</a>
<a name="848">    <font color="red">char</font>* TokenNames[] = {</a>
<a name="849">        <font color="gray">/*<searched> 0x00 */</font> "None", </a>
<a name="850">        <font color="gray">/*<searched> 0x01 */</font> "Comma",</a>
<a name="851">        <font color="gray">/*<searched> 0x02 */</font> "Assign", "AddAssign", "SubtractAssign", "MultiplyAssign", "DivideAssign", "ModulusAssign",</a>
<a name="852">        <font color="gray">/*<searched> 0x08 */</font> "ShiftLeftAssign", "ShiftRightAssign", "ArithmeticAndAssign", "ArithmeticOrAssign", "ArithmeticExorAssign",</a>
<a name="853">        <font color="gray">/*<searched> 0x0d */</font> "QuestionMark", "Colon", </a>
<a name="854">        <font color="gray">/*<searched> 0x0f */</font> "LogicalOr", </a>
<a name="855">        <font color="gray">/*<searched> 0x10 */</font> "LogicalAnd", </a>
<a name="856">        <font color="gray">/*<searched> 0x11 */</font> "ArithmeticOr", </a>
<a name="857">        <font color="gray">/*<searched> 0x12 */</font> "ArithmeticExor", </a>
<a name="858">        <font color="gray">/*<searched> 0x13 */</font> "Ampersand", </a>
<a name="859">        <font color="gray">/*<searched> 0x14 */</font> "Equal", "NotEqual", </a>
<a name="860">        <font color="gray">/*<searched> 0x16 */</font> "LessThan", "GreaterThan", "LessEqual", "GreaterEqual",</a>
<a name="861">        <font color="gray">/*<searched> 0x1a */</font> "ShiftLeft", "ShiftRight", </a>
<a name="862">        <font color="gray">/*<searched> 0x1c */</font> "Plus", "Minus", </a>
<a name="863">        <font color="gray">/*<searched> 0x1e */</font> "Asterisk", "Slash", "Modulus",</a>
<a name="864">        <font color="gray">/*<searched> 0x21 */</font> "Increment", "Decrement", "UnaryNot", "UnaryExor", "Sizeof", "Cast",</a>
<a name="865">        <font color="gray">/*<searched> 0x27 */</font> "LeftSquareBracket", "RightSquareBracket", "Dot", "Arrow", </a>
<a name="866">        <font color="gray">/*<searched> 0x2b */</font> "OpenBracket", "CloseBracket",</a>
<a name="867">        <font color="gray">/*<searched> 0x2d */</font> "Identifier", "IntegerConstant", "FPConstant", "StringConstant", "CharacterConstant",</a>
<a name="868">        <font color="gray">/*<searched> 0x32 */</font> "Semicolon", "Ellipsis",</a>
<a name="869">        <font color="gray">/*<searched> 0x34 */</font> "LeftBrace", "RightBrace",</a>
<a name="870">        <font color="gray">/*<searched> 0x36 */</font> "IntType", "CharType", "FloatType", "DoubleType", "VoidType", "EnumType",</a>
<a name="871">        <font color="gray">/*<searched> 0x3c */</font> "LongType", "SignedType", "ShortType", "StaticType", "AutoType", "RegisterType", "ExternType", "StructType", "UnionType", "UnsignedType", "Typedef",</a>
<a name="872">        <font color="gray">/*<searched> 0x46 */</font> "Continue", "Do", "Else", "For", "Goto", "If", "While", "Break", "Switch", "Case", "Default", "Return",</a>
<a name="873">        <font color="gray">/*<searched> 0x52 */</font> "HashDefine", "HashInclude", "HashIf", "HashIfdef", "HashIfndef", "HashElse", "HashEndif",</a>
<a name="874">        <font color="gray">/*<searched> 0x59 */</font> "New", "Delete",</a>
<a name="875">        <font color="gray">/*<searched> 0x5b */</font> "OpenMacroBracket",</a>
<a name="876">        <font color="gray">/*<searched> 0x5c */</font> "EOF", "EndOfLine", "EndOfFunction"</a>
<a name="877">    };</a>
<a name="878">    printf("{%s}", TokenNames[Token]);</a>
<a name="879">}</a>
<a name="880">#endif</a>
<a name="881"></a>
<a name="882"><font color="gray">/*<searched> get the next token given a parser state, pre-processing as we go */</font></a>
<a name="883"><font color="red">enum</font> LexToken <a name="searched">LexGetToken</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>, <font color="brown">struct</font> <a name="searched">Value</a> **<a name="searched">Value</a>, <font color="red">int</font> <a name="searched">IncPos</a>)</a>
<a name="884">{</a>
<a name="885">    <font color="red">enum</font> Lex<a name="searched">Token</a> <a name="searched">Token</a>;</a>
<a name="886">    <font color="red">int</font> <a name="searched">TryNextToken</a>;</a>
<a name="887">    </a>
<a name="888">    <font color="gray">/*<searched> implements the pre-processor #if commands */</font></a>
<a name="889">    do</a>
<a name="890">    {</a>
<a name="891">        <font color="red">int</font> <a name="searched">WasPreProcToken</a> = TRUE;</a>
<a name="892"></a>
<a name="893">        <a href="lex_c.html#885">Token</a> = <a href="lex_c.html#626">LexGetRawToken</a>(Parser, <a href="lex_c.html#883">Value</a>, <a href="lex_c.html#883">IncPos</a>);</a>
<a name="894">        <font color="green">switch</font> (Token)</a>
<a name="895">        {</a>
<a name="896">            <font color="green">case</font> TokenHashIfdef:    <a href="lex_c.html#754">LexHashIncPos</a>(Parser, <a href="lex_c.html#883">IncPos</a>); <a href="lex_c.html#761">LexHashIfdef</a>(Parser, FALSE); break;</a>
<a name="897">            <font color="green">case</font> TokenHashIfndef:   <a href="lex_c.html#754">LexHashIncPos</a>(Parser, <a href="lex_c.html#883">IncPos</a>); <a href="lex_c.html#761">LexHashIfdef</a>(Parser, TRUE); break;</a>
<a name="898">            <font color="green">case</font> TokenHashIf:       <a href="lex_c.html#754">LexHashIncPos</a>(Parser, <a href="lex_c.html#883">IncPos</a>); <a href="lex_c.html#784">LexHashIf</a>(Parser); break;</a>
<a name="899">            <font color="green">case</font> TokenHashElse:     <a href="lex_c.html#754">LexHashIncPos</a>(Parser, <a href="lex_c.html#883">IncPos</a>); <a href="lex_c.html#819">LexHashElse</a>(Parser); break;</a>
<a name="900">            <font color="green">case</font> TokenHashEndif:    <a href="lex_c.html#754">LexHashIncPos</a>(Parser, <a href="lex_c.html#883">IncPos</a>); <a href="lex_c.html#835">LexHashEndif</a>(Parser); break;</a>
<a name="901">            default:                <a href="lex_c.html#891">WasPreProcToken</a> = FALSE; break;</a>
<a name="902">        }</a>
<a name="903"></a>
<a name="904">        <font color="gray">/*<searched> if we're going to reject this token, increment the token pointer to the next one */</font></a>
<a name="905">        <a href="lex_c.html#886">TryNextToken</a> = (Parser-&gtHashIfEvaluateToLevel &lt <a href="lex_c.html#883">Parser</a>-&gtHashIfLevel && <a href="lex_c.html#885">Token</a> != TokenEOF) || <a href="lex_c.html#891">WasPreProcToken</a>;</a>
<a name="906">        <font color="green">if</font> (!<a href="lex_c.html#883">IncPos</a> && <a href="lex_c.html#886">TryNextToken</a>)</a>
<a name="907">            <a href="lex_c.html#626">LexGetRawToken</a>(Parser, NULL, TRUE);</a>
<a name="908">            </a>
<a name="909">    } <font color="green">while</font> (TryNextToken);</a>
<a name="910">    </a>
<a name="911">    <font color="green">return</font> <a href="lex_c.html#885">Token</a>;</a>
<a name="912">}</a>
<a name="913"></a>
<a name="914"><font color="gray">/*<searched> take a quick peek at the next token, skipping any pre-processing */</font></a>
<a name="915"><font color="red">enum</font> LexToken <a name="searched">LexRawPeekToken</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>)</a>
<a name="916">{</a>
<a name="917">    <font color="green">return</font> (<font color="red">enum</font> LexToken)*(<font color="red">unsigned</font> <font color="red">char</font> *)Parser-&gtPos;</a>
<a name="918">}</a>
<a name="919"></a>
<a name="920"><font color="gray">/*<searched> find the end of the line */</font></a>
<a name="921"><font color="red">void</font> <a name="searched">LexToEndOfLine</a>(<font color="brown">struct</font> ParseState *<a name="searched">Parser</a>)</a>
<a name="922">{</a>
<a name="923">    <font color="green">while</font> (TRUE)</a>
<a name="924">    {</a>
<a name="925">        <font color="red">enum</font> Lex<a name="searched">Token</a> <a name="searched">Token</a> = (<font color="red">enum</font> Lex<a name="searched">Token</a>)*(<font color="red">unsigned</font> <font color="red">char</font> *)Parser-&gtPos;</a>
<a name="926">        <font color="green">if</font> (Token == TokenEndOfLine || <a href="lex_c.html#925">Token</a> == TokenEOF)</a>
<a name="927">            <font color="green">return</font>;</a>
<a name="928">        <font color="green">else</font></a>
<a name="929">            <a href="lex_c.html#626">LexGetRawToken</a>(Parser, NULL, TRUE);</a>
<a name="930">    }</a>
<a name="931">}</a>
<a name="932"></a>
<a name="933"><font color="gray">/*<searched> copy the tokens from StartParser to EndParser into new memory, removing TokenEOFs and terminate with a TokenEndOfFunction */</font></a>
<a name="934"><font color="red">void</font> *<a name="searched">LexCopyTokens</a>(<font color="brown">struct</font> ParseState *<a name="searched">StartParser</a>, <font color="brown">struct</font> ParseState *<a name="searched">EndParser</a>)</a>
<a name="935">{</a>
<a name="936">    <font color="red">int</font> <a name="searched">MemSize</a> = 0;</a>
<a name="937">    <font color="red">int</font> <a name="searched">CopySize</a>;</a>
<a name="938">    <font color="red">unsigned</font> <font color="red">char</font> *<a name="searched">Pos</a> = (<font color="red">unsigned</font> <font color="red">char</font> *)StartParser-&gt<a name="searched">Pos</a>;</a>
<a name="939">    <font color="red">unsigned</font> <font color="red">char</font> *<a name="searched">NewTokens</a>;</a>
<a name="940">    <font color="red">unsigned</font> <font color="red">char</font> *<a name="searched">NewTokenPos</a>;</a>
<a name="941">    <font color="brown">struct</font> TokenLine *<a name="searched">ILine</a>;</a>
<a name="942">    Picoc *<a name="searched">pc</a> = <a href="lex_c.html#934">StartParser</a>-&gt<a name="searched">pc</a>;</a>
<a name="943">    </a>
<a name="944">    <font color="green">if</font> (pc-&gtInteractiveHead == NULL)</a>
<a name="945">    { </a>
<a name="946">        <font color="gray">/*<searched> non-interactive mode - copy the tokens */</font></a>
<a name="947">        <a href="lex_c.html#936">MemSize</a> = <a href="lex_c.html#934">EndParser</a>-&gtPos - <a href="lex_c.html#934">StartParser</a>-&gtPos;</a>
<a name="948">        <a href="lex_c.html#939">NewTokens</a> = <a href="variable_c.html#68">VariableAlloc</a>(pc, <a href="lex_c.html#934">StartParser</a>, <a href="lex_c.html#936">MemSize</a> + TOKEN_DATA_OFFSET, TRUE);</a>
<a name="949">        memcpy(NewTokens, (<font color="red">void</font> *)StartParser-&gtPos, <a href="lex_c.html#936">MemSize</a>);</a>
<a name="950">    }</a>
<a name="951">    <font color="green">else</font></a>
<a name="952">    { </a>
<a name="953">        <font color="gray">/*<searched> we're in interactive mode - add up line by line */</font></a>
<a name="954">        <font color="green">for</font> (pc-&gtInteractiveCurrentLine = <a href="lex_c.html#942">pc</a>-&gtInteractiveHead; <a href="lex_c.html#942">pc</a>-&gtInteractiveCurrentLine != NULL && (Pos &lt &<a href="lex_c.html#942">pc</a>-&gtInteractiveCurrentLine-&gtTokens[0] || <a href="lex_c.html#938">Pos</a> &gt= &<a href="lex_c.html#942">pc</a>-&gtInteractiveCurrentLine-&gtTokens[<a href="lex_c.html#942">pc</a>-&gtInteractiveCurrentLine-&gtNumBytes]); <a href="lex_c.html#942">pc</a>-&gtInteractiveCurrentLine = <a href="lex_c.html#942">pc</a>-&gtInteractiveCurrentLine-&gtNext)</a>
<a name="955">        {} <font color="gray">/*<searched> find the line we just counted */</font></a>
<a name="956">        </a>
<a name="957">        <font color="green">if</font> (EndParser-&gtPos &gt= <a href="lex_c.html#934">StartParser</a>-&gtPos && <a href="lex_c.html#934">EndParser</a>-&gtPos &lt &<a href="lex_c.html#942">pc</a>-&gtInteractiveCurrentLine-&gtTokens[<a href="lex_c.html#942">pc</a>-&gtInteractiveCurrentLine-&gtNumBytes])</a>
<a name="958">        { </a>
<a name="959">            <font color="gray">/*<searched> all on a single line */</font></a>
<a name="960">            <a href="lex_c.html#936">MemSize</a> = <a href="lex_c.html#934">EndParser</a>-&gtPos - <a href="lex_c.html#934">StartParser</a>-&gtPos;</a>
<a name="961">            <a href="lex_c.html#939">NewTokens</a> = <a href="variable_c.html#68">VariableAlloc</a>(pc, <a href="lex_c.html#934">StartParser</a>, <a href="lex_c.html#936">MemSize</a> + TOKEN_DATA_OFFSET, TRUE);</a>
<a name="962">            memcpy(NewTokens, (<font color="red">void</font> *)StartParser-&gtPos, <a href="lex_c.html#936">MemSize</a>);</a>
<a name="963">        }</a>
<a name="964">        <font color="green">else</font></a>
<a name="965">        { </a>
<a name="966">            <font color="gray">/*<searched> it's spread across multiple lines */</font></a>
<a name="967">            <a href="lex_c.html#936">MemSize</a> = &<a href="lex_c.html#942">pc</a>-&gtInteractiveCurrentLine-&gtTokens[<a href="lex_c.html#942">pc</a>-&gtInteractiveCurrentLine-&gtNumBytes-TOKEN_DATA_OFFSET] - <a href="lex_c.html#938">Pos</a>;</a>
<a name="968"></a>
<a name="969">            <font color="green">for</font> (ILine = <a href="lex_c.html#942">pc</a>-&gtInteractiveCurrentLine-&gtNext; <a href="lex_c.html#941">ILine</a> != NULL && (EndParser-&gtPos &lt &<a href="lex_c.html#941">ILine</a>-&gtTokens[0] || <a href="lex_c.html#934">EndParser</a>-&gtPos &gt= &<a href="lex_c.html#941">ILine</a>-&gtTokens[<a href="lex_c.html#941">ILine</a>-&gtNumBytes]); <a href="lex_c.html#941">ILine</a> = <a href="lex_c.html#941">ILine</a>-&gtNext)</a>
<a name="970">                <a href="lex_c.html#936">MemSize</a> += <a href="lex_c.html#941">ILine</a>-&gtNumBytes - TOKEN_DATA_OFFSET;</a>
<a name="971">            </a>
<a name="972">            assert(ILine != NULL);</a>
<a name="973">            <a href="lex_c.html#936">MemSize</a> += <a href="lex_c.html#934">EndParser</a>-&gtPos - &<a href="lex_c.html#941">ILine</a>-&gtTokens[0];</a>
<a name="974">            <a href="lex_c.html#939">NewTokens</a> = <a href="variable_c.html#68">VariableAlloc</a>(pc, <a href="lex_c.html#934">StartParser</a>, <a href="lex_c.html#936">MemSize</a> + TOKEN_DATA_OFFSET, TRUE);</a>
<a name="975">            </a>
<a name="976">            <a href="lex_c.html#937">CopySize</a> = &<a href="lex_c.html#942">pc</a>-&gtInteractiveCurrentLine-&gtTokens[<a href="lex_c.html#942">pc</a>-&gtInteractiveCurrentLine-&gtNumBytes-TOKEN_DATA_OFFSET] - <a href="lex_c.html#938">Pos</a>;</a>
<a name="977">            memcpy(NewTokens, <a href="lex_c.html#938">Pos</a>, <a href="lex_c.html#937">CopySize</a>);</a>
<a name="978">            <a href="lex_c.html#940">NewTokenPos</a> = <a href="lex_c.html#939">NewTokens</a> + <a href="lex_c.html#937">CopySize</a>;</a>
<a name="979">            <font color="green">for</font> (ILine = <a href="lex_c.html#942">pc</a>-&gtInteractiveCurrentLine-&gtNext; <a href="lex_c.html#941">ILine</a> != NULL && (EndParser-&gtPos &lt &<a href="lex_c.html#941">ILine</a>-&gtTokens[0] || <a href="lex_c.html#934">EndParser</a>-&gtPos &gt= &<a href="lex_c.html#941">ILine</a>-&gtTokens[<a href="lex_c.html#941">ILine</a>-&gtNumBytes]); <a href="lex_c.html#941">ILine</a> = <a href="lex_c.html#941">ILine</a>-&gtNext)</a>
<a name="980">            {</a>
<a name="981">                memcpy(NewTokenPos, &<a href="lex_c.html#941">ILine</a>-&gtTokens[0], <a href="lex_c.html#941">ILine</a>-&gtNumBytes - TOKEN_DATA_OFFSET);</a>
<a name="982">                <a href="lex_c.html#940">NewTokenPos</a> += <a href="lex_c.html#941">ILine</a>-&gtNumBytes-TOKEN_DATA_OFFSET;</a>
<a name="983">            }</a>
<a name="984">            assert(ILine != NULL);</a>
<a name="985">            memcpy(NewTokenPos, &<a href="lex_c.html#941">ILine</a>-&gtTokens[0], <a href="lex_c.html#934">EndParser</a>-&gtPos - &<a href="lex_c.html#941">ILine</a>-&gtTokens[0]);</a>
<a name="986">        }</a>
<a name="987">    }</a>
<a name="988">    </a>
<a name="989">    <a href="lex_c.html#939">NewTokens</a>[<a href="lex_c.html#936">MemSize</a>] = (<font color="red">unsigned</font> <font color="red">char</font>)TokenEndOfFunction;</a>
<a name="990">        </a>
<a name="991">    <font color="green">return</font> <a href="lex_c.html#939">NewTokens</a>;</a>
<a name="992">}</a>
<a name="993"></a>
<a name="994"><font color="gray">/*<searched> indicate that we've completed up to this point in the interactive input and free expired tokens */</font></a>
<a name="995"><font color="red">void</font> <a name="searched">LexInteractiveClear</a>(Picoc *<a name="searched">pc</a>, <font color="brown">struct</font> ParseState *<a name="searched">Parser</a>)</a>
<a name="996">{</a>
<a name="997">    <font color="green">while</font> (pc-&gtInteractiveHead != NULL)</a>
<a name="998">    {</a>
<a name="999">        <font color="brown">struct</font> TokenLine *<a name="searched">NextLine</a> = <a href="lex_c.html#995">pc</a>-&gtInteractiveHead-&gtNext;</a>
<a name="1000">        </a>
<a name="1001">        <a href="heap_c.html#226">HeapFreeMem</a>(pc, <a href="lex_c.html#995">pc</a>-&gtInteractiveHead-&gtTokens);</a>
<a name="1002">        <a href="heap_c.html#226">HeapFreeMem</a>(pc, <a href="lex_c.html#995">pc</a>-&gtInteractiveHead);</a>
<a name="1003">        <a href="lex_c.html#995">pc</a>-&gtInteractiveHead = <a href="lex_c.html#999">NextLine</a>;</a>
<a name="1004">    }</a>
<a name="1005"></a>
<a name="1006">    <font color="green">if</font> (Parser != NULL)</a>
<a name="1007">        <a href="lex_c.html#995">Parser</a>-&gtPos = NULL;</a>
<a name="1008">        </a>
<a name="1009">    <a href="lex_c.html#995">pc</a>-&gtInteractiveTail = NULL;</a>
<a name="1010">}</a>
<a name="1011"></a>
<a name="1012"><font color="gray">/*<searched> indicate that we've completed up to this point in the interactive input and free expired tokens */</font></a>
<a name="1013"><font color="red">void</font> <a name="searched">LexInteractiveCompleted</a>(Picoc *<a name="searched">pc</a>, <font color="brown">struct</font> ParseState *<a name="searched">Parser</a>)</a>
<a name="1014">{</a>
<a name="1015">    <font color="green">while</font> (pc-&gtInteractiveHead != NULL && !(Parser-&gtPos &gt= &<a href="lex_c.html#1013">pc</a>-&gtInteractiveHead-&gtTokens[0] && <a href="lex_c.html#1013">Parser</a>-&gtPos &lt &<a href="lex_c.html#1013">pc</a>-&gtInteractiveHead-&gtTokens[<a href="lex_c.html#1013">pc</a>-&gtInteractiveHead-&gtNumBytes]))</a>
<a name="1016">    { </a>
<a name="1017">        <font color="gray">/*<searched> this token line is no longer needed - free it */</font></a>
<a name="1018">        <font color="brown">struct</font> TokenLine *<a name="searched">NextLine</a> = <a href="lex_c.html#1013">pc</a>-&gtInteractiveHead-&gtNext;</a>
<a name="1019">        </a>
<a name="1020">        <a href="heap_c.html#226">HeapFreeMem</a>(pc, <a href="lex_c.html#1013">pc</a>-&gtInteractiveHead-&gtTokens);</a>
<a name="1021">        <a href="heap_c.html#226">HeapFreeMem</a>(pc, <a href="lex_c.html#1013">pc</a>-&gtInteractiveHead);</a>
<a name="1022">        <a href="lex_c.html#1013">pc</a>-&gtInteractiveHead = <a href="lex_c.html#1018">NextLine</a>;</a>
<a name="1023">        </a>
<a name="1024">        <font color="green">if</font> (pc-&gtInteractiveHead == NULL)</a>
<a name="1025">        { </a>
<a name="1026">            <font color="gray">/*<searched> we've emptied the list */</font></a>
<a name="1027">            <a href="lex_c.html#1013">Parser</a>-&gtPos = NULL;</a>
<a name="1028">            <a href="lex_c.html#1013">pc</a>-&gtInteractiveTail = NULL;</a>
<a name="1029">        }</a>
<a name="1030">    }</a>
<a name="1031">}</a>
<a name="1032"></a>
<a name="1033"><font color="gray">/*<searched> the next time we prompt, make it the full statement prompt */</font></a>
<a name="1034"><font color="red">void</font> <a name="searched">LexInteractiveStatementPrompt</a>(Picoc *<a name="searched">pc</a>)</a>
<a name="1035">{</a>
<a name="1036">    <a href="lex_c.html#1034">pc</a>-&gtLexUseStatementPrompt = TRUE;</a>
<a name="1037">}</a>
</pre></body></html>